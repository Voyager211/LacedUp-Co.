<style>
/* ========= PRODUCT MANAGEMENT SPECIFIC STYLES ========= */
.product-management-container {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
}

.page-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  color: white;
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.page-subtitle {
  color: rgba(255, 255, 255, 0.85);
  margin: 0.5rem 0 0 0;
}

.add-product-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  color: white;
  background-color: #ef4444;
  text-decoration: none;
}

.add-product-btn:hover {
  background-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  color: white;
}

/* Filters Card */
.filters-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.filters-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filters-grid {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  gap: 1rem;
  align-items: start;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.form-select, .form-control {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  transition: all 0.2s ease;
  background-color: white;
}

.form-control:focus, .form-select:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

/* Search Input with Icon Button */
.search-input-container {
  position: relative;
  display: flex;
}

.search-input-container .form-control {
  flex: 1;
  padding-right: 45px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.search-input-container .clear-btn {
  position: absolute;
  right: 45px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6c757d;
  font-size: 0.9rem;
  padding: 0.25rem;
  cursor: pointer;
  z-index: 3;
  transition: color 0.2s ease;
}

.search-input-container .clear-btn:hover {
  color: #e03a2f;
}

.search-input-container .search-btn {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  border-left: none;
  background-color: white;
  border: 1px solid #e5e7eb;
  color: #333;
  padding: 0.6rem 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.search-input-container .search-btn:hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
}

/* Brand Filter Dropdown */
.brand-filter-dropdown {
  position: relative;
}

.brand-dropdown-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 0.6rem 1rem;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
}

.brand-dropdown-btn:hover {
  border-color: #3b82f6;
}

.brand-dropdown-btn:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.brand-dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #3b82f6;
  border-top: none;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
  display: none;
}

.brand-dropdown-menu.show {
  display: block;
}

.brand-option {
  display: flex;
  align-items: center;
  padding: 0.6rem 1rem;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: all 0.2s ease;
}

.brand-option:hover {
  background-color: rgba(59, 130, 246, 0.05);
}

.brand-option:last-child {
  border-bottom: none;
}

.brand-option input[type="checkbox"] {
  margin-right: 8px;
  accent-color: #3b82f6;
}

.brand-option label {
  cursor: pointer;
  margin: 0;
  font-weight: 500;
  color: #333;
}

/* Advanced Filters Toggle */
.advanced-filters-toggle {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

.toggle-advanced-btn {
  background: none;
  border: none;
  color: #3b82f6;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.toggle-advanced-btn:hover {
  background-color: rgba(59, 130, 246, 0.1);
}

.advanced-filters {
  display: none;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #e5e7eb;
}

.advanced-filters.show {
  display: block;
}

.advanced-filters-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
}

/* Filter Actions */
.filter-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-top: 1rem;
}

.btn-reset-filters, .btn-apply-filters {
  padding: 0.6rem 1.25rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-reset-filters {
  background-color: #6b7280;
  color: white;
}

.btn-reset-filters:hover {
  background-color: #4b5563;
}

.btn-apply-filters {
  background-color: #ef4444;
  color: white;
}

.btn-apply-filters:hover {
  background-color: #dc2626;
  transform: scale(1.02);
}

/* Modern Table Wrapper */
.table-wrapper {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  overflow-x: auto;
}

.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem;
}

.modern-table thead th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.5px;
  padding: 1.25rem 1rem;
  border-bottom: 2px solid #e9ecef;
  text-align: left;
}

.modern-table tbody td {
  padding: 1.5rem 1rem;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.modern-table tbody tr {
  transition: all 0.2s ease;
}

.modern-table tbody tr:nth-child(even) {
  background-color: #f9fafb;
}

.modern-table tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.product-image {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 6px;
}

/* Action Buttons */
.btn-edit {
  background-color: #3b82f6;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  border: none;
  font-size: 0.875rem;
  font-weight: 600;
  transition: all 0.2s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.btn-edit:hover {
  background-color: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  color: white;
}

.btn-delete {
  background-color: #ef4444;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  border: none;
  font-size: 0.875rem;
  font-weight: 600;
  transition: all 0.2s ease;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.btn-delete:hover {
  background-color: #dc2626;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Toggle Switch */
.form-check-input {
  cursor: pointer;
  width: 3rem;
  height: 1.5rem;
}

.form-check-input:checked {
  background-color: #10b981;
  border-color: #10b981;
}

/* Responsive */
@media (max-width: 1200px) {
  .filters-grid {
    grid-template-columns: 2fr 1fr;
  }
  
  .advanced-filters-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .add-product-btn {
    width: 100%;
    justify-content: center;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }
  
  .advanced-filters-grid {
    grid-template-columns: 1fr;
  }
}

/* Loading Animation */
.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ========= PAGINATION STYLES ========= */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 2rem;
  margin-bottom: 2rem;
}

.pagination {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  list-style: none;
  margin: 0;
  padding: 0;
}

.page-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  padding: 8px 12px;
  border: 1px solid #dee2e6;
  background-color: white;
  color: #333;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
  font-size: 0.9rem;
}

.page-btn:not(:disabled):not(.active):hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(224, 58, 47, 0.2);
}

.page-btn.active {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  font-weight: 600;
}

.page-btn.active:hover {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  transform: none;
  box-shadow: none;
}

.page-btn:disabled {
  color: #6c757d;
  background-color: #f8f9fa;
  border-color: #dee2e6;
  cursor: not-allowed;
  opacity: 0.6;
}

.page-btn:disabled:hover {
  background-color: #f8f9fa;
  border-color: #dee2e6;
  color: #6c757d;
  transform: none;
  box-shadow: none;
}

.page-btn i {
  font-size: 0.9em;
}

@media (max-width: 576px) {
  .page-btn {
    min-width: 35px;
    height: 35px;
    padding: 6px 8px;
    font-size: 0.8rem;
  }

  .page-btn i {
    font-size: 0.8em;
  }

  .pagination {
    gap: 0.25rem;
  }
}
</style>

<div class="product-management-container">
  <!-- Breadcrumbs -->
  <%- include('./partials/breadcrumbs', {
    breadcrumbs: [
      { label: 'Dashboard', url: '/admin/dashboard', icon: 'house-door' },
      { label: 'Products', icon: 'box-seam' }
    ]
  }) %>

  <!-- Page Header --> 
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          Product Management (<span id="product-count"><%= typeof totalRecords !== 'undefined' ? totalRecords : products.length %></span>)
        </h1>
        <p class="page-subtitle">Manage your product inventory</p>
      </div>
      <div class="header-right">
        <a href="/admin/products/add" class="add-product-btn">
          <i class="bi bi-plus-circle"></i>
          <span>Add Product</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <h3 class="filters-title">
      <i class="bi bi-funnel"></i>
      Filter & Sort Options
    </h3>
    
    <!-- Basic Filters -->
    <div class="filters-grid">
      <!-- Search Group -->
      <div class="filter-group">
        <label class="filter-label">Search Products</label>
        <div class="search-input-container">
          <input 
            type="text" 
            class="form-control"
            id="search-input"
            placeholder="Search by product name"
            value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          >
          <button type="button" id="clear-search" class="clear-btn <%= typeof searchQuery === 'undefined' || !searchQuery ? 'd-none' : '' %>">
            <i class="bi bi-x-lg"></i>
          </button>
          <button class="search-btn" type="button" id="search-btn">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Category Filter -->
      <div class="filter-group">
        <label class="filter-label">Category</label>
        <select id="filter-category" class="form-select">
          <option value="">All Categories</option>
          <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
      </div>

      <!-- Brand Filter -->
      <div class="filter-group">
        <label class="filter-label">Brand</label>
        <div class="brand-filter-dropdown">
          <button type="button" class="brand-dropdown-btn" id="brand-dropdown-btn">
            <span class="selected-text">All Brands</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="brand-dropdown-menu" id="brand-dropdown-menu">
            <div class="brand-option">
              <input type="checkbox" id="brand-all" class="brand-checkbox" value="" checked>
              <label for="brand-all">All Brands</label>
            </div>
            <% brands.forEach((brand, index) => { %>
            <div class="brand-option">
              <input type="checkbox" id="brand-<%= index %>" class="brand-checkbox" value="<%= brand._id %>">
              <label for="brand-<%= index %>"><%= brand.name %></label>
            </div>
            <% }) %>
          </div>
        </div>
      </div>

      <!-- Sort Options -->
      <div class="filter-group">
        <label class="filter-label">Sort By</label>
        <select id="sort-select" class="form-select">
          <option value="">Default (Newest)</option>
          <option value="name-asc">Name: A - Z</option>
          <option value="name-desc">Name: Z - A</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="date-newest">Date: Newest First</option>
          <option value="date-oldest">Date: Oldest First</option>
          <option value="status">Status: Active First</option>
        </select>
      </div>
    </div>

    <!-- Advanced Filters Toggle -->
    <div class="advanced-filters-toggle">
      <button type="button" class="toggle-advanced-btn" id="toggle-advanced-btn">
        <i class="bi bi-chevron-down"></i>
        <span>Advanced Filters</span>
      </button>
    </div>

    <!-- Advanced Filters -->
    <div class="advanced-filters" id="advanced-filters">
      <div class="advanced-filters-grid">
        <!-- Min Price -->
        <div class="filter-group">
          <label class="filter-label">Min Price</label>
          <input type="number" id="filter-min-price" class="form-control" placeholder="Min price">
        </div>

        <!-- Max Price -->
        <div class="filter-group">
          <label class="filter-label">Max Price</label>
          <input type="number" id="filter-max-price" class="form-control" placeholder="Max price">
        </div>

        <!-- Status Filter -->
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select id="filter-status" class="form-select">
            <option value="">All Status</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>

        <!-- Stock Filter -->
        <div class="filter-group">
          <label class="filter-label">Stock Level</label>
          <select id="filter-stock" class="form-select">
            <option value="">All Stock</option>
            <option value="in-stock">In Stock</option>
            <option value="low-stock">Low Stock (< 10)</option>
            <option value="out-of-stock">Out of Stock</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Filter Actions -->
    <div class="filter-actions">
      <button type="button" class="btn-reset-filters" id="reset-filters">
        <i class="bi bi-arrow-counterclockwise"></i>
        Reset
      </button>
      <button type="button" class="btn-apply-filters" id="apply-filters">
        <i class="bi bi-check-circle"></i>
        Apply Filters
      </button>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-wrapper">
    <table class="modern-table">
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th>Product</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Image</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="product-table-body">
        <% if (products && products.length > 0) { %>
          <% products.forEach((product, index) => { %>
            <tr>
              <td><%= index + 1 + ((currentPage - 1) * 10) %></td>
              <td><%= product.productName %></td>
              <td><%= product.brand?.name || '—' %></td>
              <td><%= product.category?.name || '—' %></td>
              <td>
                <img src="<%= product.mainImage %>" alt="product" class="product-image" />
              </td>
              <td>₹<%= product.regularPrice || 0 %></td>
              <td><%= product.totalStock || 0 %></td>
              <td>
                <div class="form-check form-switch d-flex justify-content-center">
                  <input 
                    class="form-check-input toggle-status" 
                    type="checkbox" 
                    data-id="<%= product._id %>" 
                    <%= product.isListed ? 'checked' : '' %>
                  >
                </div>
              </td>
              <td><%= product.createdAt.toISOString().split('T')[0] %></td>
              <td>
                <a href="/admin/products/<%= product._id %>/edit" class="btn-edit me-1">
                  <i class="bi bi-pencil-square"></i> Edit
                </a>
                <button class="btn-delete" data-id="<%= product._id %>">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr>
            <td colspan="10" class="text-center py-5">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #e5e7eb;"></i>
              <p class="mt-2 text-muted">No products found</p>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-wrapper">
    <div class="pagination">
      <!-- Previous Button -->
      <% if (currentPage > 1) { %>
        <button class="page-btn pagination-btn" data-page="<%= currentPage - 1 %>">
          <i class="bi bi-chevron-left"></i>
        </button>
      <% } else { %>
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-left"></i>
        </button>
      <% } %>

      <!-- Page Numbers -->
      <%
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
        if (endPage - startPage + 1 < maxPagesToShow) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        
        const pageNumbers = [];
        for (let i = startPage; i <= endPage; i++) {
          pageNumbers.push(i);
        }
      %>
      
      <% pageNumbers.forEach(pageNum => { %>
        <% if (pageNum === currentPage) { %>
          <button class="page-btn active"><%= pageNum %></button>
        <% } else { %>
          <button class="page-btn pagination-btn" data-page="<%= pageNum %>">
            <%= pageNum %>
          </button>
        <% } %>
      <% }) %>

      <!-- Next Button -->
      <% if (currentPage < totalPages) { %>
        <button class="page-btn pagination-btn" data-page="<%= currentPage + 1 %>">
          <i class="bi bi-chevron-right"></i>
        </button>
      <% } else { %>
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-right"></i>
        </button>
      <% } %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('search-input');
  const clearSearchBtn = document.getElementById('clear-search');
  const searchBtn = document.getElementById('search-btn');
  const tableBody = document.getElementById('product-table-body');
  
  const filterCategory = document.getElementById('filter-category');
  const filterMinPrice = document.getElementById('filter-min-price');
  const filterMaxPrice = document.getElementById('filter-max-price');
  const filterStatus = document.getElementById('filter-status');
  const filterStock = document.getElementById('filter-stock');
  const sortSelect = document.getElementById('sort-select');
  
  const toggleAdvancedBtn = document.getElementById('toggle-advanced-btn');
  const advancedFilters = document.getElementById('advanced-filters');
  const resetFiltersBtn = document.getElementById('reset-filters');
  const applyFiltersBtn = document.getElementById('apply-filters');

  let currentPage = <%= currentPage || 1 %>;
  let currentFilters = {
    q: '',
    category: '',
    brand: '',
    minPrice: '',
    maxPrice: '',
    status: '',
    stock: '',
    sort: ''
  };

  // Toggle clear button
  function toggleClearButton() {
    if (searchInput.value.trim()) {
      clearSearchBtn.classList.remove('d-none');
    } else {
      clearSearchBtn.classList.add('d-none');
    }
  }

  // Toggle advanced filters
  toggleAdvancedBtn.addEventListener('click', () => {
    advancedFilters.classList.toggle('show');
    const icon = toggleAdvancedBtn.querySelector('i');
    if (advancedFilters.classList.contains('show')) {
      icon.classList.remove('bi-chevron-down');
      icon.classList.add('bi-chevron-up');
    } else {
      icon.classList.remove('bi-chevron-up');
      icon.classList.add('bi-chevron-down');
    }
  });

  // Brand dropdown functionality
  const brandDropdownBtn = document.getElementById('brand-dropdown-btn');
  const brandDropdownMenu = document.getElementById('brand-dropdown-menu');
  const brandCheckboxes = document.querySelectorAll('.brand-checkbox');
  const brandAllCheckbox = document.getElementById('brand-all');

  brandDropdownBtn.addEventListener('click', (e) => {
    e.preventDefault();
    brandDropdownMenu.classList.toggle('show');
  });

  document.addEventListener('click', (e) => {
    if (!brandDropdownBtn.contains(e.target) && !brandDropdownMenu.contains(e.target)) {
      brandDropdownMenu.classList.remove('show');
    }
  });

  brandCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (this.value === '') {
        if (this.checked) {
          brandCheckboxes.forEach(cb => {
            if (cb.value !== '') cb.checked = false;
          });
        }
      } else {
        if (this.checked) {
          brandAllCheckbox.checked = false;
        } else {
          const anyBrandSelected = Array.from(brandCheckboxes).some(cb => cb.value !== '' && cb.checked);
          if (!anyBrandSelected) {
            brandAllCheckbox.checked = true;
          }
        }
      }
      updateBrandDropdownText();
    });
  });

  function updateBrandDropdownText() {
    const selectedBrands = Array.from(brandCheckboxes)
      .filter(cb => cb.value !== '' && cb.checked)
      .map(cb => cb.nextElementSibling.textContent);

    const selectedText = brandDropdownBtn.querySelector('.selected-text');
    
    if (selectedBrands.length === 0 || brandAllCheckbox.checked) {
      selectedText.textContent = 'All Brands';
    } else if (selectedBrands.length === 1) {
      selectedText.textContent = selectedBrands[0];
    } else {
      selectedText.textContent = `${selectedBrands.length} Brands Selected`;
    }
  }

  function getSelectedBrands() {
    if (brandAllCheckbox.checked) return '';
    return Array.from(brandCheckboxes)
      .filter(cb => cb.value !== '' && cb.checked)
      .map(cb => cb.value)
      .join(',');
  }

  // Update pagination UI
  function updatePagination(paginationData) {
    const paginationWrapper = document.querySelector('.pagination-wrapper');
    if (!paginationWrapper) return;
    
    paginationWrapper.style.display = 'flex';
    
    const page = paginationData?.currentPage || 1;
    const totalPages = paginationData?.totalPages || 1;
    
    const pageNumbers = [];
    const maxPagesToShow = 5;
    let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
    
    if (endPage - startPage + 1 < maxPagesToShow) {
      startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      pageNumbers.push(i);
    }
    
    let paginationHTML = '<div class="pagination">';
    
    if (page > 1) {
      paginationHTML += `
        <button class="page-btn pagination-btn" data-page="${page - 1}">
          <i class="bi bi-chevron-left"></i>
        </button>
      `;
    } else {
      paginationHTML += `
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-left"></i>
        </button>
      `;
    }
    
    pageNumbers.forEach(pageNum => {
      if (pageNum === page) {
        paginationHTML += `<button class="page-btn active">${pageNum}</button>`;
      } else {
        paginationHTML += `
          <button class="page-btn pagination-btn" data-page="${pageNum}">
            ${pageNum}
          </button>
        `;
      }
    });
    
    if (page < totalPages) {
      paginationHTML += `
        <button class="page-btn pagination-btn" data-page="${page + 1}">
          <i class="bi bi-chevron-right"></i>
        </button>
      `;
    } else {
      paginationHTML += `
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-right"></i>
        </button>
      `;
    }
    
    paginationHTML += '</div>';
    paginationWrapper.innerHTML = paginationHTML;
  }

  // Fetch and render products
  async function fetchAndRenderProducts(page = 1) {
    try {
      const params = new URLSearchParams();
      
      if (currentFilters.q) params.append('q', currentFilters.q);
      if (currentFilters.category) params.append('category', currentFilters.category);
      if (currentFilters.brand) params.append('brand', currentFilters.brand);
      if (currentFilters.minPrice) params.append('minPrice', currentFilters.minPrice);
      if (currentFilters.maxPrice) params.append('maxPrice', currentFilters.maxPrice);
      if (currentFilters.status) params.append('status', currentFilters.status);
      if (currentFilters.stock) params.append('stock', currentFilters.stock);
      if (currentFilters.sort) params.append('sort', currentFilters.sort);
      params.append('page', page);

      const response = await fetch(`/admin/products/api?${params.toString()}`);
      const data = await response.json();

      if (data.totalRecords !== undefined) {
        document.getElementById('product-count').textContent = data.totalRecords;
      }

      if (data.products && data.products.length > 0) {
        const startIndex = (page - 1) * 10;
        const rows = data.products.map((product, index) => `
          <tr>
            <td>${startIndex + index + 1}</td>
            <td>${product.productName}</td>
            <td>${product.brand?.name || '—'}</td>
            <td>${product.category?.name || '—'}</td>
            <td><img src="${product.mainImage}" alt="product" class="product-image" /></td>
            <td>₹${product.regularPrice || 0}</td>
            <td>${product.totalStock || 0}</td>
            <td>
              <div class="form-check form-switch d-flex justify-content-center">
                <input class="form-check-input toggle-status" type="checkbox" data-id="${product._id}" ${product.isListed ? 'checked' : ''}>
              </div>
            </td>
            <td>${new Date(product.createdAt).toISOString().split('T')[0]}</td>
            <td>
              <a href="/admin/products/${product._id}/edit" class="btn-edit me-1">
                <i class="bi bi-pencil-square"></i> Edit
              </a>
              <button class="btn-delete" data-id="${product._id}">
                <i class="bi bi-trash"></i> Delete
              </button>
            </td>
          </tr>
        `).join('');
        tableBody.innerHTML = rows;
      } else {
        tableBody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-5">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #e5e7eb;"></i>
              <p class="mt-2 text-muted">No products found</p>
            </td>
          </tr>
        `;
      }

      // Re-bind toggle listeners
      document.querySelectorAll('.toggle-status').forEach(input => {
        input.addEventListener('change', toggleProductStatus);
      });

      updatePagination({
        currentPage: data.currentPage,
        totalPages: data.totalPages
      });

      const url = new URL(window.location.href);
      url.search = params.toString();
      window.history.pushState({}, '', url);

    } catch (error) {
      console.error('Error fetching products:', error);
      Swal.fire('Error', 'Failed to load products', 'error');
    }
  }

  // Toggle product status
  async function toggleProductStatus(e) {
    const id = e.target.getAttribute('data-id');
    const isCurrentlyListed = e.target.checked;
    const actionText = isCurrentlyListed ? 'activate' : 'deactivate';

    const confirmed = await Swal.fire({
      icon: 'question',
      title: `Are you sure you want to ${actionText} this product?`,
      text: `This will ${isCurrentlyListed ? 'show' : 'hide'} the product on the shop page.`,
      showCancelButton: true,
      confirmButtonText: `Yes, ${actionText} it!`,
      confirmButtonColor: isCurrentlyListed ? '#28a745' : '#dc3545',
      cancelButtonColor: '#6c757d',
      reverseButtons: true
    });

    if (!confirmed.isConfirmed) {
      e.target.checked = !e.target.checked;
      return;
    }

    e.target.disabled = true;

    try {
      const res = await fetch(`/admin/products/api/${id}/toggle`, {
        method: 'PATCH'
      });
      const data = await res.json();

      if (!data.success) throw new Error(data.message || 'Toggle failed');

      await Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: `Product has been ${actionText}d successfully.`,
        confirmButtonColor: '#111',
        timer: 2000,
        showConfirmButton: false
      });

    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Toggle Failed',
        text: err.message || 'Something went wrong',
        confirmButtonColor: '#d33'
      });
      e.target.checked = !e.target.checked;
    } finally {
      e.target.disabled = false;
    }
  }

  // Event delegation for pagination
  document.addEventListener('click', (e) => {
    if (e.target.closest('.pagination-btn')) {
      e.preventDefault();
      const btn = e.target.closest('.pagination-btn');
      const page = parseInt(btn.dataset.page);
      
      if (page && page > 0) {
        currentPage = page;
        fetchAndRenderProducts(currentPage);
      }
    }
  });

  // Search functionality
  searchInput.addEventListener('input', toggleClearButton);

  searchBtn.addEventListener('click', () => {
    currentFilters.q = searchInput.value.trim();
    currentPage = 1;
    fetchAndRenderProducts(currentPage);
  });

  clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    currentFilters.q = '';
    currentPage = 1;
    toggleClearButton();
    fetchAndRenderProducts(currentPage);
  });

  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchBtn.click();
    }
  });

  // Apply filters
  applyFiltersBtn.addEventListener('click', () => {
    currentFilters.q = searchInput.value.trim();
    currentFilters.category = filterCategory.value;
    currentFilters.brand = getSelectedBrands();
    currentFilters.minPrice = filterMinPrice.value;
    currentFilters.maxPrice = filterMaxPrice.value;
    currentFilters.status = filterStatus.value;
    currentFilters.stock = filterStock.value;
    currentFilters.sort = sortSelect.value;
    currentPage = 1;
    fetchAndRenderProducts(currentPage);
  });

  // Reset filters
  resetFiltersBtn.addEventListener('click', () => {
    searchInput.value = '';
    filterCategory.value = '';
    filterMinPrice.value = '';
    filterMaxPrice.value = '';
    filterStatus.value = '';
    filterStock.value = '';
    sortSelect.value = '';
    
    brandCheckboxes.forEach(cb => {
      if (cb.value === '') {
        cb.checked = true;
      } else {
        cb.checked = false;
      }
    });
    updateBrandDropdownText();
    
    toggleClearButton();
    
    currentFilters = {
      q: '',
      category: '',
      brand: '',
      minPrice: '',
      maxPrice: '',
      status: '',
      stock: '',
      sort: ''
    };
    
    currentPage = 1;
    fetchAndRenderProducts(currentPage);
  });

  // Quick sort change
  sortSelect.addEventListener('change', () => {
    currentFilters.sort = sortSelect.value;
    currentPage = 1;
    fetchAndRenderProducts(currentPage);
  });

  toggleClearButton();
});

// Delete product
document.addEventListener('click', async (e) => {
  if (e.target.closest('.btn-delete')) {
    const btn = e.target.closest('.btn-delete');
    const productId = btn.dataset.id;

    const confirmed = await Swal.fire({
      icon: 'warning',
      title: 'Are you sure?',
      text: 'This product will be moved to trash.',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it!',
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d'
    });

    if (!confirmed.isConfirmed) return;

    try {
      const res = await fetch(`/admin/products/api/${productId}/delete`, {
        method: 'PATCH'
      });

      const data = await res.json();
      if (data.success) {
        await Swal.fire({
          icon: 'success',
          title: 'Deleted!',
          text: 'The product has been soft deleted.',
          confirmButtonColor: '#111'
        });
        window.location.reload();
      } else {
        throw new Error(data.message || 'Delete failed.');
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Oops!',
        text: err.message || 'Something went wrong.',
        confirmButtonColor: '#d33'
      });
    }
  }
});
</script>
