<!-- Include Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<style>
/* ========= BRAND MANAGEMENT SPECIFIC STYLES ========= */
.brand-management-container {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
}

.page-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  color: white;
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.page-subtitle {
  color: rgba(255, 255, 255, 0.85);
  margin: 0.5rem 0 0 0;
}

.add-brand-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  color: white;
  background-color: #ef4444;
}

.add-brand-btn:hover {
  background-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Filters Card */
.filters-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.filters-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filters-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1rem;
  align-items: start;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.form-select, .form-control {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  transition: all 0.2s ease;
  background-color: white;
}

.form-control:focus, .form-select:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

/* Search Input with Icon Button */
.search-input-container {
  position: relative;
  display: flex;
}

.search-input-container .form-control {
  flex: 1;
  padding-right: 45px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.search-input-container .clear-btn {
  position: absolute;
  right: 45px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6c757d;
  font-size: 0.9rem;
  padding: 0.25rem;
  cursor: pointer;
  z-index: 3;
  transition: color 0.2s ease;
}

.search-input-container .clear-btn:hover {
  color: #e03a2f;
}

.search-input-container .search-btn {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  border-left: none;
  background-color: white;
  border: 1px solid #e5e7eb;
  color: #333;
  padding: 0.6rem 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.search-input-container .search-btn:hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
}

/* Filter Button Container */
.filter-button-container {
  display: flex;
  justify-content: flex-end;
  margin-top: 0.5rem;
  min-height: 38px;
}

/* Remove Filter Button */
.remove-filter-btn {
  padding: 0.6rem 1.25rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  width: auto;
  background-color: #ef4444;
  color: white;
}

.remove-filter-btn:hover {
  background-color: #dc2626;
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.remove-filter-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* Modern Table Wrapper */
.table-wrapper {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  overflow-x: auto;
}

.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem;
}

.modern-table thead th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.5px;
  padding: 1.25rem 1rem;
  border-bottom: 2px solid #e9ecef;
  text-align: left;
}

.modern-table tbody td {
  padding: 1.5rem 1rem;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.modern-table tbody tr {
  transition: all 0.2s ease;
  height: auto;
}

.modern-table tbody tr:nth-child(even) {
  background-color: #f9fafb;
}

.modern-table tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Row Number Styling */
.row-number {
  text-align: center;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 70px;
  font-weight: 700;
  color: #6c757d;
}

/* Brand Name Cell */
.brand-name {
  font-weight: 600;
  color: #111827;
  font-size: 1rem;
}

/* Status Badge */
.status-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.875rem;
  transition: all 0.3s ease;
}

.status-badge.active {
  background-color: #d1fae5;
  color: #065f46;
}

.status-badge.inactive {
  background-color: #fee2e2;
  color: #991b1b;
}

/* Offer Badge */
.offer-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 6px;
  font-weight: 700;
  font-size: 0.875rem;
  background-color: #fbbf24;
  color: #000000;
}

.offer-none {
  font-style: italic;
  color: #9ca3af;
  font-size: 0.875rem;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.action-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.875rem;
}

.edit-btn {
  background-color: #3b82f6;
  color: white;
}

.edit-btn:hover {
  background-color: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.delete-btn {
  background-color: #ef4444;
  color: white;
}

.delete-btn:hover {
  background-color: #dc2626;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 28px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #cbd5e1;
  transition: 0.3s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch input:checked + .toggle-slider {
  background-color: #10b981;
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

.toggle-switch input:disabled + .toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}

/* No Data */
.no-data {
  text-align: center;
  padding: 3rem 1rem;
  color: #6b7280;
}

.no-data-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  font-size: 1.1rem;
}

.no-data-content i {
  font-size: 3rem;
  color: #e5e7eb;
}

/* Responsive */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .add-brand-btn {
    width: 100%;
    justify-content: center;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }

  .filter-button-container {
    justify-content: stretch;
  }

  .remove-filter-btn {
    width: 100%;
    justify-content: center;
  }

  .action-buttons {
    flex-wrap: wrap;
  }

  .action-btn {
    flex: 1;
    justify-content: center;
  }
}

/* Loading Animation */
.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ========= PAGINATION STYLES ========= */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 2rem;
  margin-bottom: 2rem;
}

.pagination {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  list-style: none;
  margin: 0;
  padding: 0;
}

.page-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  padding: 8px 12px;
  border: 1px solid #dee2e6;
  background-color: white;
  color: #333;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
  font-size: 0.9rem;
}

/* Red hover effect for enabled buttons */
.page-btn:not(:disabled):not(.active):hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(224, 58, 47, 0.2);
}

/* Active page styling */
.page-btn.active {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  font-weight: 600;
}

.page-btn.active:hover {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  transform: none;
  box-shadow: none;
}

/* Disabled button styles */
.page-btn:disabled {
  color: #6c757d;
  background-color: #f8f9fa;
  border-color: #dee2e6;
  cursor: not-allowed;
  opacity: 0.6;
}

.page-btn:disabled:hover {
  background-color: #f8f9fa;
  border-color: #dee2e6;
  color: #6c757d;
  transform: none;
  box-shadow: none;
}

/* Icon spacing */
.page-btn i {
  font-size: 0.9em;
}

/* ========= IMAGE UPLOAD STYLES ========= */
.image-upload-section {
  margin-top: 1rem;
}

.brand-image-preview {
  position: relative;
  width: 200px;
  height: 200px;
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  background: #f8f9fa;
}

.brand-image-preview:hover {
  border-color: #e03a2f;
  background: #fff5f5;
}

.brand-image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-placeholder-content {
  text-align: center;
  color: #6c757d;
}

.image-placeholder-content i {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  display: block;
}

.btn-remove-image {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #dc3545, #bb2d3b);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.btn-remove-image:hover {
  background: linear-gradient(135deg, #bb2d3b, #a02834);
  transform: scale(1.1) rotate(90deg);
}

.btn-crop-image {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #6f42c1, #5a2d91);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  font-size: 16px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.btn-crop-image:hover {
  background: linear-gradient(135deg, #5a2d91, #4c2577);
  transform: scale(1.1);
}

/* ========= CROPPER MODAL ========= */
.cropper-modal-custom {
  max-width: 900px;
  width: 95vw;
}

.cropper-modal-content {
  height: 600px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
}

.cropper-modal-content .modal-header {
  flex-shrink: 0;
  height: 60px;
  display: flex;
  align-items: center;
}

.cropper-modal-content .modal-footer {
  flex-shrink: 0;
  height: 70px;
  display: flex;
  align-items: center;
}

.cropper-modal-content .modal-body {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 0;
}

.cropper-image-container {
  width: 100%;
  height: 100%;
  position: relative;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cropper-image-container img {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

/* Cropper.js customization */
.cropper-view-box {
  outline: 2px solid rgba(224, 58, 47, 0.8);
}

.cropper-point {
  width: 10px !important;
  height: 10px !important;
  background-color: #E03A2F !important;
  border: 2px solid #fff !important;
  border-radius: 50% !important;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
}

.cropper-line {
  background-color: #E03A2F !important;
  opacity: 0.7 !important;
}

@media (max-width: 768px) {
  .brand-image-preview {
    width: 150px;
    height: 150px;
  }
}


/* Responsive adjustments */
@media (max-width: 576px) {
  .page-btn {
    min-width: 35px;
    height: 35px;
    padding: 6px 8px;
    font-size: 0.8rem;
  }

  .page-btn i {
    font-size: 0.8em;
  }

  .pagination {
    gap: 0.25rem;
  }
}
</style>

<div class="brand-management-container">
  <!-- Breadcrumbs -->
  <%- include('./partials/breadcrumbs', {
    breadcrumbs: [
      { label: 'Dashboard', url: '/admin/dashboard', icon: 'house-door' },
      { label: 'Brands', icon: 'bookmark-star' }
    ]
  }) %>

  <!-- Page Header --> 
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          Brand Management (<span id="brand-count"><%= typeof totalRecords !== 'undefined' ? totalRecords : brands.length %></span>)
        </h1>
        <p class="page-subtitle">Organize and manage product brands</p>
      </div>
      <div class="header-right">
        <button 
          type="button" 
          class="add-brand-btn" 
          data-bs-toggle="modal" 
          data-bs-target="#addBrandModal">
          <i class="bi bi-plus-circle"></i>
          <span>Add Brand</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <h3 class="filters-title">
      <i class="bi bi-funnel"></i>
      Filter Options
    </h3>
    <div class="filters-grid">
      <!-- Search Group -->
      <div class="filter-group">
        <label class="filter-label">Search Brands</label>
        <div class="search-input-container">
          <input 
            type="text" 
            class="form-control"
            id="search-input"
            placeholder="Search by brand name"
            value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          >
          <button type="button" id="clear-search" class="clear-btn <%= typeof searchQuery === 'undefined' || !searchQuery ? 'd-none' : '' %>">
            <i class="bi bi-x-lg"></i>
          </button>
          <button class="search-btn" type="button" id="search-btn">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Status Filter Group -->
      <div class="filter-group">
        <label class="filter-label">Status Filter</label>
        <select class="form-select" id="status-filter">
          <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Brands</option>
          <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Active</option>
          <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Inactive</option>
        </select>
        <div class="filter-button-container">
          <% if (statusFilter !== 'all') { %>
            <button type="button" class="remove-filter-btn" id="remove-filter-btn">
              <i class="bi bi-x-circle"></i>
              Remove Filters
            </button>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Brands Table -->
  <div class="table-wrapper">
    <table class="modern-table">
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th>Brand Name</th>
          <th>Description</th>
          <th>Offer</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="brand-table-body">
        <% if (brands && brands.length > 0) { %>
          <% brands.forEach((brand, index) => { %>
            <tr data-brand-id="<%= brand._id %>">
              <td>
                <div class="row-number">
                  <span class="fw-bold text-black"><%= index + 1 %></span>
                </div>
              </td>
              <td>
                <span class="brand-name"><%= brand.name %></span>
              </td>
              <td><%= brand.description || 'No description' %></td>
              <td>
                <% if (brand.brandOffer && brand.brandOffer > 0) { %>
                  <span class="offer-badge"><%= brand.brandOffer %>%</span>
                <% } else { %>
                  <span class="offer-none">None</span>
                <% } %>
              </td>
              <td>
                <span class="status-badge <%= brand.isActive ? 'active' : 'inactive' %>" data-status-badge>
                  <%= brand.isActive ? 'Active' : 'Inactive' %>
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    class="action-btn edit-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#editBrandModal"
                    data-brand-id="<%= brand._id %>"
                    data-brand-name="<%= brand.name %>"
                    data-brand-description="<%= brand.description || '' %>"
                    data-brand-offer="<%= brand.brandOffer || 0 %>">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <label class="toggle-switch">
                    <input 
                      type="checkbox" 
                      <%= brand.isActive ? 'checked' : '' %>
                      onchange="toggleBrand('<%= brand._id %>', this)"
                      data-toggle-input>
                    <span class="toggle-slider"></span>
                  </label>
                  <button
                    class="action-btn delete-btn"
                    onclick="deleteBrand('<%= brand._id %>')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr>
            <td colspan="6" class="no-data">
              <div class="no-data-content">
                <i class="bi bi-inbox"></i>
                <span>No brands found</span>
              </div>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-wrapper">
    <div class="pagination">
      <!-- Previous Button -->
      <% if (currentPage > 1) { %>
        <button
          class="page-btn pagination-btn"
          data-page="<%= currentPage - 1 %>">
          <i class="bi bi-chevron-left"></i>
        </button>
      <% } else { %>
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-left"></i>
        </button>
      <% } %>

      <!-- Page Numbers -->
      <%
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
        if (endPage - startPage + 1 < maxPagesToShow) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        
        const pageNumbers = [];
        for (let i = startPage; i <= endPage; i++) {
          pageNumbers.push(i);
        }
      %>
      
      <% pageNumbers.forEach(pageNum => { %>
        <% if (pageNum === currentPage) { %>
          <button class="page-btn active"><%= pageNum %></button>
        <% } else { %>
          <button
            class="page-btn pagination-btn"
            data-page="<%= pageNum %>">
            <%= pageNum %>
          </button>
        <% } %>
      <% }) %>

      <!-- Next Button -->
      <% if (currentPage < totalPages) { %>
        <button
          class="page-btn pagination-btn"
          data-page="<%= currentPage + 1 %>">
          <i class="bi bi-chevron-right"></i>
        </button>
      <% } else { %>
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-right"></i>
        </button>
      <% } %>
    </div>
  </div>
</div>

<!-- Add Brand Modal -->
<div class="modal fade" id="addBrandModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Brand</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="addBrandForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="brandName" class="form-label">Brand Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="brandName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="brandDescription" class="form-label">Description</label>
            <textarea class="form-control" id="brandDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="brandOffer" class="form-label">Brand Offer (%)</label>
            <input 
              type="number" 
              class="form-control" 
              id="brandOffer" 
              name="brandOffer" 
              min="0" 
              max="100" 
              step="0.01"
              value="0"
              placeholder="Enter offer percentage (0-100)">
            <small class="text-muted">Enter a value between 0 and 100</small>
          </div>
          
          <!-- Image Upload Section INSIDE modal-body -->
          <div class="image-upload-section">
            <label class="form-label">Brand Image (Optional)</label>
            <input type="file" id="add-brand-image-input" accept="image/*" class="d-none">
            <div class="brand-image-preview" id="add-image-preview" onclick="document.getElementById('add-brand-image-input').click()">
              <div class="image-placeholder-content">
                <i class="bi bi-image"></i>
                <div>Click to upload</div>
                <small class="text-muted">800x800 recommended</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Brand</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Edit Brand Modal -->
<div class="modal fade" id="editBrandModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Brand</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editBrandForm">
        <div class="modal-body">
          <input type="hidden" id="editBrandId" name="id">
          <div class="mb-3">
            <label for="editBrandName" class="form-label">Brand Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editBrandName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="editBrandDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editBrandDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="editBrandOffer" class="form-label">Brand Offer (%)</label>
            <input 
              type="number" 
              class="form-control" 
              id="editBrandOffer" 
              name="brandOffer" 
              min="0" 
              max="100" 
              step="0.01"
              placeholder="Enter offer percentage (0-100)">
            <small class="text-muted">Enter a value between 0 and 100</small>
          </div>
          
          <!-- Image Upload Section INSIDE modal-body -->
          <div class="image-upload-section">
            <label class="form-label">Brand Image</label>
            <input type="file" id="edit-brand-image-input" accept="image/*" class="d-none">
            <div class="brand-image-preview" id="edit-image-preview" onclick="document.getElementById('edit-brand-image-input').click()">
              <div class="image-placeholder-content">
                <i class="bi bi-image"></i>
                <div>Click to upload</div>
                <small class="text-muted">800x800 recommended</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg cropper-modal-custom">
    <div class="modal-content cropper-modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-crop me-2"></i>Crop Image
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="cropper-image-container">
          <img id="cropper-image" src="" alt="Crop">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="crop-and-save">
          <i class="bi bi-check-lg me-1"></i> Crop & Save
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Include Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="/utils/imageValidation.js"></script>


<script>

// ========= IMAGE UPLOAD VARIABLES =========
let cropper = null;
let currentImageMode = 'add'; // 'add' or 'edit'
let addBrandBase64 = '';
let editBrandBase64 = '';

const addImageInput = document.getElementById('add-brand-image-input');
const addImagePreview = document.getElementById('add-image-preview');
const editImageInput = document.getElementById('edit-brand-image-input');
const editImagePreview = document.getElementById('edit-image-preview');

// ========= IMAGE UPLOAD HANDLERS =========

// Add Brand Image Handler
addImageInput.addEventListener('change', function(e) {
  handleImageSelection(e, 'add');
});

// Edit Brand Image Handler
editImageInput.addEventListener('change', function(e) {
  handleImageSelection(e, 'edit');
});

// Handle image selection and validation
function handleImageSelection(e, mode) {
  const file = e.target.files[0];
  if (!file) return;

  // Validate image
  const validation = window.ImageValidator.validateImageFile(file);
  if (!validation.isValid) {
    Swal.fire({
      icon: 'error',
      title: 'Invalid Image',
      text: validation.message,
      confirmButtonColor: '#dc3545'
    });
    e.target.value = ''; // Clear input
    return;
  }

  // Read and display image
  const reader = new FileReader();
  reader.onload = function(event) {
    currentImageMode = mode;
    showCropperModal(event.target.result);
  };
  reader.readAsDataURL(file);
}

// Show cropper modal
function showCropperModal(imageDataUrl) {
  const cropperImage = document.getElementById('cropper-image');
  const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
  
  cropperImage.src = imageDataUrl;
  cropperModal.show();
  
  // Initialize cropper after modal is shown
  document.getElementById('cropperModal').addEventListener('shown.bs.modal', function() {
    if (cropper) {
      cropper.destroy();
    }
    
    cropper = new Cropper(cropperImage, {
      aspectRatio: 1,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 1,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
    });
  }, { once: true });
}

// Crop and save button handler
document.getElementById('crop-and-save').addEventListener('click', function() {
  if (!cropper) return;
  
  // Get cropped canvas
  const canvas = cropper.getCroppedCanvas({
    width: 800,
    height: 800,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: 'high',
  });
  
  // Convert to base64
  const base64Image = canvas.toDataURL('image/webp', 0.9);
  
  // Store base64 based on mode
  if (currentImageMode === 'add') {
    addBrandBase64 = base64Image;
    displayImagePreview(addImagePreview, base64Image, 'add');
  } else {
    editBrandBase64 = base64Image;
    displayImagePreview(editImagePreview, base64Image, 'edit');
  }
  
  // Close modal
  bootstrap.Modal.getInstance(document.getElementById('cropperModal')).hide();
  
  // Cleanup
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
});

// Display image preview
function displayImagePreview(previewElement, base64Image, mode) {
  previewElement.innerHTML = `
    <img src="${base64Image}" alt="Brand Image">
    <button type="button" class="btn-remove-image" onclick="removeImage('${mode}')">
      <i class="bi bi-x"></i>
    </button>
    <button type="button" class="btn-crop-image" onclick="recropImage('${mode}')">
      <i class="bi bi-crop"></i>
    </button>
  `;
  previewElement.onclick = null; // Remove click handler when image is present
}

// Remove image
function removeImage(mode) {
  if (mode === 'add') {
    addBrandBase64 = '';
    addImagePreview.innerHTML = `
      <div class="image-placeholder-content">
        <i class="bi bi-image"></i>
        <div>Click to upload</div>
        <small class="text-muted">800x800 recommended</small>
      </div>
    `;
    addImagePreview.onclick = () => addImageInput.click();
    addImageInput.value = '';
  } else {
    editBrandBase64 = '';
    editImagePreview.innerHTML = `
      <div class="image-placeholder-content">
        <i class="bi bi-image"></i>
        <div>Click to upload</div>
        <small class="text-muted">800x800 recommended</small>
      </div>
    `;
    editImagePreview.onclick = () => editImageInput.click();
    editImageInput.value = '';
  }
}

// Recrop image
function recropImage(mode) {
  const base64 = mode === 'add' ? addBrandBase64 : editBrandBase64;
  if (base64) {
    currentImageMode = mode;
    showCropperModal(base64);
  }
}

// Clean up cropper when modal is hidden
document.getElementById('cropperModal').addEventListener('hidden.bs.modal', function() {
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
});

// Reset add modal when closed
document.getElementById('addBrandModal').addEventListener('hidden.bs.modal', function() {
  addBrandForm.reset();
  removeImage('add');
});


// Toggle brand status
async function toggleBrand(brandId, checkbox) {
  const row = checkbox.closest('tr');
  const statusBadge = row.querySelector('[data-status-badge]');
  const originalChecked = checkbox.checked;

  try {
    const response = await fetch(`/admin/brands/api/${brandId}/toggle`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' }
    });

    const result = await response.json();

    if (result.success) {
      statusBadge.textContent = result.isActive ? 'Active' : 'Inactive';
      statusBadge.className = `status-badge ${result.isActive ? 'active' : 'inactive'}`;
      
      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
      });

      Toast.fire({
        icon: 'success',
        title: result.message
      });
    } else {
      checkbox.checked = !originalChecked;
      Swal.fire('Error', result.message || 'Failed to update status', 'error');
    }
  } catch (error) {
    console.error('Toggle error:', error);
    checkbox.checked = !originalChecked;
    Swal.fire('Error', 'Failed to update brand status', 'error');
  }
}

// Delete brand
async function deleteBrand(brandId) {
  const result = await Swal.fire({
    title: 'Are you sure?',
    text: "This brand will be marked as deleted!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#6b7280',
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel'
  });

  if (result.isConfirmed) {
    try {
      const response = await fetch(`/admin/brands/api/${brandId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.success) {
        Swal.fire('Deleted!', data.message, 'success');
        await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    } catch (error) {
      console.error('Delete error:', error);
      Swal.fire('Error', 'Failed to delete brand', 'error');
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const searchBtn = document.getElementById('search-btn');
  const clearSearchBtn = document.getElementById('clear-search');
  const tableBody = document.getElementById('brand-table-body');
  const filterButtonContainer = document.querySelector('.filter-button-container');

  let currentQuery = searchInput.value;
  let currentStatus = statusFilter.value;
  let currentPage = <%= currentPage || 1 %>;

  // Toggle clear button visibility
  function toggleClearButton() {
    if (searchInput.value.trim()) {
      clearSearchBtn.classList.remove('d-none');
    } else {
      clearSearchBtn.classList.add('d-none');
    }
  }

  // Update remove filter button visibility
  function updateRemoveFilterButton(status) {
    if (status === 'all') {
      filterButtonContainer.innerHTML = '';
    } else {
      filterButtonContainer.innerHTML = `
        <button type="button" class="remove-filter-btn" id="remove-filter-btn">
          <i class="bi bi-x-circle"></i>
          Remove Filters
        </button>
      `;
      const removeBtn = document.getElementById('remove-filter-btn');
      if (removeBtn) {
        removeBtn.addEventListener('click', handleRemoveFilter);
      }
    }
  }

  // Render offer cell
  function renderOfferCell(brandOffer) {
    if (brandOffer && brandOffer > 0) {
      return `<span class="offer-badge">${brandOffer}%</span>`;
    } else {
      return `<span class="offer-none">None</span>`;
    }
  }

  // Update pagination UI
  function updatePagination(paginationData) {
    const paginationWrapper = document.querySelector('.pagination-wrapper');
    
    if (!paginationWrapper) return;
    
    paginationWrapper.style.display = 'flex';
    
    const page = paginationData?.currentPage || 1;
    const totalPages = paginationData?.totalPages || 1;
    
    const pageNumbers = [];
    const maxPagesToShow = 5;
    let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
    
    if (endPage - startPage + 1 < maxPagesToShow) {
      startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      pageNumbers.push(i);
    }
    
    let paginationHTML = '<div class="pagination">';
    
    if (page > 1) {
      paginationHTML += `
        <button class="page-btn pagination-btn" data-page="${page - 1}">
          <i class="bi bi-chevron-left"></i>
        </button>
      `;
    } else {
      paginationHTML += `
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-left"></i>
        </button>
      `;
    }
    
    pageNumbers.forEach(pageNum => {
      if (pageNum === page) {
        paginationHTML += `<button class="page-btn active">${pageNum}</button>`;
      } else {
        paginationHTML += `
          <button class="page-btn pagination-btn" data-page="${pageNum}">
            ${pageNum}
          </button>
        `;
      }
    });
    
    if (page < totalPages) {
      paginationHTML += `
        <button class="page-btn pagination-btn" data-page="${page + 1}">
          <i class="bi bi-chevron-right"></i>
        </button>
      `;
    } else {
      paginationHTML += `
        <button class="page-btn" disabled>
          <i class="bi bi-chevron-right"></i>
        </button>
      `;
    }
    
    paginationHTML += '</div>';
    paginationWrapper.innerHTML = paginationHTML;
  }

  // Fetch and render brands
  async function fetchAndRenderBrands(query = '', status = 'all', page = 1) {
    try {
      const params = new URLSearchParams();
      if (query) params.append('q', query);
      if (status !== 'all') params.append('status', status);
      params.append('page', page);

      const response = await fetch(`/admin/brands/api?${params.toString()}`);
      const data = await response.json();

      if (data.totalRecords !== undefined) {
        document.getElementById('brand-count').textContent = data.totalRecords;
      }

      if (data.brands && data.brands.length > 0) {
        const startIndex = (page - 1) * 10;
        const rows = data.brands.map((brand, index) => `
          <tr data-brand-id="${brand._id}">
            <td>
              <div class="row-number">
                <span class="fw-bold text-black">${startIndex + index + 1}</span>
              </div>
            </td>
            <td>
              <span class="brand-name">${brand.name}</span>
            </td>
            <td>${brand.description || 'No description'}</td>
            <td>
              ${renderOfferCell(brand.brandOffer)}
            </td>
            <td>
              <span class="status-badge ${brand.isActive ? 'active' : 'inactive'}" data-status-badge>
                ${brand.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="action-btn edit-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#editBrandModal"
                  data-brand-id="${brand._id}"
                  data-brand-name="${brand.name}"
                  data-brand-description="${brand.description || ''}"
                  data-brand-offer="${brand.brandOffer || 0}"
                  data-brand-image="${brand.image || ''}">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    ${brand.isActive ? 'checked' : ''}
                    onchange="toggleBrand('${brand._id}', this)"
                    data-toggle-input>
                  <span class="toggle-slider"></span>
                </label>
                <button
                  class="action-btn delete-btn"
                  onclick="deleteBrand('${brand._id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        tableBody.innerHTML = rows;
      } else {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="no-data">
              <div class="no-data-content">
                <i class="bi bi-inbox"></i>
                <span>No brands found</span>
              </div>
            </td>
          </tr>
        `;
      }

      updatePagination({
        currentPage: data.currentPage,
        totalPages: data.totalPages
      });

      const url = new URL(window.location.href);
      url.search = params.toString();
      window.history.pushState({}, '', url);

    } catch (error) {
      console.error('Error fetching brands:', error);
      Swal.fire('Error', 'Failed to load brands', 'error');
    }
  }

  // Event delegation for pagination buttons
  document.addEventListener('click', function(e) {
    if (e.target.closest('.pagination-btn')) {
      e.preventDefault();
      const btn = e.target.closest('.pagination-btn');
      const page = parseInt(btn.dataset.page);
      
      if (page && page > 0) {
        currentPage = page;
        fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
      }
    }
  });

  // Handle remove filter action
  async function handleRemoveFilter() {
    const btn = document.getElementById('remove-filter-btn');
    if (!btn) return;
    
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Removing...';
    btn.disabled = true;

    try {
      statusFilter.value = 'all';
      currentStatus = 'all';
      currentPage = 1;
      await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
      updateRemoveFilterButton('all');
    } catch (error) {
      console.error(error);
      btn.innerHTML = originalHTML;
      btn.disabled = false;
    }
  }

  searchInput.addEventListener('input', toggleClearButton);

  searchBtn.addEventListener('click', async () => {
    currentQuery = searchInput.value.trim();
    currentPage = 1;
    await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
  });

  clearSearchBtn.addEventListener('click', async () => {
    searchInput.value = '';
    currentQuery = '';
    currentPage = 1;
    toggleClearButton();
    await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
  });

  statusFilter.addEventListener('change', async () => {
    const newStatus = statusFilter.value;
    currentStatus = newStatus;
    currentPage = 1;
    await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
    updateRemoveFilterButton(newStatus);
  });

  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchBtn.click();
    }
  });

  // Add Brand Form
  const addBrandForm = document.getElementById('addBrandForm');
  const addBrandModal = document.getElementById('addBrandModal');

  if (addBrandForm) {
    addBrandForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = addBrandForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Adding...';

      try {
        const formData = new FormData(addBrandForm);
        const data = {
          name: formData.get('name'),
          description: formData.get('description'),
          brandOffer: formData.get('brandOffer')
        };

        const response = await fetch('/admin/brands/api/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: formData.get('name'),
            description: formData.get('description'),
            brandOffer: formData.get('brandOffer'),
            base64Image: addBrandBase64  // Add this line
          })
        });




        const result = await response.json();

        if (result.success) {
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });

          Toast.fire({
            icon: 'success',
            title: result.message || 'Brand created successfully'
          });

          const modalInstance = bootstrap.Modal.getInstance(addBrandModal);
          if (modalInstance) {
            modalInstance.hide();
          }

          addBrandForm.reset();
          await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to create brand'
          });
        }
      } catch (error) {
        console.error('Error creating brand:', error);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: 'Failed to create brand. Please try again.'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  }

  // Edit Brand Form
  const editBrandForm = document.getElementById('editBrandForm');
  const editBrandModal = document.getElementById('editBrandModal');

  if (editBrandForm) {
    editBrandForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = editBrandForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Saving...';

      try {
        const formData = new FormData(editBrandForm);
        const brandId = document.getElementById('editBrandId').value;
        const data = {
          name: formData.get('name'),
          description: formData.get('description'),
          brandOffer: formData.get('brandOffer')
        };

        const response = await fetch(`/admin/brands/api/${brandId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: formData.get('name'),
            description: formData.get('description'),
            brandOffer: formData.get('brandOffer'),
            base64Image: editBrandBase64  // Add this line
          })
        });

        const result = await response.json();

        if (result.success) {
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });

          Toast.fire({
            icon: 'success',
            title: result.message || 'Brand updated successfully'
          });

          const modalInstance = bootstrap.Modal.getInstance(editBrandModal);
          if (modalInstance) {
            modalInstance.hide();
          }

          await fetchAndRenderBrands(currentQuery, currentStatus, currentPage);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to update brand'
          });
        }
      } catch (error) {
        console.error('Error updating brand:', error);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: 'Failed to update brand. Please try again.'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  }

  // Edit modal populate
  const editModal = document.getElementById('editBrandModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', (event) => {
      const button = event.relatedTarget;
      const brandId = button.getAttribute('data-brand-id');
      const brandName = button.getAttribute('data-brand-name');
      const brandDescription = button.getAttribute('data-brand-description');
      const brandOffer = button.getAttribute('data-brand-offer');
      const brandImage = button.getAttribute('data-brand-image');  // Add this

      document.getElementById('editBrandId').value = brandId;
      document.getElementById('editBrandName').value = brandName;
      document.getElementById('editBrandDescription').value = brandDescription;
      document.getElementById('editBrandOffer').value = brandOffer || 0;

      // Display existing image if available
      if (brandImage) {
        editBrandBase64 = brandImage;
        displayImagePreview(editImagePreview, brandImage, 'edit');
      } else {
        removeImage('edit');
      }
    });
  } 

  const initialRemoveBtn = document.getElementById('remove-filter-btn');
  if (initialRemoveBtn) {
    initialRemoveBtn.addEventListener('click', handleRemoveFilter);
  }

  toggleClearButton();

  // Make fetchAndRenderBrands available globally
  window.fetchAndRenderBrands = fetchAndRenderBrands;
  window.currentQuery = currentQuery;
  window.currentStatus = currentStatus;
  window.currentPage = currentPage;
});
</script>
