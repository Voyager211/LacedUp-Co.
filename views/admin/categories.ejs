<style>
/* ========= CATEGORY MANAGEMENT SPECIFIC STYLES ========= */
.category-management-container {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
}

.page-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  color: white;
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.page-subtitle {
  color: rgba(255, 255, 255, 0.85);
  margin: 0.5rem 0 0 0;
}

.add-category-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  color: white;
  background-color: #ef4444;
}

.add-category-btn:hover {
  background-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Filters Card */
.filters-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.filters-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filters-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1rem;
  align-items: start;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.form-select, .form-control {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  transition: all 0.2s ease;
  background-color: white;
}

.form-control:focus, .form-select:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

/* Search Input with Icon Button */
.search-input-container {
  position: relative;
  display: flex;
}

.search-input-container .form-control {
  flex: 1;
  padding-right: 45px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.search-input-container .clear-btn {
  position: absolute;
  right: 45px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6c757d;
  font-size: 0.9rem;
  padding: 0.25rem;
  cursor: pointer;
  z-index: 3;
  transition: color 0.2s ease;
}

.search-input-container .clear-btn:hover {
  color: #e03a2f;
}

.search-input-container .search-btn {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  border-left: none;
  background-color: white;
  border: 1px solid #e5e7eb;
  color: #333;
  padding: 0.6rem 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.search-input-container .search-btn:hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
}

/* Filter Button Container */
.filter-button-container {
  display: flex;
  justify-content: flex-end;
  margin-top: 0.5rem;
  min-height: 38px;
}

/* Remove Filter Button */
.remove-filter-btn {
  padding: 0.6rem 1.25rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  width: auto;
  background-color: #ef4444;
  color: white;
}

.remove-filter-btn:hover {
  background-color: #dc2626;
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.remove-filter-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* Modern Table Wrapper */
.table-wrapper {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  overflow-x: auto;
}

.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem;
}

.modern-table thead th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.5px;
  padding: 1.25rem 1rem;
  border-bottom: 2px solid #e9ecef;
  text-align: left;
}

.modern-table tbody td {
  padding: 1.5rem 1rem;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.modern-table tbody tr {
  transition: all 0.2s ease;
  height: auto;
}

.modern-table tbody tr:nth-child(even) {
  background-color: #f9fafb;
}

.modern-table tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Row Number Styling */
.row-number {
  text-align: center;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 70px;
  font-weight: 700;
  color: #6c757d;
}

/* Category Name Cell */
.category-name {
  font-weight: 600;
  color: #111827;
  font-size: 1rem;
}

/* Status Badge */
.status-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.875rem;
  transition: all 0.3s ease;
}

.status-badge.active {
  background-color: #d1fae5;
  color: #065f46;
}

.status-badge.inactive {
  background-color: #fee2e2;
  color: #991b1b;
}

/* Offer Badge */
.offer-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 6px;
  font-weight: 700;
  font-size: 0.875rem;
  background-color: #fbbf24;
  color: #000000;
}

.offer-none {
  font-style: italic;
  color: #9ca3af;
  font-size: 0.875rem;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.action-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.875rem;
}

.edit-btn {
  background-color: #3b82f6;
  color: white;
}

.edit-btn:hover {
  background-color: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.delete-btn {
  background-color: #ef4444;
  color: white;
}

.delete-btn:hover {
  background-color: #dc2626;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 28px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #cbd5e1;
  transition: 0.3s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch input:checked + .toggle-slider {
  background-color: #10b981;
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

.toggle-switch input:disabled + .toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}

/* No Data */
.no-data {
  text-align: center;
  padding: 3rem 1rem;
  color: #6b7280;
}

.no-data-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  font-size: 1.1rem;
}

.no-data-content i {
  font-size: 3rem;
  color: #e5e7eb;
}

/* Responsive */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .add-category-btn {
    width: 100%;
    justify-content: center;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }

  .filter-button-container {
    justify-content: stretch;
  }

  .remove-filter-btn {
    width: 100%;
    justify-content: center;
  }

  .action-buttons {
    flex-wrap: wrap;
  }

  .action-btn {
    flex: 1;
    justify-content: center;
  }
}

/* Loading Animation */
.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ========= PAGINATION STYLES ========= */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 2rem;
  margin-bottom: 2rem;
}

.pagination {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  list-style: none;
  margin: 0;
  padding: 0;
}

.page-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  padding: 8px 12px;
  border: 1px solid #dee2e6;
  background-color: white;
  color: #333;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
  font-size: 0.9rem;
}

/* Red hover effect for enabled buttons */
.page-btn:not(:disabled):not(.active):hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(224, 58, 47, 0.2);
}

/* Active page styling */
.page-btn.active {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  font-weight: 600;
}

.page-btn.active:hover {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  transform: none;
  box-shadow: none;
}

/* Disabled button styles */
.page-btn:disabled {
  color: #6c757d;
  background-color: #f8f9fa;
  border-color: #dee2e6;
  cursor: not-allowed;
  opacity: 0.6;
}

.page-btn:disabled:hover {
  background-color: #f8f9fa;
  border-color: #dee2e6;
  color: #6c757d;
  transform: none;
  box-shadow: none;
}

/* Icon spacing */
.page-btn i {
  font-size: 0.9em;
}

/* Responsive adjustments */
@media (max-width: 576px) {
  .page-btn {
    min-width: 35px;
    height: 35px;
    padding: 6px 8px;
    font-size: 0.8rem;
  }

  .page-btn i {
    font-size: 0.8em;
  }

  .pagination {
    gap: 0.25rem;
  }
}

</style>

<div class="category-management-container">
  <!-- Breadcrumbs -->
  <%- include('./partials/breadcrumbs', {
    breadcrumbs: [
      { label: 'Dashboard', url: '/admin/dashboard', icon: 'house-door' },
      { label: 'Categories', icon: 'grid-3x3-gap' }
    ]
  }) %>

  <!-- Page Header --> 
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          Category Management (<span id="category-count"><%= typeof totalRecords !== 'undefined' ? totalRecords : categories.length %></span>)
        </h1>
        <p class="page-subtitle">Organize and manage product categories</p>
      </div>
      <div class="header-right">
        <button 
          type="button" 
          class="add-category-btn" 
          data-bs-toggle="modal" 
          data-bs-target="#addCategoryModal">
          <i class="bi bi-plus-circle"></i>
          <span>Add Category</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <h3 class="filters-title">
      <i class="bi bi-funnel"></i>
      Filter Options
    </h3>
    <div class="filters-grid">
      <!-- Search Group -->
      <div class="filter-group">
        <label class="filter-label">Search Categories</label>
        <div class="search-input-container">
          <input 
            type="text" 
            class="form-control"
            id="search-input"
            placeholder="Search by category name"
            value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          >
          <button type="button" id="clear-search" class="clear-btn <%= typeof searchQuery === 'undefined' || !searchQuery ? 'd-none' : '' %>">
            <i class="bi bi-x-lg"></i>
          </button>
          <button class="search-btn" type="button" id="search-btn">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Status Filter Group -->
      <div class="filter-group">
        <label class="filter-label">Status Filter</label>
        <select class="form-select" id="status-filter">
          <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Categories</option>
          <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Active</option>
          <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Inactive</option>
        </select>
        <div class="filter-button-container">
          <% if (statusFilter !== 'all') { %>
            <button type="button" class="remove-filter-btn" id="remove-filter-btn">
              <i class="bi bi-x-circle"></i>
              Remove Filters
            </button>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Categories Table -->
  <div class="table-wrapper">
    <table class="modern-table">
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th>Category Name</th>
          <th>Description</th>
          <th>Offer</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="category-table-body">
        <% if (categories && categories.length > 0) { %>
          <% categories.forEach((category, index) => { %>
            <tr data-category-id="<%= category._id %>">
              <td>
                <div class="row-number">
                  <span class="fw-bold text-black"><%= index + 1 %></span>
                </div>
              </td>
              <td>
                <span class="category-name"><%= category.name %></span>
              </td>
              <td><%= category.description || 'No description' %></td>
              <td>
                <% if (category.categoryOffer && category.categoryOffer > 0) { %>
                  <span class="offer-badge"><%= category.categoryOffer %>%</span>
                <% } else { %>
                  <span class="offer-none">None</span>
                <% } %>
              </td>
              <td>
                <span class="status-badge <%= category.isActive ? 'active' : 'inactive' %>" data-status-badge>
                  <%= category.isActive ? 'Active' : 'Inactive' %>
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    class="action-btn edit-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#editCategoryModal"
                    data-category-id="<%= category._id %>"
                    data-category-name="<%= category.name %>"
                    data-category-description="<%= category.description || '' %>"
                    data-category-offer="<%= category.categoryOffer || 0 %>">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <label class="toggle-switch">
                    <input 
                      type="checkbox" 
                      <%= category.isActive ? 'checked' : '' %>
                      onchange="toggleCategory('<%= category._id %>', this)"
                      data-toggle-input>
                    <span class="toggle-slider"></span>
                  </label>
                  <button
                    class="action-btn delete-btn"
                    onclick="deleteCategory('<%= category._id %>')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr>
            <td colspan="6" class="no-data">
              <div class="no-data-content">
                <i class="bi bi-inbox"></i>
                <span>No categories found</span>
              </div>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
    <% if (totalPages >= 1) { %>
      <div class="pagination-wrapper">
        <div class="pagination">
          <!-- Previous Button -->
          <% if (currentPage > 1) { %>
            <button
              class="page-btn pagination-btn"
              data-page="<%= currentPage - 1 %>">
              <i class="bi bi-chevron-left"></i>
            </button>
          <% } else { %>
            <button class="page-btn" disabled>
              <i class="bi bi-chevron-left"></i>
            </button>
          <% } %>

          <!-- Page Numbers -->
          <%
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage + 1 < maxPagesToShow) {
              startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            const pageNumbers = [];
            for (let i = startPage; i <= endPage; i++) {
              pageNumbers.push(i);
            }
          %>
          
          <% pageNumbers.forEach(pageNum => { %>
            <% if (pageNum === currentPage) { %>
              <button class="page-btn active"><%= pageNum %></button>
            <% } else { %>
              <button
                class="page-btn pagination-btn"
                data-page="<%= pageNum %>">
                <%= pageNum %>
              </button>
            <% } %>
          <% }) %>

          <!-- Next Button -->
          <% if (currentPage < totalPages) { %>
            <button
              class="page-btn pagination-btn"
              data-page="<%= currentPage + 1 %>">
              <i class="bi bi-chevron-right"></i>
            </button>
          <% } else { %>
            <button class="page-btn" disabled>
              <i class="bi bi-chevron-right"></i>
            </button>
          <% } %>
        </div>
      </div>
    <% } %>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="addCategoryForm" method="POST" action="/admin/categories/api/add">
        <div class="modal-body">
          <div class="mb-3">
            <label for="categoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="categoryName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="categoryDescription" class="form-label">Description</label>
            <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="categoryOffer" class="form-label">Category Offer (%)</label>
            <input 
              type="number" 
              class="form-control" 
              id="categoryOffer" 
              name="categoryOffer" 
              min="0" 
              max="100" 
              step="0.01"
              value="0"
              placeholder="Enter offer percentage (0-100)">
            <small class="text-muted">Enter a value between 0 and 100</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editCategoryForm" method="POST">
        <div class="modal-body">
          <input type="hidden" id="editCategoryId" name="id">
          <div class="mb-3">
            <label for="editCategoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editCategoryName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="editCategoryDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="editCategoryOffer" class="form-label">Category Offer (%)</label>
            <input 
              type="number" 
              class="form-control" 
              id="editCategoryOffer" 
              name="categoryOffer" 
              min="0" 
              max="100" 
              step="0.01"
              placeholder="Enter offer percentage (0-100)">
            <small class="text-muted">Enter a value between 0 and 100</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const searchBtn = document.getElementById('search-btn');
  const clearSearchBtn = document.getElementById('clear-search');
  const tableBody = document.getElementById('category-table-body');
  const filterButtonContainer = document.querySelector('.filter-button-container');

  let currentQuery = searchInput.value;
  let currentStatus = statusFilter.value;
  let currentPage = <%= currentPage || 1 %>;

  // Toggle clear button visibility
  function toggleClearButton() {
    if (searchInput.value.trim()) {
      clearSearchBtn.classList.remove('d-none');
    } else {
      clearSearchBtn.classList.add('d-none');
    }
  }

  // Update remove filter button visibility
  function updateRemoveFilterButton(status) {
    if (status === 'all') {
      filterButtonContainer.innerHTML = '';
    } else {
      filterButtonContainer.innerHTML = `
        <button type="button" class="remove-filter-btn" id="remove-filter-btn">
          <i class="bi bi-x-circle"></i>
          Remove Filters
        </button>
      `;
      const removeBtn = document.getElementById('remove-filter-btn');
      if (removeBtn) {
        removeBtn.addEventListener('click', handleRemoveFilter);
      }
    }
  }

  // Render offer cell
  function renderOfferCell(categoryOffer) {
    if (categoryOffer && categoryOffer > 0) {
      return `<span class="offer-badge">${categoryOffer}%</span>`;
    } else {
      return `<span class="offer-none">None</span>`;
    }
  }

  // Update pagination UI
  function updatePagination(paginationData) {
      const paginationWrapper = document.querySelector('.pagination-wrapper');
      
      if (!paginationWrapper) return;
      
      // Always show pagination
      paginationWrapper.style.display = 'flex';
      
      // Default to page 1 if no data
      const page = paginationData?.currentPage || 1;
      const totalPages = paginationData?.totalPages || 1;
      
      // Generate page numbers (show up to 5 pages around current page)
      const pageNumbers = [];
      const maxPagesToShow = 5;
      let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
      let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
      
      if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pageNumbers.push(i);
      }
      
      // Build pagination HTML
      let paginationHTML = '<div class="pagination">';
      
      // Previous button
      if (page > 1) {
        paginationHTML += `
          <button class="page-btn pagination-btn" data-page="${page - 1}">
            <i class="bi bi-chevron-left"></i>
          </button>
        `;
      } else {
        paginationHTML += `
          <button class="page-btn" disabled>
            <i class="bi bi-chevron-left"></i>
          </button>
        `;
      }
      
      // Page numbers
      pageNumbers.forEach(pageNum => {
        if (pageNum === page) {
          paginationHTML += `<button class="page-btn active">${pageNum}</button>`;
        } else {
          paginationHTML += `
            <button class="page-btn pagination-btn" data-page="${pageNum}">
              ${pageNum}
            </button>
          `;
        }
      });
      
      // Next button
      if (page < totalPages) {
        paginationHTML += `
          <button class="page-btn pagination-btn" data-page="${page + 1}">
            <i class="bi bi-chevron-right"></i>
          </button>
        `;
      } else {
        paginationHTML += `
          <button class="page-btn" disabled>
            <i class="bi bi-chevron-right"></i>
          </button>
        `;
      }
      
      paginationHTML += '</div>';
      
      // Replace pagination content
      paginationWrapper.innerHTML = paginationHTML;
    }

  // Fetch and render categories
  async function fetchAndRenderCategories(query = '', status = 'all', page = 1) {
    try {
      const params = new URLSearchParams();
      if (query) params.append('q', query);
      if (status !== 'all') params.append('status', status);
      params.append('page', page);

      const response = await fetch(`/admin/categories/api?${params.toString()}`);
      const data = await response.json();

      // Update category count
      if (data.totalRecords !== undefined) {
        document.getElementById('category-count').textContent = data.totalRecords;
      }

      // Render table rows
      if (data.categories && data.categories.length > 0) {
        const startIndex = (page - 1) * 10; // 10 is the limit from controller
        const rows = data.categories.map((category, index) => `
          <tr data-category-id="${category._id}">
            <td>
              <div class="row-number">
                <span class="fw-bold text-black">${startIndex + index + 1}</span>
              </div>
            </td>
            <td>
              <span class="category-name">${category.name}</span>
            </td>
            <td>${category.description || 'No description'}</td>
            <td>
              ${renderOfferCell(category.categoryOffer)}
            </td>
            <td>
              <span class="status-badge ${category.isActive ? 'active' : 'inactive'}" data-status-badge>
                ${category.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="action-btn edit-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#editCategoryModal"
                  data-category-id="${category._id}"
                  data-category-name="${category.name}"
                  data-category-description="${category.description || ''}"
                  data-category-offer="${category.categoryOffer || 0}">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    ${category.isActive ? 'checked' : ''}
                    onchange="toggleCategory('${category._id}', this)"
                    data-toggle-input>
                  <span class="toggle-slider"></span>
                </label>
                <button
                  class="action-btn delete-btn"
                  onclick="deleteCategory('${category._id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        tableBody.innerHTML = rows;
      } else {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="no-data">
              <div class="no-data-content">
                <i class="bi bi-inbox"></i>
                <span>No categories found</span>
              </div>
            </td>
          </tr>
        `;
      }

      // Update pagination
      updatePagination({
        currentPage: data.currentPage,
        totalPages: data.totalPages
      });

      // Update URL without refresh
      const url = new URL(window.location.href);
      url.search = params.toString();
      window.history.pushState({}, '', url);

    } catch (error) {
      console.error('Error fetching categories:', error);
      Swal.fire('Error', 'Failed to load categories', 'error');
    }
  }

  // Event delegation for pagination buttons
  document.addEventListener('click', function(e) {
    if (e.target.closest('.pagination-btn')) {
      e.preventDefault();
      const btn = e.target.closest('.pagination-btn');
      const page = parseInt(btn.dataset.page);
      
      if (page && page > 0) {
        currentPage = page;
        fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
      }
    }
  });

  // Handle remove filter action
  async function handleRemoveFilter() {
    const btn = document.getElementById('remove-filter-btn');
    if (!btn) return;
    
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Removing...';
    btn.disabled = true;

    try {
      statusFilter.value = 'all';
      currentStatus = 'all';
      currentPage = 1;
      await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
      updateRemoveFilterButton('all');
    } catch (error) {
      console.error(error);
      btn.innerHTML = originalHTML;
      btn.disabled = false;
    }
  }

  // Search input change
  searchInput.addEventListener('input', toggleClearButton);

  // Search button handler
  searchBtn.addEventListener('click', async () => {
    currentQuery = searchInput.value.trim();
    currentPage = 1;
    await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
  });

  // Clear search button handler
  clearSearchBtn.addEventListener('click', async () => {
    searchInput.value = '';
    currentQuery = '';
    currentPage = 1;
    toggleClearButton();
    await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
  });

  // Automatically apply filter when dropdown changes
  statusFilter.addEventListener('change', async () => {
    const newStatus = statusFilter.value;
    currentStatus = newStatus;
    currentPage = 1;
    await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
    updateRemoveFilterButton(newStatus);
  });

  // Enter key to search
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchBtn.click();
    }
  });

  // ============ ADD CATEGORY FORM HANDLER ============
  const addCategoryForm = document.getElementById('addCategoryForm');
  const addCategoryModal = document.getElementById('addCategoryModal');

  if (addCategoryForm) {
    addCategoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = addCategoryForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Adding...';

      try {
        const formData = new FormData(addCategoryForm);
        const data = {
          name: formData.get('name'),
          description: formData.get('description'),
          categoryOffer: formData.get('categoryOffer')
        };

        const response = await fetch('/admin/categories/api', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          // Show success toast
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });

          Toast.fire({
            icon: 'success',
            title: result.message || 'Category created successfully'
          });

          // Close modal
          const modalInstance = bootstrap.Modal.getInstance(addCategoryModal);
          if (modalInstance) {
            modalInstance.hide();
          }

          // Reset form
          addCategoryForm.reset();

          // Refresh table - stay on current page
          await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
        } else {
          // Show error
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to create category'
          });
        }
      } catch (error) {
        console.error('Error creating category:', error);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: 'Failed to create category. Please try again.'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  }

  // ============ EDIT CATEGORY FORM HANDLER ============
  const editCategoryForm = document.getElementById('editCategoryForm');
  const editCategoryModal = document.getElementById('editCategoryModal');

  if (editCategoryForm) {
    editCategoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = editCategoryForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Saving...';

      try {
        const formData = new FormData(editCategoryForm);
        const categoryId = document.getElementById('editCategoryId').value;
        const data = {
          name: formData.get('name'),
          description: formData.get('description'),
          categoryOffer: formData.get('categoryOffer')
        };

        const response = await fetch(`/admin/categories/api/${categoryId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          // Show success toast
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });

          Toast.fire({
            icon: 'success',
            title: result.message || 'Category updated successfully'
          });

          // Close modal
          const modalInstance = bootstrap.Modal.getInstance(editCategoryModal);
          if (modalInstance) {
            modalInstance.hide();
          }

          // Refresh table - stay on current page
          await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
        } else {
          // Show error
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to update category'
          });
        }
      } catch (error) {
        console.error('Error updating category:', error);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: 'Failed to update category. Please try again.'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  }

  // Edit category modal populate
  const editModal = document.getElementById('editCategoryModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', (event) => {
      const button = event.relatedTarget;
      const categoryId = button.getAttribute('data-category-id');
      const categoryName = button.getAttribute('data-category-name');
      const categoryDescription = button.getAttribute('data-category-description');
      const categoryOffer = button.getAttribute('data-category-offer');

      document.getElementById('editCategoryId').value = categoryId;
      document.getElementById('editCategoryName').value = categoryName;
      document.getElementById('editCategoryDescription').value = categoryDescription;
      document.getElementById('editCategoryOffer').value = categoryOffer || 0;
    });
  }

  // Attach event listener to initial remove button if it exists
  const initialRemoveBtn = document.getElementById('remove-filter-btn');
  if (initialRemoveBtn) {
    initialRemoveBtn.addEventListener('click', handleRemoveFilter);
  }

  toggleClearButton();
});



// Toggle category status function with dynamic UI update
async function toggleCategory(categoryId, toggleElement) {
  const isChecked = toggleElement.checked;
  const row = toggleElement.closest('tr');
  const statusBadge = row.querySelector('[data-status-badge]');
  
  // Disable toggle during request
  toggleElement.disabled = true;

  try {
    const response = await fetch(`/admin/categories/api/${categoryId}/toggle`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      // Update status badge dynamically
      if (data.isActive) {
        statusBadge.textContent = 'Active';
        statusBadge.classList.remove('inactive');
        statusBadge.classList.add('active');
        toggleElement.checked = true;
      } else {
        statusBadge.textContent = 'Inactive';
        statusBadge.classList.remove('active');
        statusBadge.classList.add('inactive');
        toggleElement.checked = false;
      }

      // Show success toast
      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
      });

      Toast.fire({
        icon: 'success',
        title: data.message || `Category ${data.isActive ? 'activated' : 'deactivated'} successfully`
      });
    } else {
      // Revert toggle on error
      toggleElement.checked = !isChecked;
      Swal.fire('Error', data.message || 'Something went wrong.', 'error');
    }
  } catch (error) {
    console.error(error);
    // Revert toggle on error
    toggleElement.checked = !isChecked;
    Swal.fire('Server error', 'Please try again later.', 'error');
  } finally {
    // Re-enable toggle
    toggleElement.disabled = false;
  }
}

// Delete category function with confirmation
async function deleteCategory(categoryId) {
  const result = await Swal.fire({
    title: 'Delete Category?',
    text: 'Are you sure you want to remove this category? This action cannot be undone.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel'
  });

  if (!result.isConfirmed) return;

  try {
    const response = await fetch(`/admin/categories/api/${categoryId}/soft-delete`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      // Remove row with animation
      const row = document.querySelector(`tr[data-category-id="${categoryId}"]`);
      if (row) {
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';
        setTimeout(() => row.remove(), 300);
      }

      // Show success message
      await Swal.fire({
        icon: 'success',
        title: 'Deleted!',
        text: data.message || 'Category has been removed successfully.',
        timer: 2000,
        showConfirmButton: false
      });

      // Refresh the table to update numbering
      setTimeout(() => {
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        window.dispatchEvent(new CustomEvent('refresh-categories', {
          detail: {
            query: searchInput.value.trim(),
            status: statusFilter.value
          }
        }));
      }, 300);
    } else {
      Swal.fire('Error', data.message || 'Failed to delete category.', 'error');
    }
  } catch (error) {
    console.error(error);
    Swal.fire('Server error', 'Please try again later.', 'error');
  }
}

// Listen for refresh events
window.addEventListener('refresh-categories', async (e) => {
  const { query, status } = e.detail;
  const params = new URLSearchParams();
  if (query) params.append('q', query);
  if (status !== 'all') params.append('status', status);

  const response = await fetch(`/admin/categories/api?${params.toString()}`);
  const data = await response.json();

  if (data.totalRecords !== undefined) {
    document.getElementById('category-count').textContent = data.totalRecords;
  }
  
  // Render offer cell helper
  function renderOfferCell(categoryOffer) {
    if (categoryOffer && categoryOffer > 0) {
      return `<span class="offer-badge">${categoryOffer}%</span>`;
    } else {
      return `<span class="offer-none">None</span>`;
    }
  }
  
  const tableBody = document.getElementById('category-table-body');
  if (data.categories && data.categories.length > 0) {
    const rows = data.categories.map((category, index) => `
      <tr data-category-id="${category._id}">
        <td>
          <div class="row-number">
            <span class="fw-bold text-black">${index + 1}</span>
          </div>
        </td>
        <td>
          <span class="category-name">${category.name}</span>
        </td>
        <td>${category.description || 'No description'}</td>
        <td>
          ${renderOfferCell(category.categoryOffer)}
        </td>
        <td>
          <span class="status-badge ${category.isActive ? 'active' : 'inactive'}" data-status-badge>
            ${category.isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button
              class="action-btn edit-btn"
              data-bs-toggle="modal"
              data-bs-target="#editCategoryModal"
              data-category-id="${category._id}"
              data-category-name="${category.name}"
              data-category-description="${category.description || ''}"
              data-category-offer="${category.categoryOffer || 0}">
              <i class="bi bi-pencil-square"></i>
            </button>
            <label class="toggle-switch">
              <input 
                type="checkbox" 
                ${category.isActive ? 'checked' : ''}
                onchange="toggleCategory('${category._id}', this)"
                data-toggle-input>
              <span class="toggle-slider"></span>
            </label>
            <button
              class="action-btn delete-btn"
              onclick="deleteCategory('${category._id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
    tableBody.innerHTML = rows;
  } else {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" class="no-data">
          <div class="no-data-content">
            <i class="bi bi-inbox"></i>
            <span>No categories found</span>
          </div>
        </td>
      </tr>
    `;
  }
});
</script>
