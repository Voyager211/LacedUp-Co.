<!-- Include Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<style>
/* ========= CATEGORY MANAGEMENT SPECIFIC STYLES ========= */
.category-management-container {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
}

.page-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  color: white;
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.page-subtitle {
  color: rgba(255, 255, 255, 0.85);
  margin: 0.5rem 0 0 0;
}

.add-category-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  color: white;
  background-color: #ef4444;
}

.add-category-btn:hover {
  background-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Filters Card */
.filters-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.filters-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filters-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1rem;
  align-items: start;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.form-select, .form-control {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  transition: all 0.2s ease;
  background-color: white;
}

.form-control:focus, .form-select:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

/* Search Input with Icon Button */
.search-input-container {
  position: relative;
  display: flex;
}

.search-input-container .form-control {
  flex: 1;
  padding-right: 45px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.search-input-container .clear-btn {
  position: absolute;
  right: 45px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6c757d;
  font-size: 0.9rem;
  padding: 0.25rem;
  cursor: pointer;
  z-index: 3;
  transition: color 0.2s ease;
}

.search-input-container .clear-btn:hover {
  color: #e03a2f;
}

.search-input-container .search-btn {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  border-left: none;
  background-color: white;
  border: 1px solid #e5e7eb;
  color: #333;
  padding: 0.6rem 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.search-input-container .search-btn:hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
}

/* Filter Button Container */
.filter-button-container {
  display: flex;
  justify-content: flex-end;
  margin-top: 0.5rem;
  min-height: 38px;
}

/* Remove Filter Button */
.remove-filter-btn {
  padding: 0.6rem 1.25rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  width: auto;
  background-color: #ef4444;
  color: white;
}

.remove-filter-btn:hover {
  background-color: #dc2626;
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.remove-filter-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* Modern Table Wrapper */
.table-wrapper {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  overflow-x: auto;
}

.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem;
}

.modern-table thead th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.5px;
  padding: 1.25rem 1rem;
  border-bottom: 2px solid #e9ecef;
  text-align: left;
}

.modern-table tbody td {
  padding: 1.5rem 1rem;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.modern-table tbody tr {
  transition: all 0.2s ease;
  height: auto;
}

.modern-table tbody tr:nth-child(even) {
  background-color: #f9fafb;
}

.modern-table tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Row Number Styling */
.row-number {
  text-align: center;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 70px;
  font-weight: 700;
  color: #6c757d;
}

/* Category Name Cell */
.category-name {
  font-weight: 600;
  color: #111827;
  font-size: 1rem;
}

/* Status Badge */
.status-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.875rem;
  transition: all 0.3s ease;
}

.status-badge.active {
  background-color: #d1fae5;
  color: #065f46;
}

.status-badge.inactive {
  background-color: #fee2e2;
  color: #991b1b;
}

/* Offer Badge */
.offer-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 6px;
  font-weight: 700;
  font-size: 0.875rem;
  background-color: #fbbf24;
  color: #000000;
}

.offer-none {
  font-style: italic;
  color: #9ca3af;
  font-size: 0.875rem;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.action-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.875rem;
}

.edit-btn {
  background-color: #3b82f6;
  color: white;
}

.edit-btn:hover {
  background-color: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.delete-btn {
  background-color: #ef4444;
  color: white;
}

.delete-btn:hover {
  background-color: #dc2626;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 28px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #cbd5e1;
  transition: 0.3s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch input:checked + .toggle-slider {
  background-color: #10b981;
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

.toggle-switch input:disabled + .toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}

/* No Data */
.no-data {
  text-align: center;
  padding: 3rem 1rem;
  color: #6b7280;
}

.no-data-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  font-size: 1.1rem;
}

.no-data-content i {
  font-size: 3rem;
  color: #e5e7eb;
}

/* ========= IMAGE UPLOAD STYLES ========= */
.image-upload-section {
  margin-top: 1rem;
}

.category-image-preview {
  position: relative;
  width: 200px;
  height: 200px;
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  background: #f8f9fa;
}

.category-image-preview:hover {
  border-color: #e03a2f;
  background: #fff5f5;
}

.category-image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-placeholder-content {
  text-align: center;
  color: #6c757d;
}

.image-placeholder-content i {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  display: block;
}

.btn-remove-image {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #dc3545, #bb2d3b);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.btn-remove-image:hover {
  background: linear-gradient(135deg, #bb2d3b, #a02834);
  transform: scale(1.1) rotate(90deg);
}

.btn-crop-image {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #6f42c1, #5a2d91);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  font-size: 16px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.btn-crop-image:hover {
  background: linear-gradient(135deg, #5a2d91, #4c2577);
  transform: scale(1.1);
}

/* ========= CROPPER MODAL ========= */
.cropper-modal-custom {
  max-width: 900px;
  width: 95vw;
}

.cropper-modal-content {
  height: 600px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
}

.cropper-modal-content .modal-header {
  flex-shrink: 0;
  height: 60px;
  display: flex;
  align-items: center;
}

.cropper-modal-content .modal-footer {
  flex-shrink: 0;
  height: 70px;
  display: flex;
  align-items: center;
}

.cropper-modal-content .modal-body {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 0;
}

.cropper-image-container {
  width: 100%;
  height: 100%;
  position: relative;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cropper-image-container img {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

/* Cropper.js customization */
.cropper-view-box {
  outline: 2px solid rgba(224, 58, 47, 0.8);
}

.cropper-point {
  width: 10px !important;
  height: 10px !important;
  background-color: #E03A2F !important;
  border: 2px solid #fff !important;
  border-radius: 50% !important;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
}

.cropper-line {
  background-color: #E03A2F !important;
  opacity: 0.7 !important;
}

/* Responsive */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .add-category-btn {
    width: 100%;
    justify-content: center;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }

  .filter-button-container {
    justify-content: stretch;
  }

  .remove-filter-btn {
    width: 100%;
    justify-content: center;
  }

  .action-buttons {
    flex-wrap: wrap;
  }

  .action-btn {
    flex: 1;
    justify-content: center;
  }

  .category-image-preview {
    width: 150px;
    height: 150px;
  }
}

/* Loading Animation */
.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ========= PAGINATION STYLES ========= */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 2rem;
  margin-bottom: 2rem;
}

.pagination {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  list-style: none;
  margin: 0;
  padding: 0;
}

.page-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  padding: 8px 12px;
  border: 1px solid #dee2e6;
  background-color: white;
  color: #333;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
  font-size: 0.9rem;
}

.page-btn:not(:disabled):not(.active):hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(224, 58, 47, 0.2);
}

.page-btn.active {
  background-color: #1a1a1a;
  border-color: #1a1a1a;
  color: white;
  font-weight: 600;
}

.page-btn:disabled {
  color: #6c757d;
  background-color: #f8f9fa;
  border-color: #dee2e6;
  cursor: not-allowed;
  opacity: 0.6;
}

@media (max-width: 576px) {
  .page-btn {
    min-width: 35px;
    height: 35px;
    padding: 6px 8px;
    font-size: 0.8rem;
  }

  .pagination {
    gap: 0.25rem;
  }
}

</style>

<div class="category-management-container">
  <!-- Breadcrumbs -->
  <%- include('./partials/breadcrumbs', {
    breadcrumbs: [
      { label: 'Dashboard', url: '/admin/dashboard', icon: 'house-door' },
      { label: 'Categories', icon: 'grid-3x3-gap' }
    ]
  }) %>

  <!-- Page Header --> 
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          Category Management (<span id="category-count"><%= typeof totalRecords !== 'undefined' ? totalRecords : categories.length %></span>)
        </h1>
        <p class="page-subtitle">Organize and manage product categories</p>
      </div>
      <div class="header-right">
        <button 
          type="button" 
          class="add-category-btn" 
          data-bs-toggle="modal" 
          data-bs-target="#addCategoryModal">
          <i class="bi bi-plus-circle"></i>
          <span>Add Category</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <h3 class="filters-title">
      <i class="bi bi-funnel"></i>
      Filter Options
    </h3>
    <div class="filters-grid">
      <!-- Search Group -->
      <div class="filter-group">
        <label class="filter-label">Search Categories</label>
        <div class="search-input-container">
          <input 
            type="text" 
            class="form-control"
            id="search-input"
            placeholder="Search by category name"
            value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          >
          <button type="button" id="clear-search" class="clear-btn <%= typeof searchQuery === 'undefined' || !searchQuery ? 'd-none' : '' %>">
            <i class="bi bi-x-lg"></i>
          </button>
          <button class="search-btn" type="button" id="search-btn">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Status Filter Group -->
      <div class="filter-group">
        <label class="filter-label">Status Filter</label>
        <select class="form-select" id="status-filter">
          <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Categories</option>
          <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Active</option>
          <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Inactive</option>
        </select>
        <div class="filter-button-container">
          <% if (statusFilter !== 'all') { %>
            <button type="button" class="remove-filter-btn" id="remove-filter-btn">
              <i class="bi bi-x-circle"></i>
              Remove Filters
            </button>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    <table class="modern-table">
      <thead>
        <tr>
          <th style="width: 5%;">#</th>
          <th style="width: 20%;">Name</th>
          <th style="width: 30%;">Description</th>
          <th style="width: 10%;">Offer</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 25%;">Actions</th>
        </tr>
      </thead>
      <tbody id="category-table-body">
        <% if (categories && categories.length > 0) { %>
          <% 
            const limit = 10;
            const page = typeof currentPage !== 'undefined' ? currentPage : 1;
            const startIndex = (page - 1) * limit;
          %>
          <% categories.forEach((category, index) => { %>
            <tr data-category-id="<%= category._id %>">
              <td>
                <div class="row-number">
                  <span class="fw-bold text-black"><%= startIndex + index + 1 %></span>
                </div>
              </td>
              <td>
                <span class="category-name"><%= category.name %></span>
              </td>
              <td><%= category.description || 'No description' %></td>
              <td>
                <% if (category.categoryOffer && category.categoryOffer > 0) { %>
                  <span class="offer-badge"><%= category.categoryOffer %>% OFF</span>
                <% } else { %>
                  <span class="offer-none">No offer</span>
                <% } %>
              </td>
              <td>
                <span class="status-badge <%= category.isActive ? 'active' : 'inactive' %>" data-status-badge>
                  <%= category.isActive ? 'Active' : 'Inactive' %>
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    class="action-btn edit-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#editCategoryModal"
                    data-category-id="<%= category._id %>"
                    data-category-name="<%= category.name %>"
                    data-category-description="<%= category.description || '' %>"
                    data-category-offer="<%= category.categoryOffer || 0 %>"
                    data-category-image="<%= category.image || '' %>">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <label class="toggle-switch">
                    <input 
                      type="checkbox" 
                      <%= category.isActive ? 'checked' : '' %>
                      onchange="toggleCategory('<%= category._id %>', this)"
                      data-toggle-input>
                    <span class="toggle-slider"></span>
                  </label>
                  <button
                    class="action-btn delete-btn"
                    onclick="deleteCategory('<%= category._id %>')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="6" class="no-data">
              <div class="no-data-content">
                <i class="bi bi-inbox"></i>
                <span>No categories found</span>
              </div>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
    <div class="pagination-wrapper">
      <div class="pagination">
        <button 
          class="page-btn pagination-btn" 
          data-page="<%= currentPage - 1 %>"
          <%= currentPage === 1 ? 'disabled' : '' %>>
          <i class="bi bi-chevron-left"></i>
        </button>

        <% 
          let startPage = Math.max(1, currentPage - 2);
          let endPage = Math.min(totalPages, currentPage + 2);
          
          if (currentPage <= 3) {
            endPage = Math.min(5, totalPages);
          }
          if (currentPage > totalPages - 3) {
            startPage = Math.max(1, totalPages - 4);
          }
        %>

        <% if (startPage > 1) { %>
          <button class="page-btn pagination-btn" data-page="1">1</button>
          <% if (startPage > 2) { %>
            <span class="px-2">...</span>
          <% } %>
        <% } %>

        <% for (let i = startPage; i <= endPage; i++) { %>
          <button 
            class="page-btn pagination-btn <%= i === currentPage ? 'active' : '' %>" 
            data-page="<%= i %>">
            <%= i %>
          </button>
        <% } %>

        <% if (endPage < totalPages) { %>
          <% if (endPage < totalPages - 1) { %>
            <span class="px-2">...</span>
          <% } %>
          <button class="page-btn pagination-btn" data-page="<%= totalPages %>"><%= totalPages %></button>
        <% } %>

        <button 
          class="page-btn pagination-btn" 
          data-page="<%= currentPage + 1 %>"
          <%= currentPage === totalPages ? 'disabled' : '' %>>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  <% } %>

</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCategoryModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Add New Category
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-category-form">
          <div class="mb-3">
            <label for="add-category-name" class="form-label">Category Name *</label>
            <input type="text" class="form-control" id="add-category-name" required>
          </div>
          <div class="mb-3">
            <label for="add-category-description" class="form-label">Description</label>
            <textarea class="form-control" id="add-category-description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="add-category-offer" class="form-label">Category Offer (%)</label>
            <input type="number" class="form-control" id="add-category-offer" min="0" max="100" value="0">
            <small class="text-muted">Enter a value between 0 and 100</small>
          </div>
          
          <!-- Image Upload Section -->
          <div class="image-upload-section">
            <label class="form-label">Category Image (Optional)</label>
            <input type="file" id="add-category-image-input" accept="image/*" class="d-none">
            <div class="category-image-preview" id="add-image-preview" onclick="document.getElementById('add-category-image-input').click()">
              <div class="image-placeholder-content">
                <i class="bi bi-image"></i>
                <div>Click to upload</div>
                <small class="text-muted">800x800 recommended</small>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="add-category-submit">
          <i class="bi bi-save me-1"></i> Add Category
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCategoryModalLabel">
          <i class="bi bi-pencil-square me-2"></i>Edit Category
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-category-form">
          <input type="hidden" id="edit-category-id">
          <div class="mb-3">
            <label for="edit-category-name" class="form-label">Category Name *</label>
            <input type="text" class="form-control" id="edit-category-name" required>
          </div>
          <div class="mb-3">
            <label for="edit-category-description" class="form-label">Description</label>
            <textarea class="form-control" id="edit-category-description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="edit-category-offer" class="form-label">Category Offer (%)</label>
            <input type="number" class="form-control" id="edit-category-offer" min="0" max="100">
            <small class="text-muted">Enter a value between 0 and 100</small>
          </div>
          
          <!-- Image Upload Section -->
          <div class="image-upload-section">
            <label class="form-label">Category Image</label>
            <input type="file" id="edit-category-image-input" accept="image/*" class="d-none">
            <div class="category-image-preview" id="edit-image-preview" onclick="document.getElementById('edit-category-image-input').click()">
              <div class="image-placeholder-content">
                <i class="bi bi-image"></i>
                <div>Click to upload</div>
                <small class="text-muted">800x800 recommended</small>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="edit-category-submit">
          <i class="bi bi-save me-1"></i> Update Category
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg cropper-modal-custom">
    <div class="modal-content cropper-modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-crop me-2"></i>Crop Image
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="cropper-image-container">
          <img id="cropper-image" src="" alt="Crop">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="crop-and-save">
          <i class="bi bi-check-lg me-1"></i> Crop & Save
        </button>
      </div>
    </div>
  </div>
</div>



<!-- Include Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="/utils/imageValidation.js"></script>

<script>
// ========= GLOBAL VARIABLES =========
let currentQuery = '<%= typeof searchQuery !== "undefined" ? searchQuery : "" %>';
let currentStatus = '<%= typeof statusFilter !== "undefined" ? statusFilter : "all" %>';
let currentPage = <%= typeof currentPage !== 'undefined' ? currentPage : 1 %>;
let cropper = null;
let currentImageMode = 'add'; // 'add' or 'edit'
let currentBase64Image = '';

// DOM Elements
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const clearSearchBtn = document.getElementById('clear-search');
const statusFilter = document.getElementById('status-filter');
const tableBody = document.getElementById('category-table-body');

// ========= IMAGE UPLOAD HANDLERS =========
const addImageInput = document.getElementById('add-category-image-input');
const addImagePreview = document.getElementById('add-image-preview');
const editImageInput = document.getElementById('edit-category-image-input');
const editImagePreview = document.getElementById('edit-image-preview');

let addCategoryBase64 = '';
let editCategoryBase64 = '';

// Add Category Image Handler
addImageInput.addEventListener('change', function(e) {
  handleImageSelection(e, 'add');
});

// Edit Category Image Handler
editImageInput.addEventListener('change', function(e) {
  handleImageSelection(e, 'edit');
});

// Handle image selection and validation
function handleImageSelection(e, mode) {
  const file = e.target.files[0];
  if (!file) return;

  // Validate image
  const validation = window.ImageValidator.validateImageFile(file);
  if (!validation.isValid) {
    Swal.fire({
      icon: 'error',
      title: 'Invalid Image',
      text: validation.message,
      confirmButtonColor: '#dc3545'
    });
    e.target.value = ''; // Clear input
    return;
  }

  // Read and display image
  const reader = new FileReader();
  reader.onload = function(event) {
    currentImageMode = mode;
    showCropperModal(event.target.result);
  };
  reader.readAsDataURL(file);
}

// Show cropper modal
function showCropperModal(imageDataUrl) {
  const cropperImage = document.getElementById('cropper-image');
  const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
  
  cropperImage.src = imageDataUrl;
  cropperModal.show();
  
  // Initialize cropper after modal is shown
  document.getElementById('cropperModal').addEventListener('shown.bs.modal', function() {
    if (cropper) {
      cropper.destroy();
    }
    
    cropper = new Cropper(cropperImage, {
      aspectRatio: 1,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 1,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
    });
  }, { once: true });
}

// Crop and save button handler
document.getElementById('crop-and-save').addEventListener('click', function() {
  if (!cropper) return;
  
  // Get cropped canvas
  const canvas = cropper.getCroppedCanvas({
    width: 800,
    height: 800,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: 'high',
  });
  
  // Convert to base64
  const base64Image = canvas.toDataURL('image/webp', 0.9);
  
  // Store base64 based on mode
  if (currentImageMode === 'add') {
    addCategoryBase64 = base64Image;
    displayImagePreview(addImagePreview, base64Image, 'add');
  } else {
    editCategoryBase64 = base64Image;
    displayImagePreview(editImagePreview, base64Image, 'edit');
  }
  
  // Close modal
  bootstrap.Modal.getInstance(document.getElementById('cropperModal')).hide();
  
  // Cleanup
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
});

// Display image preview
function displayImagePreview(previewElement, base64Image, mode) {
  previewElement.innerHTML = `
    <img src="${base64Image}" alt="Category Image">
    <button type="button" class="btn-remove-image" onclick="removeImage('${mode}')">
      <i class="bi bi-x"></i>
    </button>
    <button type="button" class="btn-crop-image" onclick="recropImage('${mode}')">
      <i class="bi bi-crop"></i>
    </button>
  `;
  previewElement.onclick = null; // Remove click handler when image is present
}

// Remove image
function removeImage(mode) {
  if (mode === 'add') {
    addCategoryBase64 = '';
    addImagePreview.innerHTML = `
      <div class="image-placeholder-content">
        <i class="bi bi-image"></i>
        <div>Click to upload</div>
        <small class="text-muted">800x800 recommended</small>
      </div>
    `;
    addImagePreview.onclick = () => addImageInput.click();
    addImageInput.value = '';
  } else {
    editCategoryBase64 = '';
    editImagePreview.innerHTML = `
      <div class="image-placeholder-content">
        <i class="bi bi-image"></i>
        <div>Click to upload</div>
        <small class="text-muted">800x800 recommended</small>
      </div>
    `;
    editImagePreview.onclick = () => editImageInput.click();
    editImageInput.value = '';
  }
}

// Recrop image
function recropImage(mode) {
  const base64 = mode === 'add' ? addCategoryBase64 : editCategoryBase64;
  if (base64) {
    currentImageMode = mode;
    showCropperModal(base64);
  }
}

// ========= UTILITY FUNCTIONS =========
function toggleClearButton() {
  if (searchInput.value.trim()) {
    clearSearchBtn.classList.remove('d-none');
  } else {
    clearSearchBtn.classList.add('d-none');
  }
}

function updateRemoveFilterButton(status) {
  const container = document.querySelector('.filter-button-container');
  if (status === 'all') {
    container.innerHTML = '';
  } else {
    container.innerHTML = `
      <button type="button" class="remove-filter-btn" id="remove-filter-btn">
        <i class="bi bi-x-circle"></i>
        Remove Filters
      </button>
    `;
    
    const newBtn = document.getElementById('remove-filter-btn');
    if (newBtn) {
      newBtn.addEventListener('click', handleRemoveFilter);
    }
  }
}

function renderOfferCell(offer) {
  if (offer && offer > 0) {
    return `<span class="offer-badge">${offer}% OFF</span>`;
  } else {
    return `<span class="offer-none">No offer</span>`;
  }
}

function updatePagination(data) {
  const paginationWrapper = document.querySelector('.pagination-wrapper');
  if (!paginationWrapper) return;

  if (data.totalPages <= 1) {
    paginationWrapper.style.display = 'none';
    return;
  }

  paginationWrapper.style.display = 'flex';
  
  let startPage = Math.max(1, data.currentPage - 2);
  let endPage = Math.min(data.totalPages, data.currentPage + 2);
  
  if (data.currentPage <= 3) {
    endPage = Math.min(5, data.totalPages);
  }
  if (data.currentPage > data.totalPages - 3) {
    startPage = Math.max(1, data.totalPages - 4);
  }

  let paginationHTML = `
    <div class="pagination">
      <button class="page-btn pagination-btn" data-page="${data.currentPage - 1}" ${data.currentPage === 1 ? 'disabled' : ''}>
        <i class="bi bi-chevron-left"></i>
      </button>
  `;

  if (startPage > 1) {
    paginationHTML += `<button class="page-btn pagination-btn" data-page="1">1</button>`;
    if (startPage > 2) {
      paginationHTML += `<span class="px-2">...</span>`;
    }
  }

  for (let i = startPage; i <= endPage; i++) {
    paginationHTML += `
      <button class="page-btn pagination-btn ${i === data.currentPage ? 'active' : ''}" data-page="${i}">
        ${i}
      </button>
    `;
  }

  if (endPage < data.totalPages) {
    if (endPage < data.totalPages - 1) {
      paginationHTML += `<span class="px-2">...</span>`;
    }
    paginationHTML += `<button class="page-btn pagination-btn" data-page="${data.totalPages}">${data.totalPages}</button>`;
  }

  paginationHTML += `
      <button class="page-btn pagination-btn" data-page="${data.currentPage + 1}" ${data.currentPage === data.totalPages ? 'disabled' : ''}>
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  `;

  paginationWrapper.innerHTML = paginationHTML;
}

// ========= API FUNCTIONS =========
async function fetchAndRenderCategories(query = '', status = 'all', page = 1) {
  try {
    const params = new URLSearchParams({
      q: query,
      status: status,
      page: page
    });

    const response = await fetch(`/admin/categories/api?${params.toString()}`);
    const data = await response.json();

    // Update category count
    if (data.totalRecords !== undefined) {
      document.getElementById('category-count').textContent = data.totalRecords;
    }

    // Render table rows
    if (data.categories && data.categories.length > 0) {
      const startIndex = (page - 1) * 10;
      const rows = data.categories.map((category, index) => `
        <tr data-category-id="${category._id}">
          <td>
            <div class="row-number">
              <span class="fw-bold text-black">${startIndex + index + 1}</span>
            </div>
          </td>
          <td>
            <span class="category-name">${category.name}</span>
          </td>
          <td>${category.description || 'No description'}</td>
          <td>
            ${renderOfferCell(category.categoryOffer)}
          </td>
          <td>
            <span class="status-badge ${category.isActive ? 'active' : 'inactive'}" data-status-badge>
              ${category.isActive ? 'Active' : 'Inactive'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button
                class="action-btn edit-btn"
                data-bs-toggle="modal"
                data-bs-target="#editCategoryModal"
                data-category-id="${category._id}"
                data-category-name="${category.name}"
                data-category-description="${category.description || ''}"
                data-category-offer="${category.categoryOffer || 0}"
                data-category-image="${category.image || ''}">
                <i class="bi bi-pencil-square"></i>
              </button>
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${category.isActive ? 'checked' : ''}
                  onchange="toggleCategory('${category._id}', this)"
                  data-toggle-input>
                <span class="toggle-slider"></span>
              </label>
              <button
                class="action-btn delete-btn"
                onclick="deleteCategory('${category._id}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      tableBody.innerHTML = rows;
    } else {
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="no-data">
            <div class="no-data-content">
              <i class="bi bi-inbox"></i>
              <span>No categories found</span>
            </div>
          </td>
        </tr>
      `;
    }

    // Update pagination
    updatePagination({
      currentPage: data.currentPage,
      totalPages: data.totalPages
    });

    // Update URL without refresh
    const url = new URL(window.location.href);
    url.search = params.toString();
    window.history.pushState({}, '', url);

  } catch (error) {
    console.error('Error fetching categories:', error);
    Swal.fire('Error', 'Failed to load categories', 'error');
  }
}

// ========= CATEGORY CRUD OPERATIONS =========

// Add Category
document.getElementById('add-category-submit').addEventListener('click', async function() {
  const name = document.getElementById('add-category-name').value.trim();
  const description = document.getElementById('add-category-description').value.trim();
  const offer = document.getElementById('add-category-offer').value;

  if (!name) {
    Swal.fire({
      icon: 'warning',
      title: 'Missing Information',
      text: 'Please enter a category name',
      confirmButtonColor: '#dc3545'
    });
    return;
  }

  const btn = this;
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner me-1"></i> Adding...';
  btn.disabled = true;

  try {
    const response = await fetch('/admin/categories/api/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        description,
        categoryOffer: offer,
        base64Image: addCategoryBase64
      })
    });

    const data = await response.json();

    if (data.success) {
      await Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: 'Category added successfully',
        confirmButtonColor: '#198754'
      });

      bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
      document.getElementById('add-category-form').reset();
      removeImage('add');
      await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
    } else {
      throw new Error(data.message || 'Failed to add category');
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: error.message || 'Failed to add category',
      confirmButtonColor: '#dc3545'
    });
  } finally {
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }
});

// Edit Category Modal Population
document.getElementById('editCategoryModal').addEventListener('show.bs.modal', function(event) {
  const button = event.relatedTarget;
  const id = button.getAttribute('data-category-id');
  const name = button.getAttribute('data-category-name');
  const description = button.getAttribute('data-category-description');
  const offer = button.getAttribute('data-category-offer');
  const image = button.getAttribute('data-category-image');

  document.getElementById('edit-category-id').value = id;
  document.getElementById('edit-category-name').value = name;
  document.getElementById('edit-category-description').value = description;
  document.getElementById('edit-category-offer').value = offer;

  // Display existing image if available
  if (image) {
    editCategoryBase64 = ''; // Clear any previous base64
    editImagePreview.innerHTML = `
      <img src="${image}" alt="Category Image">
      <button type="button" class="btn-remove-image" onclick="removeImage('edit')">
        <i class="bi bi-x"></i>
      </button>
      <button type="button" class="btn-crop-image" onclick="document.getElementById('edit-category-image-input').click()">
        <i class="bi bi-crop"></i>
      </button>
    `;
    editImagePreview.onclick = null;
  } else {
    removeImage('edit');
  }
});

// Update Category
document.getElementById('edit-category-submit').addEventListener('click', async function() {
  const id = document.getElementById('edit-category-id').value;
  const name = document.getElementById('edit-category-name').value.trim();
  const description = document.getElementById('edit-category-description').value.trim();
  const offer = document.getElementById('edit-category-offer').value;

  if (!name) {
    Swal.fire({
      icon: 'warning',
      title: 'Missing Information',
      text: 'Please enter a category name',
      confirmButtonColor: '#dc3545'
    });
    return;
  }

  const btn = this;
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner me-1"></i> Updating...';
  btn.disabled = true;

  try {
    const response = await fetch(`/admin/categories/api/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        description,
        categoryOffer: offer,
        base64Image: editCategoryBase64
      })
    });

    const data = await response.json();

    if (data.success) {
      await Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: 'Category updated successfully',
        confirmButtonColor: '#198754'
      });

      bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
      await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
    } else {
      throw new Error(data.message || 'Failed to update category');
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: error.message || 'Failed to update category',
      confirmButtonColor: '#dc3545'
    });
  } finally {
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }
});

// Toggle Category Status
async function toggleCategory(id, checkbox) {
  const originalState = checkbox.checked;
  
  try {
    const response = await fetch(`/admin/categories/api/${id}/toggle`, {
      method: 'PATCH'
    });

    const data = await response.json();

    if (!data.success) {
      checkbox.checked = !originalState;
      throw new Error(data.message || 'Failed to toggle status');
    }

    const row = checkbox.closest('tr');
    const statusBadge = row.querySelector('[data-status-badge]');
    
    if (data.isActive) {
      statusBadge.textContent = 'Active';
      statusBadge.classList.remove('inactive');
      statusBadge.classList.add('active');
    } else {
      statusBadge.textContent = 'Inactive';
      statusBadge.classList.remove('active');
      statusBadge.classList.add('inactive');
    }

  } catch (error) {
    checkbox.checked = !originalState;
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: error.message || 'Failed to toggle status',
      confirmButtonColor: '#dc3545'
    });
  }
}

// Delete Category
async function deleteCategory(id) {
  const result = await Swal.fire({
    title: 'Delete Category?',
    text: 'This action cannot be undone',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, delete it'
  });

  if (!result.isConfirmed) return;

  try {
    const response = await fetch(`/admin/categories/api/${id}`, {
      method: 'DELETE'
    });

    const data = await response.json();

    if (data.success) {
      await Swal.fire({
        icon: 'success',
        title: 'Deleted!',
        text: 'Category has been deleted',
        confirmButtonColor: '#198754'
      });

      await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
    } else {
      throw new Error(data.message || 'Failed to delete category');
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: error.message || 'Failed to delete category',
      confirmButtonColor: '#dc3545'
    });
  }
}

// ========= EVENT LISTENERS =========

// Search input change
searchInput.addEventListener('input', toggleClearButton);

// Search button handler
searchBtn.addEventListener('click', async () => {
  currentQuery = searchInput.value.trim();
  currentPage = 1;
  await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
});

// Enter key in search
searchInput.addEventListener('keypress', async (e) => {
  if (e.key === 'Enter') {
    currentQuery = searchInput.value.trim();
    currentPage = 1;
    await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
  }
});

// Clear search
clearSearchBtn.addEventListener('click', async () => {
  searchInput.value = '';
  currentQuery = '';
  currentPage = 1;
  clearSearchBtn.classList.add('d-none');
  await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
});

// Status filter change
statusFilter.addEventListener('change', async () => {
  currentStatus = statusFilter.value;
  currentPage = 1;
  await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
  updateRemoveFilterButton(currentStatus);
});

// Pagination button clicks
document.addEventListener('click', function(e) {
  if (e.target.closest('.pagination-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.pagination-btn');
    const page = parseInt(btn.dataset.page);
    
    if (page && page > 0) {
      currentPage = page;
      fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
    }
  }
});

// Remove filter button
async function handleRemoveFilter() {
  const btn = document.getElementById('remove-filter-btn');
  if (!btn) return;
  
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spinner"></i> Removing...';
  btn.disabled = true;

  try {
    statusFilter.value = 'all';
    currentStatus = 'all';
    currentPage = 1;
    await fetchAndRenderCategories(currentQuery, currentStatus, currentPage);
    updateRemoveFilterButton('all');
  } catch (error) {
    console.error(error);
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }
}

// Clean up cropper when modals are hidden
document.getElementById('cropperModal').addEventListener('hidden.bs.modal', function() {
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
});

// Reset add modal when closed
document.getElementById('addCategoryModal').addEventListener('hidden.bs.modal', function() {
  document.getElementById('add-category-form').reset();
  removeImage('add');
});
</script>

