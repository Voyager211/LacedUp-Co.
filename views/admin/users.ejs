<style>
/* ========= USER MANAGEMENT SPECIFIC STYLES ========= */
.user-management-container {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
}

.page-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  color: white;
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.page-subtitle {
  color: rgba(255, 255, 255, 0.85);
  margin: 0.5rem 0 0 0;
}

/* Filters Card */
.filters-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  align-items: start;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.form-select, .form-control {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  transition: all 0.2s ease;
  background-color: white;
}

.form-control:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

/* Search Input with Icon Button */
.search-input-container {
  position: relative;
  display: flex;
}

.search-input-container .form-control {
  padding-right: 45px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.search-input-container .clear-btn {
  position: absolute;
  right: 45px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6c757d;
  font-size: 0.9rem;
  padding: 0.25rem;
  cursor: pointer;
  z-index: 3;
  transition: color 0.2s ease;
}

.search-input-container .clear-btn:hover {
  color: #e03a2f;
}

.search-input-container .search-btn {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  border-left: none;
  background-color: white;
  border: 1px solid #e5e7eb;
  color: #333;
  padding: 0.6rem 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.search-input-container .search-btn:hover {
  background-color: #e03a2f;
  border-color: #e03a2f;
  color: white;
}

/* Filter Button Container */
.filter-button-container {
  display: flex;
  justify-content: flex-end;
  margin-top: 0.5rem;
  min-height: 38px;
}

/* Remove Filter Button */
.remove-filter-btn {
  padding: 0.6rem 1.25rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  width: auto;
  background-color: #ef4444;
  color: white;
}

.remove-filter-btn:hover {
  background-color: #dc2626;
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.remove-filter-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* Avatar styling */
.avatar-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.1rem;
}

/* Modern Table */
.table-wrapper {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem;
}

.modern-table thead th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.5px;
  padding: 1rem;
  border-bottom: 2px solid #e9ecef;
  text-align: left;
}

.modern-table tbody td {
  padding: 1rem;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.modern-table tbody tr {
  transition: all 0.2s ease;
}

.modern-table tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* Responsive */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }

  .filter-button-container {
    justify-content: stretch;
  }

  .remove-filter-btn {
    width: 100%;
    justify-content: center;
  }
}
</style>

<div class="user-management-container">
  <!-- Breadcrumbs -->
  <%- include('./partials/breadcrumbs', {
    breadcrumbs: [
      { label: 'Dashboard', url: '/admin/dashboard', icon: 'house-door' },
      { label: 'User Management', icon: 'people' }
    ]
  }) %>

  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">User Management (<%= totalUserCount %>)</h1>
        <p class="page-subtitle">Manage and monitor all registered users</p>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <div class="filters-grid">
      <!-- Search Group -->
      <div class="filter-group">
        <label class="filter-label">Search Users</label>
        <div class="search-input-container">
          <input 
            type="text" 
            class="form-control"
            id="search-input"
            placeholder="Search by name, email, or phone"
            value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          >
          <button type="button" id="clear-search" class="clear-btn <%= typeof searchQuery === 'undefined' || !searchQuery ? 'd-none' : '' %>">
            <i class="bi bi-x-lg"></i>
          </button>
          <button class="search-btn" type="button" id="search-btn">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Status Filter Group -->
      <div class="filter-group">
        <label class="filter-label">Status Filter</label>
        <select class="form-select" id="status-filter">
          <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Users</option>
          <option value="unblocked" <%= statusFilter === 'unblocked' ? 'selected' : '' %>>Active</option>
          <option value="blocked" <%= statusFilter === 'blocked' ? 'selected' : '' %>>Blocked</option>
        </select>
        <div class="filter-button-container">
          <% if (statusFilter !== 'all') { %>
            <button type="button" class="remove-filter-btn" id="remove-filter-btn">
              <i class="bi bi-x-circle"></i>
              Remove Filters
            </button>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-wrapper">
    <table class="modern-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Customer</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Join Date</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="user-table-body">
        <!-- Dynamic rows will be injected here -->
      </tbody>
    </table>

    <!-- Pagination -->
    <div id="pagination-wrapper">
      <%- include('partials/pagination', { currentPage, totalPages }) %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const tableBody = document.getElementById('user-table-body');
    const searchBtn = document.getElementById('search-btn');
    const clearSearchBtn = document.getElementById('clear-search');
    const filterButtonContainer = document.querySelector('.filter-button-container');

    let currentQuery = searchInput.value;
    let currentStatus = statusFilter.value;

    // Toggle clear button visibility
    function toggleClearButton() {
      if (searchInput.value.trim()) {
        clearSearchBtn.classList.remove('d-none');
      } else {
        clearSearchBtn.classList.add('d-none');
      }
    }

    // Update remove filter button visibility
    function updateRemoveFilterButton(status) {
      if (status === 'all') {
        filterButtonContainer.innerHTML = '';
      } else {
        filterButtonContainer.innerHTML = `
          <button type="button" class="remove-filter-btn" id="remove-filter-btn">
            <i class="bi bi-x-circle"></i>
            Remove Filters
          </button>
        `;
        
        // Reattach event listener to newly created button
        const removeBtn = document.getElementById('remove-filter-btn');
        if (removeBtn) {
          removeBtn.addEventListener('click', handleRemoveFilter);
        }
      }
    }

    // Handle remove filter action
    async function handleRemoveFilter() {
      const btn = document.getElementById('remove-filter-btn');
      if (!btn) return;
      
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spin"></i> Removing...';
      btn.disabled = true;

      try {
        statusFilter.value = 'all';
        currentStatus = 'all';
        await fetchAndRenderUsers(currentQuery, currentStatus);
        updateRemoveFilterButton('all');
      } finally {
        // Button will be removed by updateRemoveFilterButton, so no need to restore
      }
    }

    async function fetchAndRenderUsers(query = '', status = 'all', page = 1) {
      const res = await fetch(`/admin/users/api?q=${encodeURIComponent(query)}&status=${status}&page=${page}`);
      const data = await res.json();

      const rows = data.users.map((user, index) => `
        <tr>
          <td>${index + 1 + ((data.currentPage - 1) * 10)}</td>
          <td class="d-flex align-items-center gap-2">
            <div class="avatar-circle">${user.name ? user.name[0].toUpperCase() : 'U'}</div>
            <span>${user.name || 'Unnamed'}</span>
          </td>
          <td>${user.email}</td>
          <td>${user.phone || 'N/A'}</td>
          <td>${new Date(user.createdAt).toLocaleDateString('en-US')}</td>
          <td>
            ${user.isBlocked ? 
              '<span class="badge bg-danger-subtle text-danger fw-semibold">Blocked</span>' : 
              '<span class="badge bg-success-subtle text-success fw-semibold">Active</span>'}
          </td>
          <td>
            <button
              class="btn btn-sm toggle-status-btn ${user.isBlocked ? 'btn-success' : 'btn-danger'}"
              data-user-id="${user._id}"
              data-action="${user.isBlocked ? 'unblock' : 'block'}">
              <i class="bi ${user.isBlocked ? 'bi-unlock' : 'bi-lock'}"></i> ${user.isBlocked ? 'Unblock' : 'Block'}
            </button>
          </td>
        </tr>
      `).join('');
      tableBody.innerHTML = rows;

      // Update pagination - render it manually since we can't use EJS in client-side JS
      const paginationWrapper = document.getElementById('pagination-wrapper');
      if (paginationWrapper) {
        if (data.totalPages <= 1) {
          paginationWrapper.innerHTML = '';
        } else {
          let paginationHTML = '<nav class="mt-4"><ul class="pagination justify-content-center" id="pagination-container">';
          
          // Previous button
          paginationHTML += `
            <li class="page-item ${data.currentPage === 1 ? 'disabled' : ''}">
              <a class="page-link pagination-btn ${data.currentPage === 1 ? 'disabled-btn' : ''}"
                 href="#" data-page="${data.currentPage - 1}"
                 ${data.currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>
                <i class="bi bi-chevron-left"></i> Previous
              </a>
            </li>
          `;

          // Page numbers
          for (let i = 1; i <= data.totalPages; i++) {
            paginationHTML += `
              <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                <a class="page-link pagination-btn" href="#" data-page="${i}">${i}</a>
              </li>
            `;
          }

          // Next button
          paginationHTML += `
            <li class="page-item ${data.currentPage === data.totalPages ? 'disabled' : ''}">
              <a class="page-link pagination-btn ${data.currentPage === data.totalPages ? 'disabled-btn' : ''}"
                 href="#" data-page="${data.currentPage + 1}"
                 ${data.currentPage === data.totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>
                Next <i class="bi bi-chevron-right"></i>
              </a>
            </li>
          `;

          paginationHTML += '</ul></nav>';
          paginationWrapper.innerHTML = paginationHTML;
        }
      }
    }

    // Initial load
    fetchAndRenderUsers(currentQuery, currentStatus);
    toggleClearButton();

    // Attach event listener to initial remove button if it exists
    const initialRemoveBtn = document.getElementById('remove-filter-btn');
    if (initialRemoveBtn) {
      initialRemoveBtn.addEventListener('click', handleRemoveFilter);
    }

    // Search input change
    searchInput.addEventListener('input', toggleClearButton);

    // Search button handler
    searchBtn.addEventListener('click', () => {
      currentQuery = searchInput.value;
      fetchAndRenderUsers(currentQuery, currentStatus);
    });

    // Clear search button handler
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      currentQuery = '';
      toggleClearButton();
      fetchAndRenderUsers(currentQuery, currentStatus);
    });

    // Automatically apply filter when dropdown changes
    statusFilter.addEventListener('change', async () => {
      const newStatus = statusFilter.value;
      currentStatus = newStatus;
      
      // Fetch data immediately
      await fetchAndRenderUsers(currentQuery, currentStatus);
      
      // Update button visibility
      updateRemoveFilterButton(newStatus);
    });

    // Enter key to search
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });

    // Pagination handler
    document.addEventListener('click', (e) => {
      const target = e.target.closest('.page-link');
      if (!target || !target.dataset.page || target.classList.contains('disabled-btn')) return;

      e.preventDefault();
      const page = parseInt(target.dataset.page);
      if (isNaN(page) || page < 1) return;

      fetchAndRenderUsers(currentQuery, currentStatus, page);
    });

    // Block/Unblock handler
    tableBody.addEventListener('click', async (e) => {
      if (e.target.classList.contains('toggle-status-btn')) {
        const userId = e.target.dataset.userId;
        const action = e.target.dataset.action;

        const confirmation = await Swal.fire({
          title: `${action === 'block' ? 'Block' : 'Unblock'} user?`,
          text: `Are you sure you want to ${action} this user?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: action === 'block' ? '#d33' : '#28a745',
          cancelButtonColor: '#6c757d',
          confirmButtonText: `Yes, ${action}`
        });

        if (!confirmation.isConfirmed) return;

        try {
          const res = await fetch(`/admin/users/${userId}/${action}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' }
          });

          const result = await res.json();
          if (result.success) {
            await fetchAndRenderUsers(currentQuery, currentStatus);
            Swal.fire({
              icon: 'success',
              title: `${action === 'block' ? 'Blocked' : 'Unblocked'}!`,
              text: `User has been ${action}ed successfully.`,
              timer: 1500,
              showConfirmButton: false
            });
          } else {
            Swal.fire('Error', result.message || 'Something went wrong.', 'error');
          }
        } catch (err) {
          console.error(err);
          Swal.fire('Server error', 'Please try again later.', 'error');
          }
      }
    });
  });
</script>
