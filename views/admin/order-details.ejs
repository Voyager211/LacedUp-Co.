<% var title = "Order Details"; %>

<div class="container-fluid py-4">
  <% if (order) { %>
    <!-- Page Header -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <nav aria-label="breadcrumb" class="mb-3">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin/orders" class="text-decoration-none">Orders</a></li>
                <li class="breadcrumb-item active" aria-current="page">Order Details</li>
              </ol>
            </nav>
            <h1 class="fw-bold text-dark mb-2">Order #<%= order.orderId %></h1>
            <p class="text-muted mb-0 fs-6">
              <i class="bi bi-calendar3 me-2"></i>
              Placed on <%= new Date(order.createdAt).toLocaleDateString('en-IN', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              }) %>
            </p>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <a href="/admin/orders" class="btn btn-dark btn-sm">
              <i class="bi bi-arrow-left me-1"></i>Back to Orders
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Status Overview -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="card border-0 shadow-sm order-status-card">
          <div class="card-body py-4">
            <div class="row g-4 align-items-center">
              <div class="col-lg-2 col-md-4">
                <div class="text-center">
                  <h6 class="text-muted mb-2 fw-normal">Order Status</h6>
                  <span class="status-badge status-<%= order.status.toLowerCase().replace(' ', '-') %>">
                    <%= order.status %>
                  </span>
                </div>
              </div>
              <div class="col-lg-2 col-md-4">
                <div class="text-center">
                  <h6 class="text-muted mb-2 fw-normal">Payment Status</h6>
                  <span class="status-badge payment-<%= (order.paymentStatus || 'unknown').toLowerCase() %>">
                    <%= order.paymentStatus || 'Unknown' %>
                  </span>
                </div>
              </div>
              <div class="col-lg-2 col-md-4">
                <div class="text-center">
                  <h6 class="text-muted mb-2 fw-normal">Total Amount</h6>
                  <h3 class="fw-bold text-dark mb-0">‚Çπ<%= order.totalAmount.toLocaleString('en-IN') %></h3>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="d-flex gap-2 justify-content-lg-end justify-content-center flex-wrap">
                  <% if (order.status !== 'Delivered' && order.status !== 'Cancelled' && order.status !== 'Returned') { %>
                    <button class="btn btn-primary" onclick="updateOrderStatus('<%= order.orderId %>', '<%= order.status %>')">
                      <i class="bi bi-pencil me-2"></i>Update Status
                    </button>
                  <% } else { %>
                    <button class="btn btn-secondary" disabled title="No status updates available for <%= order.status.toLowerCase() %> orders">
                      <i class="bi bi-lock me-2"></i>Status Final
                    </button>
                  <% } %>
                  
                  <!--Cancel Order Button with ID for dynamic visibility -->
                  <% if (order.status === ORDER_STATUS.PENDING || order.status === ORDER_STATUS.PROCESSING) { %>
                    <button id="cancelOrderBtn" class="btn btn-danger" onclick="showCancelOrderConfirm('<%= order.orderId %>')">
                      <i class="bi bi-x-circle me-2"></i>Cancel Order
                    </button>
                  <% } %>
                  
                  <!-- Return Order Button with ID for dynamic visibility -->
                  <% if (order.status === ORDER_STATUS.DELIVERED) { %>
                    <button id="returnOrderBtn" class="btn btn-warning" onclick="showReturnOrderConfirm('<%= order.orderId %>')">
                      <i class="bi bi-arrow-counterclockwise me-2"></i>Return Order
                    </button>
                  <% } %>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="row g-4">
      <!-- Left Column: Order Details -->
      <div class="col-lg-8">
        <!-- Customer & Delivery Information Combined -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0">
              <i class="bi bi-person-circle me-2"></i>Customer & Delivery Information
            </h5>
          </div>
          <div class="card-body py-4">
            <div class="row g-4">
              <!-- Customer Info -->
              <div class="col-md-6">
                <div class="customer-section">
                  <h6 class="text-muted mb-3 fw-normal">Customer Details</h6>
                  <div class="d-flex align-items-center mb-3">
                    <div class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-person text-primary fs-4"></i>
                    </div>
                    <div>
                      <h6 class="fw-bold mb-1"><%= order.user?.name || 'N/A' %></h6>
                      <p class="text-muted mb-0 small"><%= order.user?.email || 'N/A' %></p>
                    </div>
                  </div>
                  <div class="contact-info">
                    <% if (order.deliveryAddress && order.deliveryAddress.phone) { %>
                      <p class="mb-2">
                        <i class="bi bi-telephone me-2 text-muted"></i>
                        <strong>Phone:</strong> <%= order.deliveryAddress.phone %>
                      </p>
                      <% if (order.deliveryAddress.altPhone) { %>
                        <p class="mb-0">
                          <i class="bi bi-telephone me-2 text-muted"></i>
                          <strong>Alt Phone:</strong> <%= order.deliveryAddress.altPhone %>
                        </p>
                      <% } %>
                    <% } else if (order.shippingAddress && order.shippingAddress.phone) { %>
                      <p class="mb-2">
                        <i class="bi bi-telephone me-2 text-muted"></i>
                        <strong>Phone:</strong> <%= order.shippingAddress.phone %>
                      </p>
                      <% if (order.shippingAddress.altPhone) { %>
                        <p class="mb-0">
                          <i class="bi bi-telephone me-2 text-muted"></i>
                          <strong>Alt Phone:</strong> <%= order.shippingAddress.altPhone %>
                        </p>
                      <% } %>
                    <% } else { %>
                      <p class="mb-0 text-muted">
                        <i class="bi bi-telephone me-2 text-muted"></i>
                        <strong>Phone:</strong> Not available
                      </p>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- Delivery Address -->
              <div class="col-md-6">
                <div class="address-section">
                  <h6 class="text-muted mb-3 fw-normal">Delivery Address</h6>
                  <% if (order.deliveryAddress) { %>
                    <div class="address-card bg-light rounded-3 p-3">
                      <h6 class="fw-bold mb-2">
                        <i class="bi bi-geo-alt me-2"></i><%= order.deliveryAddress.name || 'N/A' %>
                      </h6>
                      <% if (order.deliveryAddress.addressType) { %>
                        <p class="mb-1 small text-muted"><%= order.deliveryAddress.addressType %></p>
                      <% } %>
                      <% if (order.deliveryAddress.landMark) { %>
                        <p class="mb-1"><%= order.deliveryAddress.landMark %></p>
                      <% } %>
                      <% if (order.deliveryAddress.city || order.deliveryAddress.state) { %>
                        <p class="mb-1">
                          <%= order.deliveryAddress.city || '' %><%= order.deliveryAddress.city && order.deliveryAddress.state ? ', ' : '' %><%= order.deliveryAddress.state || '' %>
                        </p>
                      <% } %>
                      <% if (order.deliveryAddress.pincode) { %>
                        <p class="mb-0"><strong>PIN:</strong> <%= order.deliveryAddress.pincode %></p>
                      <% } %>
                    </div>
                  <% } else { %>
                    <!-- No address available -->
                    <div class="address-card bg-light rounded-3 p-3">
                      <div class="text-center text-muted">
                        <i class="bi bi-geo-alt fs-2 mb-2 d-block"></i>
                        <p class="mb-0">No delivery address available</p>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items with Individual Management -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0">
              <i class="bi bi-bag me-2"></i>Order Items (<%= order.totalItemCount %> items)
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 order-items-table">
                <thead class="table-light">
                  <tr>
                    <th class="border-0 py-3">Product</th>
                    <th class="border-0 py-3">SKU</th>
                    <th class="border-0 py-3">Size</th>
                    <th class="border-0 py-3">Qty</th>
                    <th class="border-0 py-3">Price</th>
                    <th class="border-0 py-3">Total</th>
                    <th class="border-0 py-3">Status</th>
                    <th class="border-0 py-3">Payment</th>
                    <th class="border-0 py-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% order.items.forEach(item => { %>
                    <tr data-item-id="<%= item._id %>">
                      <td class="py-3">
                        <div class="d-flex align-items-center">
                          <% if (item.productId && item.productId.mainImage) { %>
                            <img src="<%= item.productId.mainImage %>" 
                                alt="<%= item.productId.productName %>" 
                                class="rounded me-3 product-thumb" 
                                style="width: 60px; height: 60px; object-fit: cover;">
                          <% } else { %>
                            <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center product-thumb" 
                                style="width: 60px; height: 60px;">
                              <i class="bi bi-image text-muted"></i>
                            </div>
                          <% } %>
                          <div>
                            <h6 class="fw-semibold mb-0">
                              <%= item.productId ? item.productId.productName : 'Product Name' %>
                            </h6>
                          </div>
                        </div>
                      </td>
                      <td class="py-3"><code class="small"><%= item.sku %></code></td>
                      <td class="py-3"><span class="badge bg-light text-dark"><%= item.size %></span></td>
                      <td class="py-3"><span class="fw-semibold"><%= item.quantity %></span></td>
                      <td class="py-3">‚Çπ<%= item.price.toLocaleString('en-IN') %></td>
                      <td class="py-3"><span class="fw-bold">‚Çπ<%= item.totalPrice.toLocaleString('en-IN') %></span></td>
                      
                      <!-- Status column with modal-based status management -->
                      <td class="py-3">
                        <div class="d-flex align-items-center gap-2">
                          <!-- Current Status Badge -->
                          <span class="status-badge item-<%= (item.status || 'pending').toLowerCase() %> bg-<%= getStatusColor(item.status || 'Pending') %> badge"
                                id="item-status-<%= item._id %>">
                            <%= item.status || 'Pending' %>
                          </span>
                          
                          <!-- Modal Trigger Button (Admin Only) -->
                          <% if (item.status !== 'Cancelled' && item.status !== 'Returned') { %>
                            <button class="btn btn-outline-secondary btn-sm status-update-btn" 
                                    data-item-id="<%= item._id %>"
                                    data-current-status="<%= item.status %>"
                                    data-valid-transitions="<%- encodeURIComponent(JSON.stringify(item.validTransitions || [])) %>"
                                    title="Update Status">
                              <i class="bi bi-pencil" style="font-size: 0.75rem;"></i>
                            </button>
                          <% } else { %>
                            <!-- Final status indicator -->
                            <span class="text-muted" title="Final status - no updates available">
                              <i class="bi bi-lock-fill" style="font-size: 0.75rem;"></i>
                            </span>
                          <% } %>
                        </div>
                      </td>

                      
                      <td class="py-3">
                        <span class="payment-badge payment-<%= (item.paymentStatus || 'pending').toLowerCase().replace(/\s+/g, '-') %> bg-<%= getPaymentStatusColor(item.paymentStatus || 'Pending') %> badge" 
                              data-payment-status="<%= item.paymentStatus || 'Pending' %>"
                              id="item-payment-<%= item._id %>">
                          <%= item.paymentStatus || 'Pending' %>
                        </span>
                      </td>
                      <td class="py-3">
                        <div class="d-flex gap-2 justify-content-center">
                          <!-- Return Item Button (Delivered only) -->
                          <% if (item.status === ORDER_STATUS.DELIVERED) { %>
                            <button class="btn btn-outline-warning d-flex align-items-center justify-content-center" 
                                    onclick="showReturnItemConfirm('<%= order.orderId %>', '<%= item._id %>')"
                                    title="Create return request for this item"
                                    style="width: 38px; height: 38px; border-width: 2px;">
                              <i class="bi bi-arrow-counterclockwise fs-5"></i>
                            </button>
                          <% } else { %>
                            <!-- No actions available -->
                            <span class="text-muted small">No actions</span>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>


        <!-- Comprehensive Order Timeline (Collapsible) -->
        <% if (order.comprehensiveStatusHistory && order.comprehensiveStatusHistory.length > 0) { %>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                  <i class="bi bi-clock-history me-2"></i>Order Timeline
                </h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#orderTimeline" aria-expanded="true">
                  <i class="bi bi-chevron-down"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="orderTimeline">
              <div class="card-body">
                <div class="timeline-compact">
                  <% order.comprehensiveStatusHistory.forEach((history, index) => { %>
                    <div class="timeline-item-compact">
                      <div class="timeline-marker-compact bg-<%= 
                        history.status === 'Delivered' ? 'success' : 
                        history.status === 'Shipped' ? 'info' : 
                        history.status === 'Processing' ? 'warning' : 
                        history.status === 'Cancelled' ? 'danger' : 
                        history.status === 'Returned' ? 'secondary' :
                        history.status === 'Partially Cancelled' ? 'warning' : 'secondary' 
                      %> <%= history.type === 'item' ? 'item-marker' : 'order-marker' %>"></div>
                      <div class="timeline-content-compact">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="fw-bold mb-1">
                              <% if (history.type === 'item') { %>
                                <span class="badge bg-info me-2">Item</span>
                              <% } else { %>
                                <span class="badge bg-primary me-2">Order</span>
                              <% } %>
                              <% if (history.status === 'Returned') { %>
                                Return Request
                              <% } else { %>
                                <%= history.status %>
                              <% } %>
                            </h6>
                            <% if (history.notes) { %>
                              <p class="mb-1 small text-muted"><%= history.notes %></p>
                            <% } %>
                            <% if (history.itemName) { %>
                              <small class="text-info d-block mt-1">
                                <i class="bi bi-box me-1"></i><%= history.itemName %>
                              </small>
                            <% } %>
                          </div>
                          <small class="text-muted">
                            <%= new Date(history.updatedAt).toLocaleDateString('en-IN', { 
                              month: 'short', 
                              day: 'numeric',
                              hour: '2-digit',
                              minute: '2-digit'
                            }) %>
                          </small>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Right Column: Summary & Actions -->
      <div class="col-lg-4">
        <!-- Order Summary & Payment Combined -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0">
              <i class="bi bi-receipt me-2"></i>Order Summary
            </h5>
          </div>
          <div class="card-body">
            <!-- Order Summary -->
            <div class="summary-section mb-4">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span>‚Çπ<%= order.subtotal.toLocaleString('en-IN') %></span>
              </div>
              <% if (order.totalDiscount > 0) { %>
                <div class="d-flex justify-content-between mb-2 text-success">
                  <span>Discount:</span>
                  <span>-‚Çπ<%= order.totalDiscount.toLocaleString('en-IN') %></span>
                </div>
              <% } %>
              <div class="d-flex justify-content-between mb-3">
                <span>Shipping:</span>
                <span><%= order.shipping === 0 ? 'Free' : '‚Çπ' + order.shipping.toLocaleString('en-IN') %></span>
              </div>
              <hr class="my-3">
              <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                <span>Total:</span>
                <span>‚Çπ<%= order.totalAmount.toLocaleString('en-IN') %></span>
              </div>
            </div>

            <!-- Payment Info -->
            <div class="payment-section">
              <h6 class="fw-bold mb-3">Payment Information</h6>
              <div class="bg-light rounded-3 p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Method:</span>
                  <span class="fw-semibold text-uppercase">
                    <%= order.paymentMethod === 'cod' ? 'Cash on Delivery' : order.paymentMethod %>
                  </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="small text-muted">Status:</span>
                  <!--  FIXED: Handle undefined paymentStatus -->
                  <span class="status-badge payment-<%= (order.paymentStatus || 'unknown').toLowerCase() %>">
                    <%= order.paymentStatus || 'Unknown' %>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <% } else { %>
    <!-- Error State -->
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle display-1 text-muted mb-3"></i>
          <h3 class="text-muted">Order Not Found</h3>
          <p class="text-muted mb-4">The requested order could not be found.</p>
          <a href="/admin/orders" class="btn btn-primary">
            <i class="bi bi-arrow-left me-2"></i>Back to Orders
          </a>
        </div>
      </div>
    </div>
  <% } %>
</div>




<!-- Cancel Item Modal -->
<div class="modal fade" id="cancelItemModal" tabindex="-1" aria-labelledby="cancelItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelItemModalLabel">Cancel Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="cancelItemForm">
          <input type="hidden" id="cancelOrderId" name="orderId">
          <input type="hidden" id="cancelItemId" name="itemId">
          <div class="mb-3">
            <label for="cancelReason" class="form-label">Cancellation Reason</label>
            <textarea class="form-control" id="cancelReason" name="reason" rows="3" 
                      placeholder="Enter reason for cancellation..." required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="submitItemCancellation()">Cancel Item</button>
      </div>
    </div>
  </div>
</div>

<!-- Return Item Modal -->
<div class="modal fade" id="returnItemModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title text-dark">Return Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 p-3 bg-light border rounded">
          <small class="text-muted">
            This will create a return request for the selected item. The request will need approval before the item is marked as returned.
          </small>
        </div>
        
        <form id="returnItemForm">
          <input type="hidden" id="returnOrderId" name="orderId">
          <input type="hidden" id="returnItemId" name="itemId">
          
          <div class="mb-3">
            <label for="returnReason" class="form-label">Return Reason <span class="text-danger">*</span></label>
            <select class="form-select" id="returnReason" name="reason" required>
              <option value="">Select a return reason...</option>
              <% returnReasons.forEach(reason => { %>
                <option value="<%= reason %>"><%= reason %></option>
              <% }); %>
            </select>
            <small class="form-text text-muted">Please select the most appropriate reason for this return.</small>
          </div>
          
          <div class="mb-3">
            <label for="returnNotes" class="form-label">Additional Notes (Optional)</label>
            <textarea class="form-control" id="returnNotes" name="notes" rows="2" 
                      placeholder="Add any additional details about this return..."></textarea>
            <small class="form-text text-muted">Any additional context that might be helpful for processing the return.</small>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="submitItemReturn()">Create Return Request</button>
      </div>
    </div>
  </div>
</div>


<!-- Include existing modals -->
<!--  ENHANCED: Update Order Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title text-dark">Update Order Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 p-3 bg-light border rounded">
          <div class="row">
            <div class="col-sm-6">
              <small class="text-muted">Current Status:</small>
              <div class="fw-bold"><%= order.status %></div>
            </div>
            <div class="col-sm-6">
              <small class="text-muted">Note:</small>
              <div><small>All items in this order will be updated to the new status automatically</small></div>
            </div>
          </div>
        </div>
        
        <form id="updateStatusForm">
          <input type="hidden" id="statusOrderId" name="orderId">
          <div class="mb-3">
            <label for="orderStatus" class="form-label">New Status</label>
            <select class="form-select" id="orderStatus" name="status" required>
              <!-- Options populated dynamically by JavaScript -->
            </select>
            <small class="form-text text-muted">
              Only valid status transitions are shown. Cancellations and returns are managed by users.
            </small>
          </div>
          <div class="mb-3">
            <label for="statusNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="statusNotes" name="notes" rows="3" 
                      placeholder="Add any notes about this status change..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" onclick="submitStatusUpdate()">Update Status</button>
      </div>
    </div>
  </div>
</div>



<script>
//  Get valid transitions from template data
let validTransitions = <%- JSON.stringify(validTransitions) %>;
let currentOrderStatus = '<%= order.status %>';

// Helper functions for status colors
function getStatusColor(status) {
  const colorMap = {
    'Pending': 'warning',
    'Processing': 'info',
    'Shipped': 'primary',
    'Delivered': 'success',
    'Processing Return': 'warning',
    'Returned': 'secondary',
    'Cancelled': 'danger',
    'Partially Delivered': 'primary',
    'Partially Cancelled': 'danger',
    'Partially Returned': 'secondary'
  };
  return colorMap[status] || 'secondary';
}

function getPaymentStatusColor(status) {
  const colorMap = {
    'Pending': 'warning',
    'Completed': 'success',
    'Failed': 'danger', 
    'Refunded': 'info',
    'Cancelled': 'secondary',
    'Partially Completed': 'primary',
    'Partially Refunded': 'secondary'
  };
  return colorMap[status] || 'secondary';
}

// Initialize modal event system when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîç Initializing modal status update system');
  
  // Set global order ID
  window.currentOrderId = '<%= order.orderId %>';
  
  // Event delegation for status update buttons
  document.body.addEventListener('click', function(event) {
    const button = event.target.closest('.status-update-btn');
    if (button) {
      event.preventDefault();
      
      const itemId = button.getAttribute('data-item-id');
      const currentStatus = button.getAttribute('data-current-status');
      const validTransitionsEncoded = button.getAttribute('data-valid-transitions');
      
      let validTransitions = [];
      try {
        validTransitions = JSON.parse(decodeURIComponent(validTransitionsEncoded || '[]'));
      } catch (e) {
        console.error('Error parsing validTransitions:', e);
        validTransitions = [];
      }
      
      showStatusModal(itemId, currentStatus, validTransitions);
    }
  });
});

// Build and show status modal
function showStatusModal(itemId, currentStatus, validTransitions) {
  console.log('üîç Building status modal for:', itemId);
  
  let modalHtml = '';
  modalHtml += '<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">';
  modalHtml += '  <div class="modal-dialog modal-dialog-centered">';
  modalHtml += '    <div class="modal-content">';
  modalHtml += '      <div class="modal-header">';
  modalHtml += '        <h5 class="modal-title" id="statusModalLabel">Change Item Status</h5>';
  modalHtml += '        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>';
  modalHtml += '      </div>';
  modalHtml += '      <div class="modal-body">';
  modalHtml += '        <p class="mb-3"><strong>Current Status:</strong> <span class="badge bg-secondary">' + currentStatus + '</span></p>';
  modalHtml += '        <p class="text-muted small mb-3">Select new status:</p>';
  modalHtml += '        <div class="list-group">';

  if (validTransitions && validTransitions.length > 0) {
    for (let i = 0; i < validTransitions.length; i++) {
      let status = validTransitions[i];
      modalHtml += '          <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" ';
      modalHtml += '                  data-item-id="' + itemId + '" data-new-status="' + status + '">';
      modalHtml += '            <i class="bi bi-arrow-right me-2 text-muted"></i>';
      modalHtml += '            <span>' + status + '</span>';
      modalHtml += '          </button>';
    }
  } else {
    modalHtml += '          <div class="list-group-item text-center text-muted">';
    modalHtml += '            <i class="bi bi-info-circle me-2"></i>No transitions available';
    modalHtml += '          </div>';
  }

  modalHtml += '        </div>';
  modalHtml += '      </div>';
  modalHtml += '    </div>';
  modalHtml += '  </div>';
  modalHtml += '</div>';

  // Remove existing modal
  const existingModal = document.getElementById('statusModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Add and show modal
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('statusModal'));
  modal.show();
  
  // Add click listeners to status options
  const statusOptions = document.querySelectorAll('#statusModal .list-group-item[data-new-status]');
  statusOptions.forEach(function(option) {
    option.addEventListener('click', function() {
      const itemId = this.getAttribute('data-item-id');
      const newStatus = this.getAttribute('data-new-status');
      changeItemStatus(itemId, newStatus);
    });
  });
}

// Handle status change
function changeItemStatus(itemId, newStatus) {
  console.log('üîç Changing status:', { itemId, newStatus });
  
  // Close modal
  const modalElement = document.getElementById('statusModal');
  if (modalElement) {
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
      modalInstance.hide();
    }
  }

  // Call existing updateItemStatus function
  if (window.currentOrderId) {
    updateItemStatus(window.currentOrderId, itemId, newStatus);
  } else {
    console.error('‚ùå Order ID not set');
    showToast('error', 'Order ID not found');
  }
}

// ===== DYNAMIC BUTTON VISIBILITY FUNCTIONS =====

/**
 * Update button visibility based on order status
 * @param {string} newOrderStatus - The new order status
 */
function updateButtonVisibility(newOrderStatus) {
  console.log('üîç Updating button visibility for status:', newOrderStatus);
  
  const cancelOrderBtn = document.getElementById('cancelOrderBtn');
  const returnOrderBtn = document.getElementById('returnOrderBtn');
  
  // Define status constants (matching your enums)
  const ORDER_STATUS = {
    PENDING: 'Pending',
    PROCESSING: 'Processing', 
    SHIPPED: 'Shipped',
    DELIVERED: 'Delivered',
    CANCELLED: 'Cancelled',
    PARTIALLY_CANCELLED: 'Partially Cancelled',
    RETURNED: 'Returned',
    PARTIALLY_RETURNED: 'Partially Returned',
    PARTIALLY_DELIVERED: 'Partially Delivered',
    PROCESSING_RETURN: 'Processing Return'
  };
  
  //  CANCEL BUTTON LOGIC: Show only for Pending/Processing
  const showCancelButton = (newOrderStatus === ORDER_STATUS.PENDING || newOrderStatus === ORDER_STATUS.PROCESSING);
  
  if (showCancelButton) {
    if (!cancelOrderBtn) {
      // Create cancel button if it doesn't exist
      createCancelOrderButton();
    } else {
      // Show existing cancel button
      cancelOrderBtn.style.display = 'inline-block';
      cancelOrderBtn.disabled = false;
      console.log(' Cancel button shown');
    }
  } else {
    if (cancelOrderBtn) {
      // Hide cancel button
      cancelOrderBtn.style.display = 'none';
      console.log(' Cancel button hidden');
    }
  }
  
  //  RETURN BUTTON LOGIC: Show only for Delivered
  const showReturnButton = (newOrderStatus === ORDER_STATUS.DELIVERED);
  
  if (showReturnButton) {
    if (!returnOrderBtn) {
      // Create return button if it doesn't exist
      createReturnOrderButton();
    } else {
      // Show existing return button
      returnOrderBtn.style.display = 'inline-block';
      returnOrderBtn.disabled = false;
      console.log(' Return button shown');
    }
  } else {
    if (returnOrderBtn) {
      // Hide return button
      returnOrderBtn.style.display = 'none';
      console.log(' Return button hidden');
    }
  }
  
  console.log(' Button visibility updated:', {
    status: newOrderStatus,
    cancelVisible: showCancelButton,
    returnVisible: showReturnButton
  });
}

/**
 * Create cancel order button dynamically
 */
function createCancelOrderButton() {
  const buttonsContainer = document.querySelector('.d-flex.gap-2.justify-content-lg-end');
  if (buttonsContainer) {
    const cancelBtn = document.createElement('button');
    cancelBtn.id = 'cancelOrderBtn';
    cancelBtn.className = 'btn btn-danger';
    cancelBtn.onclick = () => showCancelOrderConfirm('<%= order.orderId %>');
    cancelBtn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Cancel Order';
    
    // Insert after the status update button
    const statusButton = buttonsContainer.querySelector('.btn-primary, .btn-secondary');
    if (statusButton) {
      statusButton.insertAdjacentElement('afterend', cancelBtn);
    } else {
      buttonsContainer.appendChild(cancelBtn);
    }
    
    console.log(' Cancel button created dynamically');
  }
}

/**
 * Create return order button dynamically
 */
function createReturnOrderButton() {
  const buttonsContainer = document.querySelector('.d-flex.gap-2.justify-content-lg-end');
  if (buttonsContainer) {
    const returnBtn = document.createElement('button');
    returnBtn.id = 'returnOrderBtn';
    returnBtn.className = 'btn btn-warning';
    returnBtn.onclick = () => showReturnOrderConfirm('<%= order.orderId %>');
    returnBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise me-2"></i>Return Order';
    
    // Add to the end of buttons container
    buttonsContainer.appendChild(returnBtn);
    
    console.log(' Return button created dynamically');
  }
}


// ===== Cancel ORDER MANAGEMENT FUNCTIONS =====

function showCancelOrderConfirm(orderId) {
  Swal.fire({
    title: 'Cancel Entire Order?',
    text: 'This will cancel ALL items in this order and cannot be undone. Stock will be restored.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, Cancel Order',
    cancelButtonText: 'Keep Order',
    width: '500px'
  }).then((result) => {
    if (result.isConfirmed) {
      // Show loading state
      Swal.fire({
        title: 'Cancelling Order...',
        text: 'Please wait while we process the cancellation',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Make API call
      fetch(`/admin/orders/${orderId}/cancel`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          reason: 'Order cancelled by admin'
        })
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Order Cancelled!',
            text: data.message,
            confirmButtonColor: '#000'
          }).then(() => {
            // Update UI dynamically
            updateOrderStatusInUI('Cancelled');
            updateOrderPaymentStatusInUI(data.order.paymentStatus);
            
            // Update all item statuses to cancelled
            const itemRows = document.querySelectorAll('[data-item-id]');
            itemRows.forEach(row => {
              const itemId = row.getAttribute('data-item-id');
              updateItemStatusInUI(itemId, 'Cancelled');
              
              // Hide cancel buttons since items are now cancelled
              const cancelButton = row.querySelector('button[onclick*="showCancelItemConfirm"]');
              if (cancelButton) {
                cancelButton.style.display = 'none';
              }
            });
            
            // Hide the cancel order button
            const cancelOrderBtn = document.querySelector('button[onclick*="showCancelOrderConfirm"]');
            if (cancelOrderBtn) {
              cancelOrderBtn.style.display = 'none';
            }
            
            showToast('success', 'Order cancelled successfully. Stock restored.');
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Cancellation Failed',
            text: data.message || 'Failed to cancel order',
            confirmButtonColor: '#dc3545'
          });
        }
      })
      .catch(error => {
        Swal.close();
        console.error('Error cancelling order:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to cancel order. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    }
  });
}

// function showCancelItemConfirm(orderId, itemId) {
//   // Get item details for confirmation
//   const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
//   const productName = itemRow ? itemRow.querySelector('h6').textContent.trim() : 'this item';
  
//   Swal.fire({
//     title: 'Cancel Item?',
//     html: `
//       <p>Do you want to cancel <strong>${productName}</strong>?</p>
//       <p class="text-muted small">This action cannot be undone and stock will be restored.</p>
//     `,
//     icon: 'warning',
//     showCancelButton: true,
//     confirmButtonColor: '#dc3545',
//     cancelButtonColor: '#6c757d',
//     confirmButtonText: 'Yes, Cancel Item',
//     cancelButtonText: 'Keep Item',
//     width: '450px'
//   }).then((result) => {
//     if (result.isConfirmed) {
//       // Show loading state
//       Swal.fire({
//         title: 'Cancelling Item...',
//         text: 'Please wait while we process the cancellation',
//         allowOutsideClick: false,
//         allowEscapeKey: false,
//         showConfirmButton: false,
//         didOpen: () => {
//           Swal.showLoading();
//         }
//       });

//       // Make API call
//       fetch(`/admin/orders/${orderId}/items/${itemId}/cancel`, {
//         method: 'PATCH',
//         headers: {
//           'Content-Type': 'application/json',
//         },
//         body: JSON.stringify({ 
//           reason: 'Item cancelled by admin'
//         })
//       })
//       .then(response => response.json())
//       .then(data => {
//         Swal.close();
        
//         if (data.success) {
//           Swal.fire({
//             icon: 'success',
//             title: 'Item Cancelled!',
//             text: data.message,
//             confirmButtonColor: '#000'
//           }).then(() => {
//             // Update UI dynamically
//             updateItemStatusInUI(itemId, 'Cancelled');
            
//             // Update item payment status
//             const cancelledItem = data.order.items.find(item => item._id.toString() === itemId);
//             if (cancelledItem) {
//               updateItemPaymentStatusInUI(itemId, cancelledItem.paymentStatus);
//             }
            
//             // Update order-level statuses
//             updateOrderStatusInUI(data.order.status);
//             updateOrderPaymentStatusInUI(data.order.paymentStatus);
            
//             // Hide the cancel button for this item
//             const cancelButton = itemRow.querySelector('button[onclick*="showCancelItemConfirm"]');
//             if (cancelButton) {
//               cancelButton.parentElement.innerHTML = '<span class="text-muted small">Cancelled</span>';
//             }
            
//             showToast('success', `${productName} cancelled successfully. Stock restored.`);
//           });
//         } else {
//           Swal.fire({
//             icon: 'error',
//             title: 'Cancellation Failed',
//             text: data.message || 'Failed to cancel item',
//             confirmButtonColor: '#dc3545'
//           });
//         }
//       })
//       .catch(error => {
//         Swal.close();
//         console.error('Error cancelling item:', error);
//         Swal.fire({
//           icon: 'error',
//           title: 'Network Error',
//           text: 'Failed to cancel item. Please try again.',
//           confirmButtonColor: '#dc3545'
//         });
//       });
//     }
//   });
// }

// ===== RETURN ORDER FUNCTIONS =====

// Return entire order with confirmation


function showReturnOrderConfirm(orderId) {
  Swal.fire({
    title: 'Create Return Request for Order?',
    text: 'This will create return requests for ALL delivered items in this order.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ffc107',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, Create Return Requests',
    cancelButtonText: 'Cancel',
    width: '500px'
  }).then((result) => {
    if (result.isConfirmed) {
      // Show loading state
      Swal.fire({
        title: 'Creating Return Requests...',
        text: 'Please wait while we process the return requests',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Make API call
      fetch(`/admin/orders/${orderId}/return`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          reason: 'Return requested by admin'
        })
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Return Requests Created!',
            text: data.message,
            confirmButtonColor: '#ffc107'
          }).then(() => {
            // Reload page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed to Create Return Requests',
            text: data.message || 'Failed to create return requests',
            confirmButtonColor: '#dc3545'
          });
        }
      })
      .catch(error => {
        Swal.close();
        console.error('Error creating return requests:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to create return requests. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    }
  });
}

// Return individual item with confirmation
function showReturnItemConfirm(orderId, itemId) {
  // Get item details for confirmation
  const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
  const productName = itemRow ? itemRow.querySelector('h6').textContent.trim() : 'this item';
  
  Swal.fire({
    title: 'Create Return Request?',
    html: `
      <p>Do you want to create a return request for <strong>${productName}</strong>?</p>
      <p class="text-muted small">This will create a return request that needs to be approved later.</p>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ffc107',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, Create Return Request',
    cancelButtonText: 'Cancel',
    width: '450px'
  }).then((result) => {
    if (result.isConfirmed) {
      // Show loading state
      Swal.fire({
        title: 'Creating Return Request...',
        text: 'Please wait while we process the return request',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Make API call
      fetch(`/admin/orders/${orderId}/items/${itemId}/return`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          reason: 'Return requested by admin'
        })
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Return Request Created!',
            text: data.message,
            confirmButtonColor: '#ffc107'
          }).then(() => {
            // Reload page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed to Create Return Request',
            text: data.message || 'Failed to create return request',
            confirmButtonColor: '#dc3545'
          });
        }
      })
      .catch(error => {
        Swal.close();
        console.error('Error creating return request:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to create return request. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    }
  });
}




// Add debugging to modal opening
function updateOrderStatus(orderId, currentStatus) {
  try {
    console.log('üîç Opening modal - Initial parameters:', { orderId, currentStatus });
    
    const actualCurrentStatus = window.currentOrderStatus || currentStatus;
    const currentValidTransitions = window.validTransitions || validTransitions;
    
    //  NEW: Filter out restricted statuses for admin
    const restrictedStatuses = ['Cancelled', 'Processing Return', 'Returned'];
    const adminAllowedTransitions = currentValidTransitions.filter(status => 
      !restrictedStatuses.includes(status)
    );
    
    console.log('üîç Admin allowed transitions:', adminAllowedTransitions);
    
    if (!adminAllowedTransitions || adminAllowedTransitions.length === 0) {
      console.warn('‚ö†Ô∏è No admin-allowed transitions available');
      showToast('info', `No status transitions available from '${actualCurrentStatus}' for admin users`);
      return;
    }

    // Populate modal
    document.getElementById('statusOrderId').value = orderId;
    document.getElementById('statusNotes').value = '';
    
    const statusSelect = document.getElementById('orderStatus');
    statusSelect.innerHTML = '';
    
    // Current status option
    const currentOption = document.createElement('option');
    currentOption.value = '';
    currentOption.textContent = `${actualCurrentStatus} (Current Status)`;
    currentOption.disabled = true;
    currentOption.selected = true;
    currentOption.style.fontWeight = 'bold';
    currentOption.style.color = '#6c757d';
    statusSelect.appendChild(currentOption);
    
    // Separator
    const separatorOption = document.createElement('option');
    separatorOption.value = '';
    separatorOption.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
    separatorOption.disabled = true;
    statusSelect.appendChild(separatorOption);
    
    //  UPDATED: Add only admin-allowed transitions
    adminAllowedTransitions.forEach((status, index) => {
      if (status !== actualCurrentStatus) {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusSelect.appendChild(option);
        console.log(` Added admin option: ${status}`);
      }
    });
    
    console.log(' Modal populated with admin-allowed options');
    
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
    
  } catch (error) {
    console.error('‚ùå Error opening modal:', error);
    showToast('error', 'Failed to open status update modal');
  }
}

// Update individual item status
async function updateItemStatus(orderId, itemId, newStatus) {
  try {
    // Get item details for better messaging
    const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
    const productName = itemRow ? itemRow.querySelector('h6').textContent.trim() : 'Item';
    const currentStatus = itemRow ? itemRow.querySelector('.status-badge').textContent.trim() : 'Unknown';

    // ‚úÖ CLEAN & MINIMAL: Simple confirmation modal
    const result = await Swal.fire({
      title: 'Update Status?',
      text: `Change ${productName} from ${currentStatus} to ${newStatus}?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Update',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#007bff',
      cancelButtonColor: '#6c757d',
      width: '350px',
      backdrop: true,
      allowOutsideClick: true
    });

    if (!result.isConfirmed) return;

    // Show loading modal
    Swal.fire({
      title: 'Updating...',
      text: 'Please wait',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Make API call
    const response = await fetch(`/admin/orders/${orderId}/items/${itemId}/status`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        status: newStatus,
        notes: `Item status updated to ${newStatus} by admin`
      })
    });

    const data = await response.json();

    if (data.success) {
      // ‚úÖ CRITICAL: Close loading modal first
      Swal.close();
      
      // Show success toast
      showToast('success', `${productName} updated to ${newStatus}`);
      
      // Update UI with smooth animations
      updateItemStatusInUI(itemId, newStatus);
      if (data.order.changes) {
        updateItemPaymentStatusInUI(itemId, data.order.changes.newItemPaymentStatus);
        updateOrderStatusInUI(data.order.status);
        updateOrderPaymentStatusInUI(data.order.paymentStatus);
      }

      // Add visual feedback to updated row
      const updatedRow = document.querySelector(`[data-item-id="${itemId}"]`);
      if (updatedRow) {
        updatedRow.style.animation = 'updateSuccess 0.6s ease-out';
      }

    } else {
      throw new Error(data.message);
    }

  } catch (error) {
    console.error('Error updating item status:', error);
    
    // ‚úÖ CRITICAL: Close loading modal before showing error
    Swal.close();
    
    // Show error modal
    Swal.fire({
      title: 'Update Failed',
      text: error.message || 'An unexpected error occurred',
      icon: 'error',
      confirmButtonText: 'OK',
      confirmButtonColor: '#dc3545'
    });
  }
}


function submitStatusUpdate() {
  const form = document.getElementById('updateStatusForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  const newStatus = formData.get('status');
  
  if (!newStatus || newStatus === '') {
    showToast('error', 'Please select a new status');
    return;
  }

  //  UPDATED: Validate against admin-allowed transitions
  const restrictedStatuses = ['Cancelled', 'Processing Return', 'Returned'];
  const currentValidTransitions = window.validTransitions || validTransitions;
  const adminAllowedTransitions = currentValidTransitions.filter(status => 
    !restrictedStatuses.includes(status)
  );
  
  if (!adminAllowedTransitions.includes(newStatus)) {
    console.error('‚ùå Invalid admin transition:', {
      selectedStatus: newStatus,
      adminAllowedTransitions: adminAllowedTransitions
    });
    showToast('error', 'Invalid status transition selected for admin users');
    return;
  }

  const submitBtn = document.querySelector('#updateStatusModal .btn-dark');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'Updating...';

  fetch(`/admin/orders/${orderId}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      status: newStatus,
      notes: formData.get('notes')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();

      console.log('üîç ORDER UPDATE DEBUG:', {
        orderStatus: data.order.status,
        orderPaymentStatus: data.order.paymentStatus
      });

      // Update UI
      updateOrderStatusInUI(data.order.status);
      updateOrderPaymentStatusInUI(data.order.paymentStatus);
      
      // Update all item statuses and payment statuses
      if (data.order.items && data.order.items.length > 0) {
        data.order.items.forEach((item, index) => {
          console.log(`üîç UPDATING ITEM ${index}:`, {
            itemId: item._id,
            itemStatus: item.status,
            itemPaymentStatus: item.paymentStatus
          });
          
          updateItemStatusInUI(item._id, item.status);
          updateItemPaymentStatusInUI(item._id, item.paymentStatus);
        });
      }
      
      // Update modal data for next time
      updateModalDataAfterStatusChange(orderId, data.order.status);
      
      //  NEW: Disable update button if order is now delivered
      if (data.order.status === 'Delivered') {
        setTimeout(() => {
          location.reload(); // Reload to update the button state
        }, 1500);
      }
      
    } else {
      throw new Error(data.message || 'Failed to update order status');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', error.message || 'Error updating order status');
  })
  .finally(() => {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  });
}

// Add debugging to see what's happening
function updateModalDataAfterStatusChange(orderId, newCurrentStatus) {
  console.log('üîÑ Updating modal data after status change to:', newCurrentStatus);
  
  //  Fetch new valid transitions for the updated status
  fetch(`/admin/orders/${orderId}/transitions`)
    .then(response => {
      console.log('üîç Transitions fetch response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('üîç Transitions fetch response data:', data);
      
      if (data.success && data.allowedTransitions) {
        //  Update global variables for next modal open
        window.currentOrderStatus = newCurrentStatus;
        window.validTransitions = data.allowedTransitions;

        validTransitions = data.allowedTransitions;
        
        console.log(' Modal data updated successfully:', {
          currentStatus: window.currentOrderStatus,
          validTransitions: window.validTransitions,
          validTransitionsLength: window.validTransitions.length
        });
        
      } else {
        console.warn('‚ùå Could not fetch updated transitions:', data);
      }
    })
    .catch(error => {
      console.error('‚ùå Error updating modal data:', error);
    });
}


// Update order-level payment status badges via fetch
function updateOrderPaymentStatusInUI(newPaymentStatus) {
  console.log('üîç Updating order payment status in UI:', newPaymentStatus);
  
  try {
    // Find order-level payment badges (not item-level ones)
    const orderPaymentBadges = document.querySelectorAll('.status-badge[class*="payment-"]');
    
    orderPaymentBadges.forEach((badge, index) => {
      // Skip item-level payment badges
      const isItemLevel = badge.closest('tr, .item-row') !== null;
      if (isItemLevel) {
        return;
      }
      
      console.log(`Updating order payment badge ${index}:`, badge);
      
      const originalText = badge.textContent;
      badge.textContent = newPaymentStatus;
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
      backgroundClasses.forEach(cls => badge.classList.remove(cls));
      
      // Remove old payment classes
      const classList = Array.from(badge.classList);
      classList.forEach(cls => {
        if (cls.startsWith('payment-')) {
          badge.classList.remove(cls);
        }
      });
      
      // Add new classes
      const newPaymentClass = `payment-${newPaymentStatus.toLowerCase().replace(/\s+/g, '-')}`;
      badge.classList.add(newPaymentClass);
      badge.classList.add(`bg-${getPaymentStatusColor(newPaymentStatus)}`);
      
      console.log(` Order payment badge updated from "${originalText}" to "${newPaymentStatus}"`);
    });
    
    console.log(' Order payment status updated in UI via fetch');
    
  } catch (error) {
    console.error('‚ùå Error updating order payment status UI:', error);
  }
}


// More precise order status badge update (excludes item badges)
function updateOrderStatusInUI(newStatus) {
  console.log('üîç Starting updateOrderStatusInUI with status:', newStatus);
  
  try {
    // FIXED: More specific selector that EXCLUDES payment badges
    const allElements = document.querySelectorAll('.status-badge, .badge');
    const orderBadges = [];
    
    allElements.forEach(element => {
      const isInItemRow = element.closest('tr, .item-row') !== null;
      const isPaymentBadge = element.classList.contains('payment-badge') || 
                            element.className.includes('payment-') ||
                            element.hasAttribute('data-payment-status');
      const isStatusBadge = element.classList.contains('status-badge') && 
                           !isPaymentBadge;
      
      // ONLY include order status badges, NOT payment badges
      if (!isInItemRow && isStatusBadge) {
        orderBadges.push(element);
        console.log('‚úÖ Found ORDER status badge:', element);
      } else if (!isInItemRow && isPaymentBadge) {
        console.log('‚è≠Ô∏è Skipping payment badge (will be handled separately):', element);
      }
    });
    
    console.log(`üîç Found ${orderBadges.length} ORDER status badges to update`);
    
    // FIXED: Only update order status badges
    orderBadges.forEach((badge, index) => {
      console.log(`Updating ORDER status badge ${index}:`, badge);
      
      const originalText = badge.textContent.trim();
      badge.textContent = newStatus;
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info'];
      backgroundClasses.forEach(cls => badge.classList.remove(cls));
      badge.classList.add(`bg-${getStatusColor(newStatus)}`);
      
      if (!badge.classList.contains('badge')) {
        badge.classList.add('badge');
      }
      
      console.log(`‚úÖ ORDER status badge updated from "${originalText}" to "${newStatus}"`);
    });
    
    // NEW: Update button visibility based on new status
    updateButtonVisibility(newStatus);
    
    console.log('‚úÖ updateOrderStatusInUI completed - updated ORDER status badges and button visibility');
    
  } catch (error) {
    console.error('‚ùå Error updating order status UI:', error);
  }
}

// ===== INDIVIDUAL ITEM MANAGEMENT FUNCTIONS =====

// Use dynamic valid transitions

// Update populateItemStatusModal to include payment status
// update Item Payment Status in UI
function updateItemPaymentStatusInUI(itemId, newPaymentStatus) {
  console.log('üîç Updating payment status in UI:', { itemId, newPaymentStatus });
  
  try {
    let targetElement = null;
    let paymentBadge = null;
    
    //  STRATEGY 1: Find by data-item-id
    targetElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (targetElement) {
      console.log(' Found item row:', targetElement);
      
      //  ENHANCED: Multiple selector strategies for payment badge
      paymentBadge = targetElement.querySelector('.payment-badge') ||
                    targetElement.querySelector('[data-payment-status]') ||
                    targetElement.querySelector('.badge[class*="payment-"]') ||
                    targetElement.querySelector('td:nth-last-child(2) .badge'); // Payment column badge
      
      if (paymentBadge) {
        console.log(' Found payment badge via data-item-id:', paymentBadge);
      }
    }
    
    //  STRATEGY 2: Fallback search if not found
    if (!paymentBadge) {
      console.log('üîç Payment badge not found via data-item-id, searching fallback...');
      const allRows = document.querySelectorAll('tr, .item-row, .order-item');
      
      allRows.forEach(row => {
        const buttons = row.querySelectorAll('button[onclick]');
        buttons.forEach(button => {
          const onclickAttr = button.getAttribute('onclick');
          if (onclickAttr && (onclickAttr.includes(`'${itemId}'`) || onclickAttr.includes(`"${itemId}"`))) {
            console.log(' Found matching row via button onclick');
            targetElement = row;
            
            //  ENHANCED: Multiple strategies for payment badge in this row
            paymentBadge = row.querySelector('.payment-badge') ||
                          row.querySelector('[data-payment-status]') ||
                          row.querySelector('.badge[class*="payment-"]') ||
                          row.querySelector('td:nth-last-child(2) .badge');
                          
            if (paymentBadge) {
              console.log(' Found payment badge via fallback:', paymentBadge);
            }
          }
        });
      });
    }
    
    //  STRATEGY 3: Create payment badge if still not found
    if (!paymentBadge && targetElement) {
      console.log('‚ö†Ô∏è Payment badge not found, attempting to create/find...');
      
      // Look for any badge in the payment column that might have lost its classes
      const paymentColumn = targetElement.querySelector('td:nth-last-child(2)');
      if (paymentColumn) {
        const existingBadge = paymentColumn.querySelector('.badge');
        if (existingBadge) {
          console.log('üîß Found existing badge in payment column, will update:', existingBadge);
          paymentBadge = existingBadge;
          
          //  RESTORE: Add missing payment badge class
          paymentBadge.classList.add('payment-badge');
        }
      }
    }
    
    //  UPDATE: Payment badge found
    if (paymentBadge && targetElement) {
      console.log(' Updating payment badge:', paymentBadge);
      
      const originalText = paymentBadge.textContent.trim();
      paymentBadge.textContent = newPaymentStatus;
      
      //  ENHANCED: Ensure payment badge class exists
      if (!paymentBadge.classList.contains('payment-badge')) {
        paymentBadge.classList.add('payment-badge');
      }
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
      backgroundClasses.forEach(cls => paymentBadge.classList.remove(cls));
      
      // Remove old payment classes
      const classList = Array.from(paymentBadge.classList);
      classList.forEach(cls => {
        if (cls.startsWith('payment-')) {
          paymentBadge.classList.remove(cls);
        }
      });
      
      // Add new classes
      const newPaymentClass = `payment-${newPaymentStatus.toLowerCase().replace(/\s+/g, '-')}`;
      paymentBadge.classList.add(newPaymentClass);
      paymentBadge.classList.add(`bg-${getPaymentStatusColor(newPaymentStatus)}`);
      
      // Ensure badge class exists
      if (!paymentBadge.classList.contains('badge')) {
        paymentBadge.classList.add('badge');
      }
      
      // Update data attribute
      paymentBadge.setAttribute('data-payment-status', newPaymentStatus);
      
      console.log(` Payment status updated from "${originalText}" to "${newPaymentStatus}"`);
      
      // Visual feedback
      const targetRow = paymentBadge.closest('tr, .item-row, .card');
      if (targetRow) {
        targetRow.style.transition = 'background-color 0.4s ease';
        targetRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
        
        setTimeout(() => {
          targetRow.style.backgroundColor = '';
        }, 2000);
      }
      
    } else {
      console.error('‚ùå Could not find or create payment badge for item:', itemId);
      console.log('üîç Debug info:', {
        targetElement: targetElement,
        itemId: itemId,
        newPaymentStatus: newPaymentStatus
      });
      
      //  LAST RESORT: Log the actual HTML for debugging
      if (targetElement) {
        console.log('üîç Target element HTML:', targetElement.outerHTML);
      }
    }
    
  } catch (error) {
    console.error('‚ùå Error updating payment status UI:', error);
  }
}


// Fetch order status AND update valid transitions
function fetchAndUpdateOrderStatus(orderId) {
  console.log('üîç Fetching updated order status for:', orderId);
  
  fetch(`/admin/orders/api/${orderId}`, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    console.log('üîç Order status API response status:', response.status);
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error(`Expected JSON but received: ${contentType || 'unknown'}`);
    }
    
    return response.json();
  })
  .then(data => {
    console.log('üîç Order status API response data:', data);
    
    if (data.success && data.order) {
      const updatedOrderStatus = data.order.status;
      console.log('üîç Updated order status from backend:', updatedOrderStatus);
      
      //  NEW: Update valid transitions if provided
      if (data.validTransitions && Array.isArray(data.validTransitions)) {
        window.validTransitions = data.validTransitions;
        console.log('üîç Updated valid transitions for', updatedOrderStatus, ':', data.validTransitions);
      }
      
      if (updatedOrderStatus !== window.currentOrderStatus && updatedOrderStatus !== currentOrderStatus) {
        console.log(' Order status changed, updating UI:', updatedOrderStatus);
        updateOrderStatusInUI(updatedOrderStatus);
      } else {
        console.log('‚ÑπÔ∏è Order status unchanged:', updatedOrderStatus);
      }
    } else {
      console.warn('‚ö†Ô∏è Invalid response format:', data);
    }
  })
  .catch(error => {
    console.warn('‚ö†Ô∏è Could not fetch updated order status:', error.message);
    
    if (error.message.includes('404') || error.message.includes('not found')) {
      console.log('‚ÑπÔ∏è Order status API not available, skipping automatic update');
    }
  });
}

//  More precise item status UI update
function updateItemStatusInUI(itemId, newStatus) {
  console.log('üîç Starting updateItemStatusInUI:', { itemId, newStatus });
  
  try {
    let targetElement = null;
    let statusBadge = null;
    
    // Find the target row using data-item-id
    targetElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (targetElement) {
      console.log(' Found item row by data-item-id:', targetElement);
      statusBadge = targetElement.querySelector('.status-badge');
    }
    
    // Fallback: Search by onclick containing itemId
    if (!statusBadge) {
      console.log('üîç Fallback: Searching through table rows...');
      const allRows = document.querySelectorAll('tr');
      
      allRows.forEach((row, index) => {
        const buttons = row.querySelectorAll('button[onclick]');
        buttons.forEach(button => {
          const onclickAttr = button.getAttribute('onclick');
          if (onclickAttr && (onclickAttr.includes(`'${itemId}'`) || onclickAttr.includes(`"${itemId}"`))) {
            console.log(` Found matching row ${index} for itemId:`, itemId);
            targetElement = row;
            statusBadge = row.querySelector('.status-badge');
            return;
          }
        });
        if (statusBadge) return;
      });
    }
    
    if (statusBadge && targetElement) {
      console.log(' Found status badge and target row, updating...', statusBadge);
      
      //  UPDATE STATUS BADGE
      const originalText = statusBadge.textContent;
      statusBadge.textContent = newStatus;
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
      backgroundClasses.forEach(cls => statusBadge.classList.remove(cls));
      statusBadge.classList.add(`bg-${getStatusColor(newStatus)}`);
      
      console.log(` Status badge updated from "${originalText}" to "${newStatus}"`);
      
      //  UPDATE ACTION BUTTONS
      updateItemActionButtonsInRow(targetElement, newStatus, itemId);
      
      // Visual feedback
      targetElement.style.transition = 'background-color 0.4s ease';
      targetElement.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
      setTimeout(() => {
        targetElement.style.backgroundColor = '';
      }, 2000);
      
      console.log(' Successfully updated item status and actions:', { itemId, newStatus });
      
    } else {
      console.warn('‚ö†Ô∏è Could not find status badge for item:', itemId);
    }
    
  } catch (error) {
    console.error('‚ùå Error updating item status UI:', error);
  }
}






// ===== PAYMENT STATUS FUNCTIONS =====

//  ENHANCED: Improved Payment Status UI Update for Order-Level Changes
function updatePaymentStatusInUI(newPaymentStatus) {
  console.log('üîç Starting updatePaymentStatusInUI with status:', newPaymentStatus);
  
  try {
    //  FIXED: More specific selectors that match actual payment badge classes
    const paymentElements = document.querySelectorAll(
      '.status-badge[class*="payment-"], ' +
      '.payment-badge, ' +
      '.badge[class*="payment-"], ' +
      '[data-payment-status], ' +
      '.payment-status'
    );
    
    console.log('üîç Found payment elements:', paymentElements.length, paymentElements);
    
    let updated = false;
    
    paymentElements.forEach((element, index) => {
      console.log(`Payment element ${index}:`, {
        element: element,
        text: element.textContent.trim(),
        classes: element.className
      });
      
      // Skip item-level payment badges, only update order-level
      const isItemLevel = element.closest('tr, .item-row') !== null;
      if (isItemLevel) {
        console.log(`Skipping item-level payment badge ${index}`);
        return;
      }
      
      if (element) {
        const originalText = element.textContent;
        element.textContent = newPaymentStatus;
        
        if (element.classList.contains('badge') || element.classList.contains('status-badge') || element.classList.contains('payment-badge')) {
          // Remove old payment status classes
          const classesToRemove = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
          classesToRemove.forEach(cls => element.classList.remove(cls));
          
          // Remove old payment-specific classes
          const classList = Array.from(element.classList);
          classList.forEach(cls => {
            if (cls.startsWith('payment-')) {
              element.classList.remove(cls);
            }
          });
          
          // Add new payment status class and color
          const newPaymentClass = `payment-${newPaymentStatus.toLowerCase().replace(/\s+/g, '-')}`;
          element.classList.add(newPaymentClass);
          element.classList.add(`bg-${getPaymentStatusColor(newPaymentStatus)}`);
          
          // Ensure badge class is present
          if (!element.classList.contains('badge') && !element.classList.contains('status-badge') && !element.classList.contains('payment-badge')) {
            element.classList.add('payment-badge');
          }
          
          console.log(` Updated payment element ${index}:`, {
            originalText: originalText,
            newText: element.textContent,
            newClasses: element.className
          });
        }
        
        updated = true;
      }
    });
    
    if (updated) {
      console.log(' Payment status updated in UI:', newPaymentStatus);
      
      // Visual feedback
      const orderSection = document.querySelector('body');
      if (orderSection) {
        orderSection.style.transition = 'background-color 0.4s ease';
        orderSection.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';
        
        setTimeout(() => {
          orderSection.style.backgroundColor = '';
        }, 1000);
      }
    } else {
      console.warn('‚ö†Ô∏è No order-level payment elements found to update');
    }
    
  } catch (error) {
    console.error('‚ùå Error updating payment status UI:', error);
    setTimeout(() => location.reload(), 1000);
  }
}

//  ENHANCED: Payment Status Color Function



// ===== UTILITY FUNCTIONS =====

function showToast(type, message, duration = 3000) {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
  }
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  
  const toastElement = toastContainer.lastElementChild;
  const toast = new bootstrap.Toast(toastElement, {
    autohide: true,
    delay: duration
  });
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

function testReturnModal() {
  console.log('üîç Testing return modal...');
  returnItem('TEST_ORDER_ID', 'TEST_ITEM_ID');
}
</script>



