<style>
/* ========= ORDER DETAILS SPECIFIC STYLES ========= */
.order-details-container {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
}

.page-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  color: white;
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.page-subtitle {
  color: rgba(255, 255, 255, 0.85);
  margin: 0.5rem 0 0 0;
}

.back-to-orders-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  color: white;
  background-color: #ef4444;
  text-decoration: none;
}

.back-to-orders-btn:hover {
  background-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  color: white;
}

/* Status Overview Card */
.status-overview-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.status-item {
  text-align: center;
  padding: 1rem;
}

.status-item h6 {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.75rem;
}

.status-badge {
  display: inline-block;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.875rem;
}

.status-pending { background-color: #fef3c7; color: #92400e; }
.status-processing { background-color: #dbeafe; color: #1e40af; }
.status-shipped { background-color: #bfdbfe; color: #1e3a8a; }
.status-delivered { background-color: #d1fae5; color: #065f46; }
.status-cancelled { background-color: #fee2e2; color: #991b1b; }
.status-returned { background-color: #e5e7eb; color: #374151; }

.payment-pending { background-color: #fef3c7; color: #92400e; }
.payment-completed { background-color: #d1fae5; color: #065f46; }
.payment-failed { background-color: #fee2e2; color: #991b1b; }
.payment-refunded { background-color: #dbeafe; color: #1e40af; }

.amount-display {
  font-size: 1.75rem;
  font-weight: 700;
  color: #111827;
  margin: 0;
}

.action-buttons-row {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  flex-wrap: wrap;
}

.btn-update-status {
  background-color: #3b82f6;
  color: white;
  padding: 0.625rem 1.25rem;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-update-status:hover {
  background-color: #2563eb;
  transform: translateY(-1px);
}

.btn-cancel-order {
  background-color: #ef4444;
  color: white;
  padding: 0.625rem 1.25rem;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-cancel-order:hover {
  background-color: #dc2626;
  transform: translateY(-1px);
}

/* Section Cards */
.section-card {
  background: white;
  border-radius: 12px;
  padding: 0;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
  overflow: hidden;
}

.section-header {
  background-color: #f9fafb;
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #111827;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-body {
  padding: 1.5rem;
}

/* Order Summary Grid */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  background: #f9fafb;
  border-radius: 8px;
}

.summary-item.total {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: white;
  padding: 1.25rem;
}

.summary-label {
  font-weight: 500;
  color: #6b7280;
}

.summary-value {
  font-weight: 600;
  color: #111827;
  font-size: 1rem;
}

.summary-item.total .summary-label,
.summary-item.total .summary-value {
  color: white;
  font-size: 1.25rem;
}

/* Customer & Address Grid */
.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 2rem;
}

.info-section h6 {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 1rem;
}

.customer-details {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.avatar-circle {
  width: 60px;
  height: 60px;
  background-color: #dbeafe;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.avatar-circle i {
  font-size: 1.75rem;
  color: #3b82f6;
}

.customer-name {
  font-weight: 600;
  font-size: 1.125rem;
  color: #111827;
  margin: 0;
}

.customer-email {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
}

.contact-info {
  margin-top: 1rem;
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  color: #374151;
}

.address-card {
  background: #f9fafb;
  border-radius: 8px;
  padding: 1.25rem;
  border: 1px solid #e5e7eb;
}

.address-name {
  font-weight: 600;
  font-size: 1rem;
  color: #111827;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.address-type {
  font-size: 0.75rem;
  color: #6b7280;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

/* Order Items Table */
.items-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.items-table thead th {
  background-color: #f9fafb;
  color: #374151;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
  padding: 1rem;
  border-bottom: 2px solid #e5e7eb;
  text-align: left;
}

.items-table tbody td {
  padding: 1.25rem 1rem;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.items-table tbody tr:hover {
  background-color: #f9fafb;
}

.product-cell {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.product-image {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  flex-shrink: 0;
}

.product-name {
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.sku-code {
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  color: #6b7280;
  background: #f3f4f6;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}

.size-badge {
  background: #e5e7eb;
  color: #374151;
  padding: 0.25rem 0.75rem;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.875rem;
}

.status-update-btn {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.status-update-btn:hover {
  background: #e5e7eb;
  border-color: #d1d5db;
}

/* Timeline */
.timeline-compact {
  position: relative;
  padding-left: 2rem;
}

.timeline-compact::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #e5e7eb;
}

.timeline-item-compact {
  position: relative;
  margin-bottom: 1.5rem;
}

.timeline-marker-compact {
  position: absolute;
  left: -2rem;
  top: 0.25rem;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 3px solid white;
  box-shadow: 0 0 0 2px currentColor;
}

.timeline-content-compact {
  background: #f9fafb;
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

/* Responsive */
@media (max-width: 1024px) {
  .info-grid, .summary-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .back-to-orders-btn {
    width: 100%;
    justify-content: center;
  }
  
  .status-overview-card .row {
    flex-direction: column;
  }
  
  .action-buttons-row {
    flex-direction: column;
    width: 100%;
  }
  
  .action-buttons-row button {
    width: 100%;
    justify-content: center;
  }
}
</style>

<div class="order-details-container">
  <% if (order) { %>
    <!-- Breadcrumbs -->
    <%- include('./partials/breadcrumbs', {
      breadcrumbs: [
        { label: 'Dashboard', url: '/admin/dashboard', icon: 'house-door' },
        { label: 'Orders', url: '/admin/orders', icon: 'bag' },
        { label: 'Order Details', icon: 'receipt' }
      ]
    }) %>

    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="page-title">Order #<%= order.orderId %></h1>
          <p class="page-subtitle">
            <i class="bi bi-calendar3 me-2"></i>
            Placed on <%= new Date(order.createdAt).toLocaleDateString('en-IN', { 
              weekday: 'long',
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            }) %>
          </p>
        </div>
        <div class="header-right">
          <a href="/admin/orders" class="back-to-orders-btn">
            <i class="bi bi-arrow-left"></i>
            <span>Back to Orders</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Order Status Overview -->
    <div class="status-overview-card">
      <div class="row g-4">
        <div class="col-lg-2 col-md-4 col-6">
          <div class="status-item">
            <h6>Order Status</h6>
            <span class="status-badge status-<%= order.status.toLowerCase().replace(' ', '-') %>">
              <%= order.status %>
            </span>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6">
          <div class="status-item">
            <h6>Payment Status</h6>
            <span class="status-badge payment-<%= (order.paymentStatus || 'unknown').toLowerCase() %>">
              <%= order.paymentStatus || 'Unknown' %>
            </span>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 col-12">
          <div class="status-item">
            <h6>Total Amount</h6>
            <p class="amount-display">₹<%= order.totalAmount.toLocaleString('en-IN') %></p>
          </div>
        </div>
        <div class="col-lg-6 col-12">
          <div class="status-item">
            <h6>Actions</h6>
            <div class="action-buttons-row">
              <% if (order.status !== 'Delivered' && order.status !== 'Cancelled' && order.status !== 'Returned') { %>
                <button class="btn-update-status" onclick="updateOrderStatus('<%= order.orderId %>', '<%= order.status %>')">
                  <i class="bi bi-pencil"></i>Update Status
                </button>
              <% } %>
              
              <% if (order.status === ORDER_STATUS.PENDING || order.status === ORDER_STATUS.PROCESSING) { %>
                <button id="cancelOrderBtn" class="btn-cancel-order" onclick="showCancelOrderConfirm('<%= order.orderId %>')">
                  <i class="bi bi-x-circle"></i>Cancel Order
                </button>
              <% } %>
              
              <% if (order.status === ORDER_STATUS.DELIVERED) { %>
                <button id="returnOrderBtn" class="btn-cancel-order" onclick="showReturnOrderConfirm('<%= order.orderId %>')">
                  <i class="bi bi-arrow-counterclockwise"></i>Return Order
                </button>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Summary Section -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="section-title">
          <i class="bi bi-receipt"></i>
          Order Summary
        </h5>
      </div>
      <div class="section-body">
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Subtotal:</span>
            <span class="summary-value">₹<%= order.subtotal.toLocaleString('en-IN') %></span>
          </div>
          <% if (order.totalDiscount > 0) { %>
            <div class="summary-item">
              <span class="summary-label" style="color: #10b981;">Discount:</span>
              <span class="summary-value" style="color: #10b981;">-₹<%= order.totalDiscount.toLocaleString('en-IN') %></span>
            </div>
          <% } %>
          <div class="summary-item">
            <span class="summary-label">Shipping:</span>
            <span class="summary-value"><%= order.shipping === 0 ? 'Free' : '₹' + order.shipping.toLocaleString('en-IN') %></span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Payment Method:</span>
            <span class="summary-value text-uppercase">
              <%= order.paymentMethod === 'cod' ? 'Cash on Delivery' : order.paymentMethod %>
            </span>
          </div>
          <div class="summary-item total">
            <span class="summary-label">Total Amount:</span>
            <span class="summary-value">₹<%= order.totalAmount.toLocaleString('en-IN') %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer & Delivery Information -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="section-title">
          <i class="bi bi-person-circle"></i>
          Customer & Delivery Information
        </h5>
      </div>
      <div class="section-body">
        <div class="info-grid">
          <!-- Customer Details -->
          <div class="info-section">
            <h6>Customer Details</h6>
            <div class="customer-details">
              <div class="avatar-circle">
                <i class="bi bi-person"></i>
              </div>
              <div>
                <p class="customer-name"><%= order.user?.name || 'N/A' %></p>
                <p class="customer-email"><%= order.user?.email || 'N/A' %></p>
              </div>
            </div>
            <div class="contact-info">
              <% if (order.deliveryAddress && order.deliveryAddress.phone) { %>
                <div class="contact-item">
                  <i class="bi bi-telephone"></i>
                  <span><strong>Phone:</strong> <%= order.deliveryAddress.phone %></span>
                </div>
                <% if (order.deliveryAddress.altPhone) { %>
                  <div class="contact-item">
                    <i class="bi bi-telephone"></i>
                    <span><strong>Alt Phone:</strong> <%= order.deliveryAddress.altPhone %></span>
                  </div>
                <% } %>
              <% } else if (order.shippingAddress && order.shippingAddress.phone) { %>
                <div class="contact-item">
                  <i class="bi bi-telephone"></i>
                  <span><strong>Phone:</strong> <%= order.shippingAddress.phone %></span>
                </div>
              <% } else { %>
                <div class="contact-item">
                  <i class="bi bi-telephone"></i>
                  <span><strong>Phone:</strong> Not available</span>
                </div>
              <% } %>
            </div>
          </div>
          
          <!-- Delivery Address -->
          <div class="info-section">
            <h6>Delivery Address</h6>
            <% if (order.deliveryAddress) { %>
              <div class="address-card">
                <p class="address-name">
                  <i class="bi bi-geo-alt"></i>
                  <%= order.deliveryAddress.name || 'N/A' %>
                </p>
                <% if (order.deliveryAddress.addressType) { %>
                  <p class="address-type"><%= order.deliveryAddress.addressType %></p>
                <% } %>
                <% if (order.deliveryAddress.landMark) { %>
                  <p class="mb-2"><%= order.deliveryAddress.landMark %></p>
                <% } %>
                <% if (order.deliveryAddress.city || order.deliveryAddress.state) { %>
                  <p class="mb-2">
                    <%= order.deliveryAddress.city || '' %><%= order.deliveryAddress.city && order.deliveryAddress.state ? ', ' : '' %><%= order.deliveryAddress.state || '' %>
                  </p>
                <% } %>
                <% if (order.deliveryAddress.pincode) { %>
                  <p class="mb-0"><strong>PIN:</strong> <%= order.deliveryAddress.pincode %></p>
                <% } %>
              </div>
            <% } else { %>
              <div class="address-card text-center">
                <i class="bi bi-geo-alt" style="font-size: 2rem; color: #9ca3af;"></i>
                <p class="text-muted mt-2 mb-0">No delivery address available</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Items -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="section-title">
          <i class="bi bi-bag"></i>
          Order Items (<%= order.totalItemCount %> items)
        </h5>
      </div>
      <div class="section-body" style="padding: 0; overflow-x: auto;">
        <table class="items-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU</th>
              <th>Size</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Total</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% order.items.forEach(item => { %>
              <tr data-item-id="<%= item._id %>">
                <td>
                  <div class="product-cell">
                    <% if (item.productId && item.productId.mainImage) { %>
                      <img src="<%= item.productId.mainImage %>" 
                          alt="<%= item.productId.productName %>" 
                          class="product-image">
                    <% } else { %>
                      <div class="product-image" style="background-color: #f3f4f6; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-image" style="color: #9ca3af;"></i>
                      </div>
                    <% } %>
                    <h6 class="product-name">
                      <%= item.productId ? item.productId.productName : 'Product Name' %>
                    </h6>
                  </div>
                </td>
                <td><code class="sku-code"><%= item.sku %></code></td>
                <td><span class="size-badge"><%= item.size %></span></td>
                <td><strong><%= item.quantity %></strong></td>
                <td>₹<%= item.price.toLocaleString('en-IN') %></td>
                <td><strong>₹<%= item.totalPrice.toLocaleString('en-IN') %></strong></td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <span class="status-badge item-<%= (item.status || 'pending').toLowerCase() %> bg-<%= getStatusColor(item.status || 'Pending') %>"
                          id="item-status-<%= item._id %>">
                      <%= item.status || 'Pending' %>
                    </span>
                    <% if (item.status !== 'Cancelled' && item.status !== 'Returned') { %>
                      <button class="status-update-btn" 
                              data-item-id="<%= item._id %>"
                              data-current-status="<%= item.status %>"
                              data-valid-transitions="<%- encodeURIComponent(JSON.stringify(item.validTransitions || [])) %>"
                              title="Update Status">
                        <i class="bi bi-pencil"></i>
                      </button>
                    <% } %>
                  </div>
                </td>
                <td>
                  <span class="status-badge payment-<%= (item.paymentStatus || 'pending').toLowerCase().replace(/\s+/g, '-') %> bg-<%= getPaymentStatusColor(item.paymentStatus || 'Pending') %>" 
                        data-payment-status="<%= item.paymentStatus || 'Pending' %>"
                        id="item-payment-<%= item._id %>">
                    <%= item.paymentStatus || 'Pending' %>
                  </span>
                </td>
                <td>
                  <% if (item.status === ORDER_STATUS.DELIVERED) { %>
                    <button class="btn btn-sm btn-outline-warning" 
                            onclick="showReturnItemConfirm('<%= order.orderId %>', '<%= item._id %>')"
                            title="Create return request">
                      <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                  <% } else { %>
                    <span class="text-muted small">No actions</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Order Timeline -->
    <% if (order.comprehensiveStatusHistory && order.comprehensiveStatusHistory.length > 0) { %>
      <div class="section-card">
        <div class="section-header">
          <div class="d-flex justify-content-between align-items-center w-100">
            <h5 class="section-title">
              <i class="bi bi-clock-history"></i>
              Order Timeline
            </h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#orderTimeline">
              <i class="bi bi-chevron-down"></i>
            </button>
          </div>
        </div>
        <div class="collapse show" id="orderTimeline">
          <div class="section-body">
            <div class="timeline-compact">
              <% order.comprehensiveStatusHistory.forEach((history, index) => { %>
                <div class="timeline-item-compact">
                  <div class="timeline-marker-compact bg-<%= 
                    history.status === 'Delivered' ? 'success' : 
                    history.status === 'Shipped' ? 'info' : 
                    history.status === 'Processing' ? 'warning' : 
                    history.status === 'Cancelled' ? 'danger' : 
                    history.status === 'Returned' ? 'secondary' :
                    history.status === 'Partially Cancelled' ? 'warning' : 'secondary' 
                  %>"></div>
                  <div class="timeline-content-compact">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="fw-bold mb-1">
                          <% if (history.type === 'item') { %>
                            <span class="badge bg-info me-2">Item</span>
                          <% } else { %>
                            <span class="badge bg-primary me-2">Order</span>
                          <% } %>
                          <% if (history.status === 'Returned') { %>
                            Return Request
                          <% } else { %>
                            <%= history.status %>
                          <% } %>
                        </h6>
                        <% if (history.notes) { %>
                          <p class="mb-1 small text-muted"><%= history.notes %></p>
                        <% } %>
                        <% if (history.itemName) { %>
                          <small class="text-info d-block mt-1">
                            <i class="bi bi-box me-1"></i><%= history.itemName %>
                          </small>
                        <% } %>
                      </div>
                      <small class="text-muted">
                        <%= new Date(history.updatedAt).toLocaleDateString('en-IN', { 
                          month: 'short', 
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        }) %>
                      </small>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      </div>
    <% } %>

  <% } else { %>
    <!-- Error State -->
    <div class="text-center py-5">
      <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #9ca3af;"></i>
      <h3 class="text-muted mt-3">Order Not Found</h3>
      <p class="text-muted mb-4">The requested order could not be found.</p>
      <a href="/admin/orders" class="back-to-orders-btn">
        <i class="bi bi-arrow-left"></i>Back to Orders
      </a>
    </div>
  <% } %>
</div>

<!-- Modals (keeping existing modals from your file) -->
<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title text-dark">Update Order Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 p-3 bg-light border rounded">
          <div class="row">
            <div class="col-sm-6">
              <small class="text-muted">Current Status:</small>
              <div class="fw-bold"><%= order.status %></div>
            </div>
            <div class="col-sm-6">
              <small class="text-muted">Note:</small>
              <div><small>All items in this order will be updated to the new status automatically</small></div>
            </div>
          </div>
        </div>
        
        <form id="updateStatusForm">
          <input type="hidden" id="statusOrderId" name="orderId">
          <div class="mb-3">
            <label for="orderStatus" class="form-label">New Status</label>
            <select class="form-select" id="orderStatus" name="status" required>
              <!-- Options populated dynamically by JavaScript -->
            </select>
            <small class="form-text text-muted">
              Only valid status transitions are shown. Cancellations and returns are managed by users.
            </small>
          </div>
          <div class="mb-3">
            <label for="statusNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="statusNotes" name="notes" rows="3" 
                      placeholder="Add any notes about this status change..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" onclick="submitStatusUpdate()">Update Status</button>
      </div>
    </div>
  </div>
</div>

<!-- Return Item Modal -->
<div class="modal fade" id="returnItemModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title text-dark">Return Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 p-3 bg-light border rounded">
          <small class="text-muted">
            This will create a return request for the selected item. The request will need approval before the item is marked as returned.
          </small>
        </div>
        
        <form id="returnItemForm">
          <input type="hidden" id="returnOrderId" name="orderId">
          <input type="hidden" id="returnItemId" name="itemId">
          
          <div class="mb-3">
            <label for="returnReason" class="form-label">Return Reason <span class="text-danger">*</span></label>
            <select class="form-select" id="returnReason" name="reason" required>
              <option value="">Select a return reason...</option>
              <% returnReasons.forEach(reason => { %>
                <option value="<%= reason %>"><%= reason %></option>
              <% }); %>
            </select>
            <small class="form-text text-muted">Please select the most appropriate reason for this return.</small>
          </div>
          
          <div class="mb-3">
            <label for="returnNotes" class="form-label">Additional Notes (Optional)</label>
            <textarea class="form-control" id="returnNotes" name="notes" rows="2" 
                      placeholder="Add any additional details about this return..."></textarea>
            <small class="form-text text-muted">Any additional context that might be helpful for processing the return.</small>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="submitItemReturn()">Create Return Request</button>
      </div>
    </div>
  </div>
</div>




<script>
//  Get valid transitions from template data
let validTransitions = <%- JSON.stringify(validTransitions) %>;
let currentOrderStatus = '<%= order.status %>';

// Helper functions for status colors
function getStatusColor(status) {
  const colorMap = {
    'Pending': 'warning',
    'Processing': 'info',
    'Shipped': 'primary',
    'Delivered': 'success',
    'Processing Return': 'warning',
    'Returned': 'secondary',
    'Cancelled': 'danger',
    'Partially Delivered': 'primary',
    'Partially Cancelled': 'danger',
    'Partially Returned': 'secondary'
  };
  return colorMap[status] || 'secondary';
}

function getPaymentStatusColor(status) {
  const colorMap = {
    'Pending': 'warning',
    'Completed': 'success',
    'Failed': 'danger', 
    'Refunded': 'info',
    'Cancelled': 'secondary',
    'Partially Completed': 'primary',
    'Partially Refunded': 'secondary'
  };
  return colorMap[status] || 'secondary';
}

// Initialize modal event system when page loads
document.addEventListener('DOMContentLoaded', function() {
  
  // Set global order ID
  window.currentOrderId = '<%= order.orderId %>';
  
  // Event delegation for status update buttons
  document.body.addEventListener('click', function(event) {
    const button = event.target.closest('.status-update-btn');
    if (button) {
      event.preventDefault();
      
      const itemId = button.getAttribute('data-item-id');
      const currentStatus = button.getAttribute('data-current-status');
      const validTransitionsEncoded = button.getAttribute('data-valid-transitions');
      
      let validTransitions = [];
      try {
        validTransitions = JSON.parse(decodeURIComponent(validTransitionsEncoded || '[]'));
      } catch (e) {
        console.error('Error parsing validTransitions:', e);
        validTransitions = [];
      }
      
      showStatusModal(itemId, currentStatus, validTransitions);
    }
  });
});

// Build and show status modal
function showStatusModal(itemId, currentStatus, validTransitions) {
 
  
  let modalHtml = '';
  modalHtml += '<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">';
  modalHtml += '  <div class="modal-dialog modal-dialog-centered">';
  modalHtml += '    <div class="modal-content">';
  modalHtml += '      <div class="modal-header">';
  modalHtml += '        <h5 class="modal-title" id="statusModalLabel">Change Item Status</h5>';
  modalHtml += '        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>';
  modalHtml += '      </div>';
  modalHtml += '      <div class="modal-body">';
  modalHtml += '        <p class="mb-3"><strong>Current Status:</strong> <span class="badge bg-secondary">' + currentStatus + '</span></p>';
  modalHtml += '        <p class="text-muted small mb-3">Select new status:</p>';
  modalHtml += '        <div class="list-group">';

  if (validTransitions && validTransitions.length > 0) {
    for (let i = 0; i < validTransitions.length; i++) {
      let status = validTransitions[i];
      modalHtml += '          <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" ';
      modalHtml += '                  data-item-id="' + itemId + '" data-new-status="' + status + '">';
      modalHtml += '            <i class="bi bi-arrow-right me-2 text-muted"></i>';
      modalHtml += '            <span>' + status + '</span>';
      modalHtml += '          </button>';
    }
  } else {
    modalHtml += '          <div class="list-group-item text-center text-muted">';
    modalHtml += '            <i class="bi bi-info-circle me-2"></i>No transitions available';
    modalHtml += '          </div>';
  }

  modalHtml += '        </div>';
  modalHtml += '      </div>';
  modalHtml += '    </div>';
  modalHtml += '  </div>';
  modalHtml += '</div>';

  // Remove existing modal
  const existingModal = document.getElementById('statusModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Add and show modal
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('statusModal'));
  modal.show();
  
  // Add click listeners to status options
  const statusOptions = document.querySelectorAll('#statusModal .list-group-item[data-new-status]');
  statusOptions.forEach(function(option) {
    option.addEventListener('click', function() {
      const itemId = this.getAttribute('data-item-id');
      const newStatus = this.getAttribute('data-new-status');
      changeItemStatus(itemId, newStatus);
    });
  });
}

// Handle status change
function changeItemStatus(itemId, newStatus) {
 
  
  // Close modal
  const modalElement = document.getElementById('statusModal');
  if (modalElement) {
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
      modalInstance.hide();
    }
  }

  // Call existing updateItemStatus function
  if (window.currentOrderId) {
    updateItemStatus(window.currentOrderId, itemId, newStatus);
  } else {
    console.error('❌ Order ID not set');
    showToast('error', 'Order ID not found');
  }
}

// ===== DYNAMIC BUTTON VISIBILITY FUNCTIONS =====

/**
 * Update button visibility based on order status
 * @param {string} newOrderStatus - The new order status
 */
function updateButtonVisibility(newOrderStatus) {

  
  const cancelOrderBtn = document.getElementById('cancelOrderBtn');
  const returnOrderBtn = document.getElementById('returnOrderBtn');
  
  // Define status constants (matching your enums)
  const ORDER_STATUS = {
    PENDING: 'Pending',
    PROCESSING: 'Processing', 
    SHIPPED: 'Shipped',
    DELIVERED: 'Delivered',
    CANCELLED: 'Cancelled',
    PARTIALLY_CANCELLED: 'Partially Cancelled',
    RETURNED: 'Returned',
    PARTIALLY_RETURNED: 'Partially Returned',
    PARTIALLY_DELIVERED: 'Partially Delivered',
    PROCESSING_RETURN: 'Processing Return'
  };
  
  //  CANCEL BUTTON LOGIC: Show only for Pending/Processing
  const showCancelButton = (newOrderStatus === ORDER_STATUS.PENDING || newOrderStatus === ORDER_STATUS.PROCESSING);
  
  if (showCancelButton) {
    if (!cancelOrderBtn) {
      // Create cancel button if it doesn't exist
      createCancelOrderButton();
    } else {
      // Show existing cancel button
      cancelOrderBtn.style.display = 'inline-block';
      cancelOrderBtn.disabled = false;
   
    }
  } else {
    if (cancelOrderBtn) {
      // Hide cancel button
      cancelOrderBtn.style.display = 'none';
    
    }
  }
  
  //  RETURN BUTTON LOGIC: Show only for Delivered
  const showReturnButton = (newOrderStatus === ORDER_STATUS.DELIVERED);
  
  if (showReturnButton) {
    if (!returnOrderBtn) {
      // Create return button if it doesn't exist
      createReturnOrderButton();
    } else {
      // Show existing return button
      returnOrderBtn.style.display = 'inline-block';
      returnOrderBtn.disabled = false;
      
    }
  } else {
    if (returnOrderBtn) {
      // Hide return button
      returnOrderBtn.style.display = 'none';
   
    }
  }
  
  
}

/**
 * Create cancel order button dynamically
 */
function createCancelOrderButton() {
  const buttonsContainer = document.querySelector('.d-flex.gap-2.justify-content-lg-end');
  if (buttonsContainer) {
    const cancelBtn = document.createElement('button');
    cancelBtn.id = 'cancelOrderBtn';
    cancelBtn.className = 'btn btn-danger';
    cancelBtn.onclick = () => showCancelOrderConfirm('<%= order.orderId %>');
    cancelBtn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Cancel Order';
    
    // Insert after the status update button
    const statusButton = buttonsContainer.querySelector('.btn-primary, .btn-secondary');
    if (statusButton) {
      statusButton.insertAdjacentElement('afterend', cancelBtn);
    } else {
      buttonsContainer.appendChild(cancelBtn);
    }
    
    
  }
}

/**
 * Create return order button dynamically
 */
function createReturnOrderButton() {
  const buttonsContainer = document.querySelector('.d-flex.gap-2.justify-content-lg-end');
  if (buttonsContainer) {
    const returnBtn = document.createElement('button');
    returnBtn.id = 'returnOrderBtn';
    returnBtn.className = 'btn btn-warning';
    returnBtn.onclick = () => showReturnOrderConfirm('<%= order.orderId %>');
    returnBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise me-2"></i>Return Order';
    
    // Add to the end of buttons container
    buttonsContainer.appendChild(returnBtn);
    
    
  }
}


// ===== Cancel ORDER MANAGEMENT FUNCTIONS =====

function showCancelOrderConfirm(orderId) {
  Swal.fire({
    title: 'Cancel Entire Order?',
    text: 'This will cancel ALL items in this order and cannot be undone. Stock will be restored.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, Cancel Order',
    cancelButtonText: 'Keep Order',
    width: '500px'
  }).then((result) => {
    if (result.isConfirmed) {
      // Show loading state
      Swal.fire({
        title: 'Cancelling Order...',
        text: 'Please wait while we process the cancellation',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Make API call
      fetch(`/admin/orders/${orderId}/cancel`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          reason: 'Order cancelled by admin'
        })
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Order Cancelled!',
            text: data.message,
            confirmButtonColor: '#000'
          }).then(() => {
            // Update UI dynamically
            updateOrderStatusInUI('Cancelled');
            updateOrderPaymentStatusInUI(data.order.paymentStatus);
            
            // Update all item statuses to cancelled
            const itemRows = document.querySelectorAll('[data-item-id]');
            itemRows.forEach(row => {
              const itemId = row.getAttribute('data-item-id');
              updateItemStatusInUI(itemId, 'Cancelled');
              
              // Hide cancel buttons since items are now cancelled
              const cancelButton = row.querySelector('button[onclick*="showCancelItemConfirm"]');
              if (cancelButton) {
                cancelButton.style.display = 'none';
              }
            });
            
            // Hide the cancel order button
            const cancelOrderBtn = document.querySelector('button[onclick*="showCancelOrderConfirm"]');
            if (cancelOrderBtn) {
              cancelOrderBtn.style.display = 'none';
            }
            
            showToast('success', 'Order cancelled successfully. Stock restored.');
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Cancellation Failed',
            text: data.message || 'Failed to cancel order',
            confirmButtonColor: '#dc3545'
          });
        }
      })
      .catch(error => {
        Swal.close();
        console.error('Error cancelling order:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to cancel order. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    }
  });
}

// function showCancelItemConfirm(orderId, itemId) {
//   // Get item details for confirmation
//   const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
//   const productName = itemRow ? itemRow.querySelector('h6').textContent.trim() : 'this item';
  
//   Swal.fire({
//     title: 'Cancel Item?',
//     html: `
//       <p>Do you want to cancel <strong>${productName}</strong>?</p>
//       <p class="text-muted small">This action cannot be undone and stock will be restored.</p>
//     `,
//     icon: 'warning',
//     showCancelButton: true,
//     confirmButtonColor: '#dc3545',
//     cancelButtonColor: '#6c757d',
//     confirmButtonText: 'Yes, Cancel Item',
//     cancelButtonText: 'Keep Item',
//     width: '450px'
//   }).then((result) => {
//     if (result.isConfirmed) {
//       // Show loading state
//       Swal.fire({
//         title: 'Cancelling Item...',
//         text: 'Please wait while we process the cancellation',
//         allowOutsideClick: false,
//         allowEscapeKey: false,
//         showConfirmButton: false,
//         didOpen: () => {
//           Swal.showLoading();
//         }
//       });

//       // Make API call
//       fetch(`/admin/orders/${orderId}/items/${itemId}/cancel`, {
//         method: 'PATCH',
//         headers: {
//           'Content-Type': 'application/json',
//         },
//         body: JSON.stringify({ 
//           reason: 'Item cancelled by admin'
//         })
//       })
//       .then(response => response.json())
//       .then(data => {
//         Swal.close();
        
//         if (data.success) {
//           Swal.fire({
//             icon: 'success',
//             title: 'Item Cancelled!',
//             text: data.message,
//             confirmButtonColor: '#000'
//           }).then(() => {
//             // Update UI dynamically
//             updateItemStatusInUI(itemId, 'Cancelled');
            
//             // Update item payment status
//             const cancelledItem = data.order.items.find(item => item._id.toString() === itemId);
//             if (cancelledItem) {
//               updateItemPaymentStatusInUI(itemId, cancelledItem.paymentStatus);
//             }
            
//             // Update order-level statuses
//             updateOrderStatusInUI(data.order.status);
//             updateOrderPaymentStatusInUI(data.order.paymentStatus);
            
//             // Hide the cancel button for this item
//             const cancelButton = itemRow.querySelector('button[onclick*="showCancelItemConfirm"]');
//             if (cancelButton) {
//               cancelButton.parentElement.innerHTML = '<span class="text-muted small">Cancelled</span>';
//             }
            
//             showToast('success', `${productName} cancelled successfully. Stock restored.`);
//           });
//         } else {
//           Swal.fire({
//             icon: 'error',
//             title: 'Cancellation Failed',
//             text: data.message || 'Failed to cancel item',
//             confirmButtonColor: '#dc3545'
//           });
//         }
//       })
//       .catch(error => {
//         Swal.close();
//         console.error('Error cancelling item:', error);
//         Swal.fire({
//           icon: 'error',
//           title: 'Network Error',
//           text: 'Failed to cancel item. Please try again.',
//           confirmButtonColor: '#dc3545'
//         });
//       });
//     }
//   });
// }

// ===== RETURN ORDER FUNCTIONS =====

// Return entire order with confirmation


function showReturnOrderConfirm(orderId) {
  Swal.fire({
    title: 'Create Return Request for Order?',
    text: 'This will create return requests for ALL delivered items in this order.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ffc107',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, Create Return Requests',
    cancelButtonText: 'Cancel',
    width: '500px'
  }).then((result) => {
    if (result.isConfirmed) {
      // Show loading state
      Swal.fire({
        title: 'Creating Return Requests...',
        text: 'Please wait while we process the return requests',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Make API call
      fetch(`/admin/orders/${orderId}/return`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          reason: 'Return requested by admin'
        })
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Return Requests Created!',
            text: data.message,
            confirmButtonColor: '#ffc107'
          }).then(() => {
            // Reload page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed to Create Return Requests',
            text: data.message || 'Failed to create return requests',
            confirmButtonColor: '#dc3545'
          });
        }
      })
      .catch(error => {
        Swal.close();
        console.error('Error creating return requests:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to create return requests. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    }
  });
}

// Return individual item with confirmation
function showReturnItemConfirm(orderId, itemId) {
  // Get item details for confirmation
  const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
  const productName = itemRow ? itemRow.querySelector('h6').textContent.trim() : 'this item';
  
  Swal.fire({
    title: 'Create Return Request?',
    html: `
      <p>Do you want to create a return request for <strong>${productName}</strong>?</p>
      <p class="text-muted small">This will create a return request that needs to be approved later.</p>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ffc107',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Yes, Create Return Request',
    cancelButtonText: 'Cancel',
    width: '450px'
  }).then((result) => {
    if (result.isConfirmed) {
      // Show loading state
      Swal.fire({
        title: 'Creating Return Request...',
        text: 'Please wait while we process the return request',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Make API call
      fetch(`/admin/orders/${orderId}/items/${itemId}/return`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          reason: 'Return requested by admin'
        })
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Return Request Created!',
            text: data.message,
            confirmButtonColor: '#ffc107'
          }).then(() => {
            // Reload page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed to Create Return Request',
            text: data.message || 'Failed to create return request',
            confirmButtonColor: '#dc3545'
          });
        }
      })
      .catch(error => {
        Swal.close();
        console.error('Error creating return request:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to create return request. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    }
  });
}




// Add debugging to modal opening
function updateOrderStatus(orderId, currentStatus) {
  try {
  
    
    const actualCurrentStatus = window.currentOrderStatus || currentStatus;
    const currentValidTransitions = window.validTransitions || validTransitions;
    
    //  NEW: Filter out restricted statuses for admin
    const restrictedStatuses = ['Cancelled', 'Processing Return', 'Returned'];
    const adminAllowedTransitions = currentValidTransitions.filter(status => 
      !restrictedStatuses.includes(status)
    );
    
   
    
    if (!adminAllowedTransitions || adminAllowedTransitions.length === 0) {
      console.warn('⚠️ No admin-allowed transitions available');
      showToast('info', `No status transitions available from '${actualCurrentStatus}' for admin users`);
      return;
    }

    // Populate modal
    document.getElementById('statusOrderId').value = orderId;
    document.getElementById('statusNotes').value = '';
    
    const statusSelect = document.getElementById('orderStatus');
    statusSelect.innerHTML = '';
    
    // Current status option
    const currentOption = document.createElement('option');
    currentOption.value = '';
    currentOption.textContent = `${actualCurrentStatus} (Current Status)`;
    currentOption.disabled = true;
    currentOption.selected = true;
    currentOption.style.fontWeight = 'bold';
    currentOption.style.color = '#6c757d';
    statusSelect.appendChild(currentOption);
    
    // Separator
    const separatorOption = document.createElement('option');
    separatorOption.value = '';
    separatorOption.textContent = '──────────────────';
    separatorOption.disabled = true;
    statusSelect.appendChild(separatorOption);
    
    //  UPDATED: Add only admin-allowed transitions
    adminAllowedTransitions.forEach((status, index) => {
      if (status !== actualCurrentStatus) {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusSelect.appendChild(option);
      
      }
    });
    
    
    
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
    
  } catch (error) {
    console.error('❌ Error opening modal:', error);
    showToast('error', 'Failed to open status update modal');
  }
}

// Update individual item status
async function updateItemStatus(orderId, itemId, newStatus) {
  try {
    // Get item details for better messaging
    const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
    const productName = itemRow ? itemRow.querySelector('h6').textContent.trim() : 'Item';
    const currentStatus = itemRow ? itemRow.querySelector('.status-badge').textContent.trim() : 'Unknown';

    // ✅ CLEAN & MINIMAL: Simple confirmation modal
    const result = await Swal.fire({
      title: 'Update Status?',
      text: `Change ${productName} from ${currentStatus} to ${newStatus}?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Update',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#007bff',
      cancelButtonColor: '#6c757d',
      width: '350px',
      backdrop: true,
      allowOutsideClick: true
    });

    if (!result.isConfirmed) return;

    // Show loading modal
    Swal.fire({
      title: 'Updating...',
      text: 'Please wait',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Make API call
    const response = await fetch(`/admin/orders/${orderId}/items/${itemId}/status`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        status: newStatus,
        notes: `Item status updated to ${newStatus} by admin`
      })
    });

    const data = await response.json();

    if (data.success) {
      // ✅ CRITICAL: Close loading modal first
      Swal.close();
      
      // Show success toast
      showToast('success', `${productName} updated to ${newStatus}`);
      
      // Update UI with smooth animations
      updateItemStatusInUI(itemId, newStatus);
      if (data.order.changes) {
        updateItemPaymentStatusInUI(itemId, data.order.changes.newItemPaymentStatus);
        updateOrderStatusInUI(data.order.status);
        updateOrderPaymentStatusInUI(data.order.paymentStatus);
      }

      // Add visual feedback to updated row
      const updatedRow = document.querySelector(`[data-item-id="${itemId}"]`);
      if (updatedRow) {
        updatedRow.style.animation = 'updateSuccess 0.6s ease-out';
      }

    } else {
      throw new Error(data.message);
    }

  } catch (error) {
    console.error('Error updating item status:', error);
    
    // ✅ CRITICAL: Close loading modal before showing error
    Swal.close();
    
    // Show error modal
    Swal.fire({
      title: 'Update Failed',
      text: error.message || 'An unexpected error occurred',
      icon: 'error',
      confirmButtonText: 'OK',
      confirmButtonColor: '#dc3545'
    });
  }
}


function submitStatusUpdate() {
  const form = document.getElementById('updateStatusForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  const newStatus = formData.get('status');
  
  if (!newStatus || newStatus === '') {
    showToast('error', 'Please select a new status');
    return;
  }

  //  UPDATED: Validate against admin-allowed transitions
  const restrictedStatuses = ['Cancelled', 'Processing Return', 'Returned'];
  const currentValidTransitions = window.validTransitions || validTransitions;
  const adminAllowedTransitions = currentValidTransitions.filter(status => 
    !restrictedStatuses.includes(status)
  );
  
  if (!adminAllowedTransitions.includes(newStatus)) {
    console.error('❌ Invalid admin transition:', {
      selectedStatus: newStatus,
      adminAllowedTransitions: adminAllowedTransitions
    });
    showToast('error', 'Invalid status transition selected for admin users');
    return;
  }

  const submitBtn = document.querySelector('#updateStatusModal .btn-dark');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'Updating...';

  fetch(`/admin/orders/${orderId}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      status: newStatus,
      notes: formData.get('notes')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();

     

      // Update UI
      updateOrderStatusInUI(data.order.status);
      updateOrderPaymentStatusInUI(data.order.paymentStatus);
      
      // Update all item statuses and payment statuses
      if (data.order.items && data.order.items.length > 0) {
        data.order.items.forEach((item, index) => {
          
          
          updateItemStatusInUI(item._id, item.status);
          updateItemPaymentStatusInUI(item._id, item.paymentStatus);
        });
      }
      
      // Update modal data for next time
      updateModalDataAfterStatusChange(orderId, data.order.status);
      
      //  NEW: Disable update button if order is now delivered
      if (data.order.status === 'Delivered') {
        setTimeout(() => {
          location.reload(); // Reload to update the button state
        }, 1500);
      }
      
    } else {
      throw new Error(data.message || 'Failed to update order status');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', error.message || 'Error updating order status');
  })
  .finally(() => {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  });
}

// Add debugging to see what's happening
function updateModalDataAfterStatusChange(orderId, newCurrentStatus) {

  
  //  Fetch new valid transitions for the updated status
  fetch(`/admin/orders/${orderId}/transitions`)
    .then(response => {
     
      return response.json();
    })
    .then(data => {
      
      
      if (data.success && data.allowedTransitions) {
        //  Update global variables for next modal open
        window.currentOrderStatus = newCurrentStatus;
        window.validTransitions = data.allowedTransitions;

        validTransitions = data.allowedTransitions;
        
  
        
      } else {
        console.warn('❌ Could not fetch updated transitions:', data);
      }
    })
    .catch(error => {
      console.error('❌ Error updating modal data:', error);
    });
}


// Update order-level payment status badges via fetch
function updateOrderPaymentStatusInUI(newPaymentStatus) {

  
  try {
    // Find order-level payment badges (not item-level ones)
    const orderPaymentBadges = document.querySelectorAll('.status-badge[class*="payment-"]');
    
    orderPaymentBadges.forEach((badge, index) => {
      // Skip item-level payment badges
      const isItemLevel = badge.closest('tr, .item-row') !== null;
      if (isItemLevel) {
        return;
      }
      
     
      
      const originalText = badge.textContent;
      badge.textContent = newPaymentStatus;
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
      backgroundClasses.forEach(cls => badge.classList.remove(cls));
      
      // Remove old payment classes
      const classList = Array.from(badge.classList);
      classList.forEach(cls => {
        if (cls.startsWith('payment-')) {
          badge.classList.remove(cls);
        }
      });
      
      // Add new classes
      const newPaymentClass = `payment-${newPaymentStatus.toLowerCase().replace(/\s+/g, '-')}`;
      badge.classList.add(newPaymentClass);
      badge.classList.add(`bg-${getPaymentStatusColor(newPaymentStatus)}`);
      
      
    });
    
   
    
  } catch (error) {
    console.error('❌ Error updating order payment status UI:', error);
  }
}


// More precise order status badge update (excludes item badges)
function updateOrderStatusInUI(newStatus) {
  
  try {
    // FIXED: More specific selector that EXCLUDES payment badges
    const allElements = document.querySelectorAll('.status-badge, .badge');
    const orderBadges = [];
    
    allElements.forEach(element => {
      const isInItemRow = element.closest('tr, .item-row') !== null;
      const isPaymentBadge = element.classList.contains('payment-badge') || 
                            element.className.includes('payment-') ||
                            element.hasAttribute('data-payment-status');
      const isStatusBadge = element.classList.contains('status-badge') && 
                           !isPaymentBadge;
      
      // ONLY include order status badges, NOT payment badges
      if (!isInItemRow && isStatusBadge) {
        orderBadges.push(element);
     
      }
    });
    
 
    
    // FIXED: Only update order status badges
    orderBadges.forEach((badge, index) => {
      
      const originalText = badge.textContent.trim();
      badge.textContent = newStatus;
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info'];
      backgroundClasses.forEach(cls => badge.classList.remove(cls));
      badge.classList.add(`bg-${getStatusColor(newStatus)}`);
      
      if (!badge.classList.contains('badge')) {
        badge.classList.add('badge');
      }
      
  
    });
    
    // NEW: Update button visibility based on new status
    updateButtonVisibility(newStatus);
    
    
    
  } catch (error) {
    console.error('❌ Error updating order status UI:', error);
  }
}

// ===== INDIVIDUAL ITEM MANAGEMENT FUNCTIONS =====

// Use dynamic valid transitions

// Update populateItemStatusModal to include payment status
// update Item Payment Status in UI
function updateItemPaymentStatusInUI(itemId, newPaymentStatus) {

  
  try {
    let targetElement = null;
    let paymentBadge = null;
    
    //  STRATEGY 1: Find by data-item-id
    targetElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (targetElement) {
    
      
      //  ENHANCED: Multiple selector strategies for payment badge
      paymentBadge = targetElement.querySelector('.payment-badge') ||
                    targetElement.querySelector('[data-payment-status]') ||
                    targetElement.querySelector('.badge[class*="payment-"]') ||
                    targetElement.querySelector('td:nth-last-child(2) .badge'); // Payment column badge
      
    }
    
    //  STRATEGY 2: Fallback search if not found
    if (!paymentBadge) {
      const allRows = document.querySelectorAll('tr, .item-row, .order-item');
      
      allRows.forEach(row => {
        const buttons = row.querySelectorAll('button[onclick]');
        buttons.forEach(button => {
          const onclickAttr = button.getAttribute('onclick');
          if (onclickAttr && (onclickAttr.includes(`'${itemId}'`) || onclickAttr.includes(`"${itemId}"`))) {
           
            targetElement = row;
            
            //  ENHANCED: Multiple strategies for payment badge in this row
            paymentBadge = row.querySelector('.payment-badge') ||
                          row.querySelector('[data-payment-status]') ||
                          row.querySelector('.badge[class*="payment-"]') ||
                          row.querySelector('td:nth-last-child(2) .badge');
                          
            
          }
        });
      });
    }
    
    //  STRATEGY 3: Create payment badge if still not found
    if (!paymentBadge && targetElement) {
      
      
      // Look for any badge in the payment column that might have lost its classes
      const paymentColumn = targetElement.querySelector('td:nth-last-child(2)');
      if (paymentColumn) {
        const existingBadge = paymentColumn.querySelector('.badge');
        if (existingBadge) {
        
          paymentBadge = existingBadge;
          
          //  RESTORE: Add missing payment badge class
          paymentBadge.classList.add('payment-badge');
        }
      }
    }
    
    //  UPDATE: Payment badge found
    if (paymentBadge && targetElement) {
     
      
      const originalText = paymentBadge.textContent.trim();
      paymentBadge.textContent = newPaymentStatus;
      
      //  ENHANCED: Ensure payment badge class exists
      if (!paymentBadge.classList.contains('payment-badge')) {
        paymentBadge.classList.add('payment-badge');
      }
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
      backgroundClasses.forEach(cls => paymentBadge.classList.remove(cls));
      
      // Remove old payment classes
      const classList = Array.from(paymentBadge.classList);
      classList.forEach(cls => {
        if (cls.startsWith('payment-')) {
          paymentBadge.classList.remove(cls);
        }
      });
      
      // Add new classes
      const newPaymentClass = `payment-${newPaymentStatus.toLowerCase().replace(/\s+/g, '-')}`;
      paymentBadge.classList.add(newPaymentClass);
      paymentBadge.classList.add(`bg-${getPaymentStatusColor(newPaymentStatus)}`);
      
      // Ensure badge class exists
      if (!paymentBadge.classList.contains('badge')) {
        paymentBadge.classList.add('badge');
      }
      
      // Update data attribute
      paymentBadge.setAttribute('data-payment-status', newPaymentStatus);
      
      
      
      // Visual feedback
      const targetRow = paymentBadge.closest('tr, .item-row, .card');
      if (targetRow) {
        targetRow.style.transition = 'background-color 0.4s ease';
        targetRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
        
        setTimeout(() => {
          targetRow.style.backgroundColor = '';
        }, 2000);
      }
      
    } else {
      console.error('Could not find or create payment badge for item:', itemId);
    }
    
  } catch (error) {
    console.error('Error updating payment status UI:', error);
  }
}


// Fetch order status AND update valid transitions
function fetchAndUpdateOrderStatus(orderId) {
  
  fetch(`/admin/orders/api/${orderId}`, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error(`Expected JSON but received: ${contentType || 'unknown'}`);
    }
    
    return response.json();
  })
  .then(data => {
    
    if (data.success && data.order) {
      const updatedOrderStatus = data.order.status;
      
      //  Update valid transitions if provided
      if (data.validTransitions && Array.isArray(data.validTransitions)) {
        window.validTransitions = data.validTransitions;
      }
      
      if (updatedOrderStatus !== window.currentOrderStatus && updatedOrderStatus !== currentOrderStatus) {
        updateOrderStatusInUI(updatedOrderStatus);
      }
    } else {
      console.warn('⚠️ Invalid response format:', data);
    }
  })
  .catch(error => {
    console.warn('⚠️ Could not fetch updated order status:', error.message);
  });
}

//  More precise item status UI update
function updateItemStatusInUI(itemId, newStatus) {
 
  
  try {
    let targetElement = null;
    let statusBadge = null;
    
    // Find the target row using data-item-id
    targetElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (targetElement) {
     
      statusBadge = targetElement.querySelector('.status-badge');
    }
    
    // Fallback: Search by onclick containing itemId
    if (!statusBadge) {
     
      const allRows = document.querySelectorAll('tr');
      
      allRows.forEach((row, index) => {
        const buttons = row.querySelectorAll('button[onclick]');
        buttons.forEach(button => {
          const onclickAttr = button.getAttribute('onclick');
          if (onclickAttr && (onclickAttr.includes(`'${itemId}'`) || onclickAttr.includes(`"${itemId}"`))) {
           
            targetElement = row;
            statusBadge = row.querySelector('.status-badge');
            return;
          }
        });
        if (statusBadge) return;
      });
    }
    
    if (statusBadge && targetElement) {
      
      
      //  UPDATE STATUS BADGE
      const originalText = statusBadge.textContent;
      statusBadge.textContent = newStatus;
      
      // Update CSS classes
      const backgroundClasses = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
      backgroundClasses.forEach(cls => statusBadge.classList.remove(cls));
      statusBadge.classList.add(`bg-${getStatusColor(newStatus)}`);
      
     
      
      //  UPDATE ACTION BUTTONS
      updateItemActionButtonsInRow(targetElement, newStatus, itemId);
      
      // Visual feedback
      targetElement.style.transition = 'background-color 0.4s ease';
      targetElement.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
      setTimeout(() => {
        targetElement.style.backgroundColor = '';
      }, 2000);
      
     
      
    } else {
      console.warn('⚠️ Could not find status badge for item:', itemId);
    }
    
  } catch (error) {
    console.error('❌ Error updating item status UI:', error);
  }
}






// ===== PAYMENT STATUS FUNCTIONS =====

//  ENHANCED: Improved Payment Status UI Update for Order-Level Changes
function updatePaymentStatusInUI(newPaymentStatus) {
 
  
  try {
    //  FIXED: More specific selectors that match actual payment badge classes
    const paymentElements = document.querySelectorAll(
      '.status-badge[class*="payment-"], ' +
      '.payment-badge, ' +
      '.badge[class*="payment-"], ' +
      '[data-payment-status], ' +
      '.payment-status'
    );
    
    
    
    let updated = false;
    
    paymentElements.forEach((element, index) => {
     
      
      // Skip item-level payment badges, only update order-level
      const isItemLevel = element.closest('tr, .item-row') !== null;
      if (isItemLevel) {
      
        return;
      }
      
      if (element) {
        const originalText = element.textContent;
        element.textContent = newPaymentStatus;
        
        if (element.classList.contains('badge') || element.classList.contains('status-badge') || element.classList.contains('payment-badge')) {
          // Remove old payment status classes
          const classesToRemove = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'bg-light', 'bg-dark'];
          classesToRemove.forEach(cls => element.classList.remove(cls));
          
          // Remove old payment-specific classes
          const classList = Array.from(element.classList);
          classList.forEach(cls => {
            if (cls.startsWith('payment-')) {
              element.classList.remove(cls);
            }
          });
          
          // Add new payment status class and color
          const newPaymentClass = `payment-${newPaymentStatus.toLowerCase().replace(/\s+/g, '-')}`;
          element.classList.add(newPaymentClass);
          element.classList.add(`bg-${getPaymentStatusColor(newPaymentStatus)}`);
          
          // Ensure badge class is present
          if (!element.classList.contains('badge') && !element.classList.contains('status-badge') && !element.classList.contains('payment-badge')) {
            element.classList.add('payment-badge');
          }
          
     
        }
        
        updated = true;
      }
    });
    
    if (updated) {
      
      
      // Visual feedback
      const orderSection = document.querySelector('body');
      if (orderSection) {
        orderSection.style.transition = 'background-color 0.4s ease';
        orderSection.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';
        
        setTimeout(() => {
          orderSection.style.backgroundColor = '';
        }, 1000);
      }
    } else {
      console.warn('⚠️ No order-level payment elements found to update');
    }
    
  } catch (error) {
    console.error('❌ Error updating payment status UI:', error);
    setTimeout(() => location.reload(), 1000);
  }
}

//  ENHANCED: Payment Status Color Function



// ===== UTILITY FUNCTIONS =====

function showToast(type, message, duration = 3000) {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
  }
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  
  const toastElement = toastContainer.lastElementChild;
  const toast = new bootstrap.Toast(toastElement, {
    autohide: true,
    delay: duration
  });
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

function testReturnModal() {
  
  returnItem('TEST_ORDER_ID', 'TEST_ITEM_ID');
}
</script>



