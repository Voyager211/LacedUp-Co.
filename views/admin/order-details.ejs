<% var title = "Order Details"; %>

<div class="container-fluid py-4">
  <% if (order) { %>
    <!-- Page Header -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <nav aria-label="breadcrumb" class="mb-3">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin/orders" class="text-decoration-none">Orders</a></li>
                <li class="breadcrumb-item active" aria-current="page">Order Details</li>
              </ol>
            </nav>
            <h1 class="fw-bold text-dark mb-2">Order #<%= order.orderId %></h1>
            <p class="text-muted mb-0 fs-6">
              <i class="bi bi-calendar3 me-2"></i>
              Placed on <%= new Date(order.createdAt).toLocaleDateString('en-IN', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              }) %>
            </p>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <a href="/admin/orders" class="btn btn-dark btn-sm">
              <i class="bi bi-arrow-left me-1"></i>Back to Orders
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Status Overview -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="card border-0 shadow-sm order-status-card">
          <div class="card-body py-4">
            <div class="row g-4 align-items-center">
              <div class="col-lg-2 col-md-4">
                <div class="text-center">
                  <h6 class="text-muted mb-2 fw-normal">Order Status</h6>
                  <span class="status-badge status-<%= order.status.toLowerCase().replace(' ', '-') %>">
                    <%= order.status %>
                  </span>
                </div>
              </div>
              <div class="col-lg-2 col-md-4">
                <div class="text-center">
                  <h6 class="text-muted mb-2 fw-normal">Payment Status</h6>
                  <span class="status-badge payment-<%= order.paymentStatus.toLowerCase() %>">
                    <%= order.paymentStatus %>
                  </span>
                </div>
              </div>
              <div class="col-lg-2 col-md-4">
                <div class="text-center">
                  <h6 class="text-muted mb-2 fw-normal">Total Amount</h6>
                  <h3 class="fw-bold text-dark mb-0">₹<%= order.totalAmount.toLocaleString('en-IN') %></h3>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="d-flex gap-2 justify-content-lg-end justify-content-center flex-wrap">
                  <button class="btn btn-primary" onclick="updateOrderStatus('<%= order.orderId %>', '<%= order.status %>')">
                    <i class="bi bi-pencil me-2"></i>Update Status
                  </button>
                  <button class="btn btn-outline-primary" onclick="updatePaymentStatus('<%= order.orderId %>', '<%= order.paymentStatus %>')">
                    <i class="bi bi-credit-card me-2"></i>Update Payment
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="row g-4">
      <!-- Left Column: Order Details -->
      <div class="col-lg-8">
        <!-- Customer & Delivery Information Combined -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0">
              <i class="bi bi-person-circle me-2"></i>Customer & Delivery Information
            </h5>
          </div>
          <div class="card-body py-4">
            <div class="row g-4">
              <!-- Customer Info -->
              <div class="col-md-6">
                <div class="customer-section">
                  <h6 class="text-muted mb-3 fw-normal">Customer Details</h6>
                  <div class="d-flex align-items-center mb-3">
                    <div class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-person text-primary fs-4"></i>
                    </div>
                    <div>
                      <h6 class="fw-bold mb-1"><%= order.user?.name || 'N/A' %></h6>
                      <p class="text-muted mb-0 small"><%= order.user?.email || 'N/A' %></p>
                    </div>
                  </div>
                  <div class="contact-info">
                    <% if (order.deliveryAddress && order.deliveryAddress.phone) { %>
                      <p class="mb-2">
                        <i class="bi bi-telephone me-2 text-muted"></i>
                        <strong>Phone:</strong> <%= order.deliveryAddress.phone %>
                      </p>
                      <% if (order.deliveryAddress.altPhone) { %>
                        <p class="mb-0">
                          <i class="bi bi-telephone me-2 text-muted"></i>
                          <strong>Alt Phone:</strong> <%= order.deliveryAddress.altPhone %>
                        </p>
                      <% } %>
                    <% } else if (order.shippingAddress && order.shippingAddress.phone) { %>
                      <p class="mb-2">
                        <i class="bi bi-telephone me-2 text-muted"></i>
                        <strong>Phone:</strong> <%= order.shippingAddress.phone %>
                      </p>
                      <% if (order.shippingAddress.altPhone) { %>
                        <p class="mb-0">
                          <i class="bi bi-telephone me-2 text-muted"></i>
                          <strong>Alt Phone:</strong> <%= order.shippingAddress.altPhone %>
                        </p>
                      <% } %>
                    <% } else { %>
                      <p class="mb-0 text-muted">
                        <i class="bi bi-telephone me-2 text-muted"></i>
                        <strong>Phone:</strong> Not available
                      </p>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- Delivery Address -->
              <div class="col-md-6">
                <div class="address-section">
                  <h6 class="text-muted mb-3 fw-normal">Delivery Address</h6>
                  <% if (order.deliveryAddress) { %>
                    <div class="address-card bg-light rounded-3 p-3">
                      <h6 class="fw-bold mb-2">
                        <i class="bi bi-geo-alt me-2"></i><%= order.deliveryAddress.name || 'N/A' %>
                      </h6>
                      <% if (order.deliveryAddress.addressType) { %>
                        <p class="mb-1 small text-muted"><%= order.deliveryAddress.addressType %></p>
                      <% } %>
                      <% if (order.deliveryAddress.landMark) { %>
                        <p class="mb-1"><%= order.deliveryAddress.landMark %></p>
                      <% } %>
                      <% if (order.deliveryAddress.city || order.deliveryAddress.state) { %>
                        <p class="mb-1">
                          <%= order.deliveryAddress.city || '' %><%= order.deliveryAddress.city && order.deliveryAddress.state ? ', ' : '' %><%= order.deliveryAddress.state || '' %>
                        </p>
                      <% } %>
                      <% if (order.deliveryAddress.pincode) { %>
                        <p class="mb-0"><strong>PIN:</strong> <%= order.deliveryAddress.pincode %></p>
                      <% } %>
                    </div>
                  <% } else { %>
                    <!-- No address available -->
                    <div class="address-card bg-light rounded-3 p-3">
                      <div class="text-center text-muted">
                        <i class="bi bi-geo-alt fs-2 mb-2 d-block"></i>
                        <p class="mb-0">No delivery address available</p>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items with Individual Management -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0">
              <i class="bi bi-bag me-2"></i>Order Items (<%= order.totalItemCount %> items)
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 order-items-table">
                <thead class="table-light">
                  <tr>
                    <th class="border-0 py-3">Product</th>
                    <th class="border-0 py-3">SKU</th>
                    <th class="border-0 py-3">Size</th>
                    <th class="border-0 py-3">Qty</th>
                    <th class="border-0 py-3">Price</th>
                    <th class="border-0 py-3">Total</th>
                    <th class="border-0 py-3">Status</th>
                    <th class="border-0 py-3 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% order.items.forEach(item => { %>
                    <tr>
                      <td class="py-3">
                        <div class="d-flex align-items-center">
                          <% if (item.productId && item.productId.mainImage) { %>
                            <img src="<%= item.productId.mainImage %>" 
                                 alt="<%= item.productId.productName %>" 
                                 class="rounded me-3 product-thumb" 
                                 style="width: 60px; height: 60px; object-fit: cover;">
                          <% } else { %>
                            <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center product-thumb" 
                                 style="width: 60px; height: 60px;">
                              <i class="bi bi-image text-muted"></i>
                            </div>
                          <% } %>
                          <div>
                            <h6 class="fw-semibold mb-0">
                              <%= item.productId ? item.productId.productName : 'Product Name' %>
                            </h6>
                          </div>
                        </div>
                      </td>
                      <td class="py-3"><code class="small"><%= item.sku %></code></td>
                      <td class="py-3"><span class="badge bg-light text-dark"><%= item.size %></span></td>
                      <td class="py-3"><span class="fw-semibold"><%= item.quantity %></span></td>
                      <td class="py-3">₹<%= item.price.toLocaleString('en-IN') %></td>
                      <td class="py-3"><span class="fw-bold">₹<%= item.totalPrice.toLocaleString('en-IN') %></span></td>
                      <td class="py-3">
                        <span class="status-badge item-<%= (item.status || 'pending').toLowerCase() %>">
                          <%= item.status || 'Pending' %>
                        </span>
                      </td>
                      <td class="py-3 text-center">
                        <div class="btn-group" role="group">
                          <button class="btn btn-sm btn-outline-primary" onclick="updateItemStatus('<%= order.orderId %>', '<%= item._id %>', '<%= item.status || 'Pending' %>')" title="Update Status">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <% if (['Pending', 'Processing'].includes(item.status || 'Pending')) { %>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelItem('<%= order.orderId %>', '<%= item._id %>')" title="Cancel Item">
                              <i class="bi bi-x-circle"></i>
                            </button>
                          <% } %>
                          <% if (item.status === 'Delivered') { %>
                            <button class="btn btn-sm btn-outline-warning" onclick="returnItem('<%= order.orderId %>', '<%= item._id %>')" title="Return Item">
                              <i class="bi bi-arrow-return-left"></i>
                            </button>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Comprehensive Order Timeline (Collapsible) -->
        <% if (order.comprehensiveStatusHistory && order.comprehensiveStatusHistory.length > 0) { %>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                  <i class="bi bi-clock-history me-2"></i>Order Timeline
                </h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#orderTimeline" aria-expanded="true">
                  <i class="bi bi-chevron-down"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="orderTimeline">
              <div class="card-body">
                <div class="timeline-compact">
                  <% order.comprehensiveStatusHistory.forEach((history, index) => { %>
                    <div class="timeline-item-compact">
                      <div class="timeline-marker-compact bg-<%= 
                        history.status === 'Delivered' ? 'success' : 
                        history.status === 'Shipped' ? 'info' : 
                        history.status === 'Processing' ? 'warning' : 
                        history.status === 'Cancelled' ? 'danger' : 
                        history.status === 'Returned' ? 'secondary' :
                        history.status === 'Partially Cancelled' ? 'warning' : 'secondary' 
                      %> <%= history.type === 'item' ? 'item-marker' : 'order-marker' %>"></div>
                      <div class="timeline-content-compact">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="fw-bold mb-1">
                              <% if (history.type === 'item') { %>
                                <span class="badge bg-info me-2">Item</span>
                              <% } else { %>
                                <span class="badge bg-primary me-2">Order</span>
                              <% } %>
                              <% if (history.status === 'Returned') { %>
                                Return Request
                              <% } else { %>
                                <%= history.status %>
                              <% } %>
                            </h6>
                            <% if (history.notes) { %>
                              <p class="mb-1 small text-muted"><%= history.notes %></p>
                            <% } %>
                            <% if (history.itemName) { %>
                              <small class="text-info d-block mt-1">
                                <i class="bi bi-box me-1"></i><%= history.itemName %>
                              </small>
                            <% } %>
                          </div>
                          <small class="text-muted">
                            <%= new Date(history.updatedAt).toLocaleDateString('en-IN', { 
                              month: 'short', 
                              day: 'numeric',
                              hour: '2-digit',
                              minute: '2-digit'
                            }) %>
                          </small>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Right Column: Summary & Actions -->
      <div class="col-lg-4">
        <!-- Order Summary & Payment Combined -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0">
              <i class="bi bi-receipt me-2"></i>Order Summary
            </h5>
          </div>
          <div class="card-body">
            <!-- Order Summary -->
            <div class="summary-section mb-4">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span>₹<%= order.subtotal.toLocaleString('en-IN') %></span>
              </div>
              <% if (order.totalDiscount > 0) { %>
                <div class="d-flex justify-content-between mb-2 text-success">
                  <span>Discount:</span>
                  <span>-₹<%= order.totalDiscount.toLocaleString('en-IN') %></span>
                </div>
              <% } %>
              <div class="d-flex justify-content-between mb-3">
                <span>Shipping:</span>
                <span><%= order.shipping === 0 ? 'Free' : '₹' + order.shipping.toLocaleString('en-IN') %></span>
              </div>
              <hr class="my-3">
              <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                <span>Total:</span>
                <span>₹<%= order.totalAmount.toLocaleString('en-IN') %></span>
              </div>
            </div>

            <!-- Payment Info -->
            <div class="payment-section">
              <h6 class="fw-bold mb-3">Payment Information</h6>
              <div class="bg-light rounded-3 p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Method:</span>
                  <span class="fw-semibold text-uppercase">
                    <%= order.paymentMethod === 'cod' ? 'Cash on Delivery' : order.paymentMethod %>
                  </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="small text-muted">Status:</span>
                  <span class="status-badge payment-<%= order.paymentStatus.toLowerCase() %>">
                    <%= order.paymentStatus %>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <% } else { %>
    <!-- Error State -->
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle display-1 text-muted mb-3"></i>
          <h3 class="text-muted">Order Not Found</h3>
          <p class="text-muted mb-4">The requested order could not be found.</p>
          <a href="/admin/orders" class="btn btn-primary">
            <i class="bi bi-arrow-left me-2"></i>Back to Orders
          </a>
        </div>
      </div>
    </div>
  <% } %>
</div>

<!-- Update Item Status Modal -->
<div class="modal fade" id="updateItemStatusModal" tabindex="-1" aria-labelledby="updateItemStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateItemStatusModalLabel">Update Item Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateItemStatusForm">
          <input type="hidden" id="itemOrderId" name="orderId">
          <input type="hidden" id="itemId" name="itemId">
          <div class="mb-3">
            <label for="itemStatus" class="form-label">Item Status</label>
            <select class="form-select" id="itemStatus" name="status" required>
              <option value="Pending">Pending</option>
              <option value="Processing">Processing</option>
              <option value="Shipped">Shipped</option>
              <option value="Delivered">Delivered</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Returned">Returned</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="itemStatusNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="itemStatusNotes" name="notes" rows="3" 
                      placeholder="Add any notes about this status update..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitItemStatusUpdate()">Update Status</button>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Item Modal -->
<div class="modal fade" id="cancelItemModal" tabindex="-1" aria-labelledby="cancelItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelItemModalLabel">Cancel Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="cancelItemForm">
          <input type="hidden" id="cancelOrderId" name="orderId">
          <input type="hidden" id="cancelItemId" name="itemId">
          <div class="mb-3">
            <label for="cancelReason" class="form-label">Cancellation Reason</label>
            <textarea class="form-control" id="cancelReason" name="reason" rows="3" 
                      placeholder="Enter reason for cancellation..." required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="submitItemCancellation()">Cancel Item</button>
      </div>
    </div>
  </div>
</div>

<!-- Return Item Modal -->
<div class="modal fade" id="returnItemModal" tabindex="-1" aria-labelledby="returnItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="returnItemModalLabel">Return Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="returnItemForm">
          <input type="hidden" id="returnOrderId" name="orderId">
          <input type="hidden" id="returnItemId" name="itemId">
          <div class="mb-3">
            <label for="returnReason" class="form-label">Return Reason</label>
            <textarea class="form-control" id="returnReason" name="reason" rows="3" 
                      placeholder="Enter reason for return..." required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="submitItemReturn()">Process Return</button>
      </div>
    </div>
  </div>
</div>

<!-- Include existing modals -->
<!-- Update Order Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateStatusModalLabel">Update Order Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateStatusForm">
          <input type="hidden" id="statusOrderId" name="orderId">
          <div class="mb-3">
            <label for="orderStatus" class="form-label">Order Status</label>
            <select class="form-select" id="orderStatus" name="status" required>
              <option value="Pending">Pending</option>
              <option value="Processing">Processing</option>
              <option value="Shipped">Shipped</option>
              <option value="Delivered">Delivered</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Partially Cancelled">Partially Cancelled</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="statusNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="statusNotes" name="notes" rows="3" 
                      placeholder="Add any notes about this status update..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Update Status</button>
      </div>
    </div>
  </div>
</div>

<!-- Update Payment Status Modal -->
<div class="modal fade" id="updatePaymentModal" tabindex="-1" aria-labelledby="updatePaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updatePaymentModalLabel">Update Payment Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updatePaymentForm">
          <input type="hidden" id="paymentOrderId" name="orderId">
          <div class="mb-3">
            <label for="paymentStatus" class="form-label">Payment Status</label>
            <select class="form-select" id="paymentStatus" name="paymentStatus" required>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
              <option value="Failed">Failed</option>
              <option value="Refunded">Refunded</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitPaymentUpdate()">Update Payment</button>
      </div>
    </div>
  </div>
</div>

<style>
/* General Layout Improvements */
.container-fluid {
  max-width: 1400px;
}

.card {
  border-radius: 16px;
  border: none;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
}

.card-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  border-bottom: 1px solid #e9ecef;
  border-radius: 16px 16px 0 0 !important;
  padding: 1.5rem;
}

.card-title {
  font-weight: 600;
  color: #2c3e50;
  margin: 0;
}

.card-body {
  padding: 1.5rem;
}

/* Status Badges */
.status-badge {
  display: inline-block;
  padding: 0.5rem 1rem;
  border-radius: 25px;
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

/* Order Status Colors */
.status-delivered, .item-delivered {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  color: #155724;
  border-color: #c3e6cb;
}

.status-shipped, .item-shipped {
  background: linear-gradient(135deg, #cce7ff, #b3d7ff);
  color: #004085;
  border-color: #b3d7ff;
}

.status-processing, .item-processing {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  color: #856404;
  border-color: #ffeaa7;
}

.status-pending, .item-pending {
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
  color: #721c24;
  border-color: #f5c6cb;
}

.status-cancelled, .item-cancelled {
  background: linear-gradient(135deg, #e2e3e5, #d6d8db);
  color: #383d41;
  border-color: #d6d8db;
}

.status-partially-cancelled {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  color: #856404;
  border-color: #ffeaa7;
}

.item-returned {
  background: linear-gradient(135deg, #e2e3e5, #d6d8db);
  color: #383d41;
  border-color: #d6d8db;
}

/* Payment Status Colors */
.payment-completed {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  color: #155724;
  border-color: #c3e6cb;
}

.payment-pending {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  color: #856404;
  border-color: #ffeaa7;
}

.payment-failed {
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
  color: #721c24;
  border-color: #f5c6cb;
}

.payment-refunded {
  background: linear-gradient(135deg, #e2e3e5, #d6d8db);
  color: #383d41;
  border-color: #d6d8db;
}

/* Order Status Card */
.order-status-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 1px solid #e9ecef;
}

/* Avatar */
.avatar-lg {
  width: 56px;
  height: 56px;
  border: 3px solid #ffffff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Address Card */
.address-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid #dee2e6;
  transition: all 0.3s ease;
}

.address-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Order Items Table */
.order-items-table {
  font-size: 0.95rem;
}

.order-items-table th {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  font-weight: 600;
  color: #495057;
  border: none;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.8rem;
}

.order-items-table td {
  border-color: #f1f3f4;
  vertical-align: middle;
}

.product-thumb {
  border: 2px solid #ffffff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.product-thumb:hover {
  transform: scale(1.05);
}

/* Compact Timeline */
.timeline-compact {
  position: relative;
}

.timeline-item-compact {
  position: relative;
  padding-left: 2.5rem;
  padding-bottom: 1.5rem;
  border-left: 2px solid #e9ecef;
  margin-left: 0.75rem;
}

.timeline-item-compact:last-child {
  padding-bottom: 0;
  border-left: none;
}

.timeline-marker-compact {
  position: absolute;
  left: -0.6rem;
  top: 0.25rem;
  width: 1rem;
  height: 1rem;
  border-radius: 50%;
  border: 3px solid #ffffff;
  box-shadow: 0 0 0 2px #e9ecef;
}

/* Different markers for order vs item events */
.timeline-marker-compact.order-marker {
  box-shadow: 0 0 0 2px #007bff;
}

.timeline-marker-compact.item-marker {
  box-shadow: 0 0 0 2px #17a2b8;
}

.timeline-content-compact {
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  border-radius: 12px;
  padding: 1rem;
  border: 1px solid #e9ecef;
  transition: all 0.3s ease;
}

.timeline-content-compact:hover {
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Buttons */
.btn {
  border-radius: 10px;
  font-weight: 500;
  padding: 0.75rem 1.5rem;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

.btn-primary {
  background: #000000;
  border-color: #000000;
  color: #ffffff;
}

.btn-primary:hover {
  background: #333333;
  border-color: #333333;
  color: #ffffff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-outline-primary {
  border-color: #000000;
  color: #000000;
  background: transparent;
}

.btn-outline-primary:hover {
  background: #000000;
  border-color: #000000;
  color: #ffffff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-outline-danger {
  border-color: #dc3545;
  color: #dc3545;
  background: transparent;
}

.btn-outline-danger:hover {
  background: #dc3545;
  border-color: #dc3545;
  color: #ffffff;
}

.btn-outline-warning {
  border-color: #ffc107;
  color: #ffc107;
  background: transparent;
}

.btn-outline-warning:hover {
  background: #ffc107;
  border-color: #ffc107;
  color: #000000;
}

.btn-group .btn {
  margin: 0 2px;
}

/* Icons */
.bi {
  vertical-align: -0.125em;
  color: #000000 !important;
}

/* Button icons */
.btn .bi {
  color: inherit !important;
}

/* Responsive Design */
@media (max-width: 992px) {
  .order-status-card .row > div {
    margin-bottom: 1rem;
  }
}

@media (max-width: 768px) {
  .card-header {
    padding: 1rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  .order-items-table {
    font-size: 0.875rem;
  }
  
  .product-thumb {
    width: 50px !important;
    height: 50px !important;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .btn-group .btn {
    margin: 2px 0;
  }
}
</style>

<script>
// Individual Item Management Functions

// Update item status
function updateItemStatus(orderId, itemId, currentStatus) {
  document.getElementById('itemOrderId').value = orderId;
  document.getElementById('itemId').value = itemId;
  document.getElementById('itemStatus').value = currentStatus;
  document.getElementById('itemStatusNotes').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('updateItemStatusModal'));
  modal.show();
}

function submitItemStatusUpdate() {
  const form = document.getElementById('updateItemStatusForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  const itemId = formData.get('itemId');
  
  fetch(`/admin/orders/item-status/${orderId}/${itemId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      status: formData.get('status'),
      notes: formData.get('notes')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      setTimeout(() => {
        location.reload();
      }, 1000);
    } else {
      showToast('error', data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', 'Error updating item status');
  });
  
  bootstrap.Modal.getInstance(document.getElementById('updateItemStatusModal')).hide();
}

// Cancel item
function cancelItem(orderId, itemId) {
  document.getElementById('cancelOrderId').value = orderId;
  document.getElementById('cancelItemId').value = itemId;
  document.getElementById('cancelReason').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('cancelItemModal'));
  modal.show();
}

function submitItemCancellation() {
  const form = document.getElementById('cancelItemForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  const itemId = formData.get('itemId');
  
  fetch(`/admin/orders/cancel-item/${orderId}/${itemId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      reason: formData.get('reason')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      setTimeout(() => {
        location.reload();
      }, 1000);
    } else {
      showToast('error', data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', 'Error cancelling item');
  });
  
  bootstrap.Modal.getInstance(document.getElementById('cancelItemModal')).hide();
}

// Return item
function returnItem(orderId, itemId) {
  document.getElementById('returnOrderId').value = orderId;
  document.getElementById('returnItemId').value = itemId;
  document.getElementById('returnReason').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('returnItemModal'));
  modal.show();
}

function submitItemReturn() {
  const form = document.getElementById('returnItemForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  const itemId = formData.get('itemId');
  
  fetch(`/admin/orders/return-item/${orderId}/${itemId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      reason: formData.get('reason')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      setTimeout(() => {
        location.reload();
      }, 1000);
    } else {
      showToast('error', data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', 'Error processing item return');
  });
  
  bootstrap.Modal.getInstance(document.getElementById('returnItemModal')).hide();
}

// Existing Order Management Functions

// Update order status
function updateOrderStatus(orderId, currentStatus) {
  document.getElementById('statusOrderId').value = orderId;
  document.getElementById('orderStatus').value = currentStatus;
  document.getElementById('statusNotes').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
  modal.show();
}

function submitStatusUpdate() {
  const form = document.getElementById('updateStatusForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  
  fetch(`/admin/orders/status/${orderId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      status: formData.get('status'),
      notes: formData.get('notes')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      setTimeout(() => {
        location.reload();
      }, 1000);
    } else {
      showToast('error', data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', 'Error updating order status');
  });
  
  bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
}

// Update payment status
function updatePaymentStatus(orderId, currentPaymentStatus) {
  document.getElementById('paymentOrderId').value = orderId;
  document.getElementById('paymentStatus').value = currentPaymentStatus;
  
  const modal = new bootstrap.Modal(document.getElementById('updatePaymentModal'));
  modal.show();
}

function submitPaymentUpdate() {
  const form = document.getElementById('updatePaymentForm');
  const formData = new FormData(form);
  const orderId = formData.get('orderId');
  
  fetch(`/admin/orders/payment/${orderId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      paymentStatus: formData.get('paymentStatus')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message);
      setTimeout(() => {
        location.reload();
      }, 1000);
    } else {
      showToast('error', data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', 'Error updating payment status');
  });
  
  bootstrap.Modal.getInstance(document.getElementById('updatePaymentModal')).hide();
}

// Toast notification function
function showToast(type, message) {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(toastContainer);
  }
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  
  const toastElement = toastContainer.lastElementChild;
  const toast = new bootstrap.Toast(toastElement);
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}
</script>