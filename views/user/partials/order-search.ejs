<style>
/* Compact Search Bar Styles */
.order-search-compact {
  position: relative;
  flex: 1;
  max-width: 400px;
}

.order-search-compact .input-group {
  position: relative;
}

.order-search-input {
  height: 42px;
  padding-left: 2.5rem;
  padding-right: 2.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px !important; /* Fully rounded edges */
  font-size: 14px;
  transition: all 0.2s ease;
  background: #f9fafb;
}

.order-search-input:focus {
  border-color: #d1d5db; /* Light gray instead of black */
  background: #fff;
  box-shadow: 0 0 0 3px rgba(229, 231, 235, 0.5); /* Subtle shadow */
  outline: none;
}

.order-search-input::placeholder {
  color: #9ca3af;
  font-size: 14px;
}

.search-icon-compact {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  pointer-events: none;
  z-index: 10;
  font-size: 16px;
}

.clear-search-compact {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  height: 28px;
  width: 28px;
  padding: 0;
  display: none;
  align-items: center;
  justify-content: center;
  border: none;
  background: transparent; /* Transparent background */
  border-radius: 50%; /* Circular */
  transition: all 0.2s ease;
  z-index: 10;
  font-size: 14px;
  color: #6b7280;
  cursor: pointer;
}

.clear-search-compact:hover {
  background: rgba(0, 0, 0, 0.05); /* Very subtle hover background */
  color: #111827;
}

.clear-search-compact:active {
  background: rgba(0, 0, 0, 0.1);
  transform: translateY(-50%) scale(0.95);
}

.search-results {
  position: absolute;
  top: 50px;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 16px; /* More rounded */
  max-height: 420px;
  overflow-y: auto;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  z-index: 1000;
}

.search-results-content {
  padding: 0.5rem;
}

.search-result-item {
  padding: 12px;
  border-radius: 10px; /* Rounded result items */
  cursor: pointer;
  transition: all 0.15s ease;
  border-bottom: 1px solid #f3f4f6;
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background: #f9fafb;
  transform: translateX(2px);
}

.search-result-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.search-result-order-id {
  font-weight: 600;
  color: #111827;
  font-size: 13px;
}

.search-result-status {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 600;
}

.search-result-products {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
  line-height: 1.4;
}

.search-result-date {
  font-size: 11px;
  color: #9ca3af;
}

.search-no-results,
.search-loading {
  padding: 2rem 1rem;
  text-align: center;
}

.search-no-results i {
  font-size: 2.5rem;
  color: #d1d5db;
  margin-bottom: 0.5rem;
}

.search-no-results p {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 0.25rem;
}

.search-no-results .small {
  font-size: 12px;
  color: #9ca3af;
}

/* Smooth scrollbar for search results */
.search-results::-webkit-scrollbar {
  width: 6px;
}

.search-results::-webkit-scrollbar-track {
  background: #f3f4f6;
  border-radius: 10px;
}

.search-results::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 10px;
}

.search-results::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* Responsive */
@media (max-width: 992px) {
  .order-search-compact {
    max-width: 300px;
  }
}

@media (max-width: 768px) {
  .order-search-compact {
    max-width: 100%;
    margin-top: 12px;
  }
  
  .order-search-input {
    height: 40px;
    font-size: 13px;
    border-radius: 20px !important;
  }
}
</style>


<!-- Compact Search Bar HTML -->
<div class="order-search-compact">
  <div class="input-group">
    <i class="bi bi-search search-icon-compact"></i>
    <input 
      type="text" 
      class="form-control order-search-input" 
      id="orderSearchInput"
      placeholder="Search orders..."
      autocomplete="off">
    <button class="clear-search-compact" id="clearSearch" type="button">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  <div class="search-results" id="searchResults" style="display: none;">
    <div class="search-results-content"></div>
  </div>
</div>

<!-- Search Bar JavaScript -->
<script>
(function() {
  let searchTimeout;
  let currentSearchTerm = '';
  
  const searchInput = document.getElementById('orderSearchInput');
  const clearBtn = document.getElementById('clearSearch');
  const searchResults = document.getElementById('searchResults');
  const searchResultsContent = searchResults.querySelector('.search-results-content');
  
  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.trim();
    currentSearchTerm = searchTerm;
    
    clearBtn.style.display = searchTerm ? 'flex' : 'none';
    clearTimeout(searchTimeout);
    
    if (searchTerm.length === 0) {
      hideSearchResults();
      resetOrdersView();
      return;
    }
    
    if (searchTerm.length < 2) {
      return;
    }
    
    searchTimeout = setTimeout(() => {
      performSearch(searchTerm);
    }, 300);
  });
  
  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const searchTerm = searchInput.value.trim();
      
      if (searchTerm.length >= 2) {
        clearTimeout(searchTimeout);
        performSearchAndDisplay(searchTerm);
      }
    }
  });

  clearBtn.addEventListener('click', function() {
    searchInput.value = '';
    clearBtn.style.display = 'none';
    hideSearchResults();
    resetOrdersView();
    currentSearchTerm = '';
  });
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.order-search-compact')) {
      hideSearchResults();
    }
  });
  
  async function performSearch(searchTerm) {
    showSearchLoading();
    
    try {
      const response = await fetch(`/orders/api/search?q=${encodeURIComponent(searchTerm)}`);
      const result = await response.json();
      
      if (result.success) {
        displaySearchResults(result.data.orders, searchTerm);
      } else {
        showSearchError();
      }
    } catch (error) {
      console.error('Search error:', error);
      showSearchError();
    }
  }
  
  async function performSearchAndDisplay(searchTerm) {
    hideSearchResults(); 
    
    try {
      const response = await fetch(`/orders/api/search?q=${encodeURIComponent(searchTerm)}`);
      const result = await response.json();
      
      if (result.success) {
        lastSearchResults = result.data.orders;
        displayOrdersInMainContainer(result.data.orders, searchTerm);
      } else {
        showMainError();
      }
    } catch (error) {
      console.error('Search error:', error);
      showMainError();
    }
  }

  function displayOrdersInMainContainer(orders, searchTerm) {
    const ordersContainer = document.getElementById('ordersContainer');
    const paginationContainer = document.querySelector('.pagination')?.closest('nav')?.parentElement;
    
    // Hide pagination during search
    if (paginationContainer) {
      paginationContainer.style.display = 'none';
    }
    
    if (orders.length === 0) {
      ordersContainer.innerHTML = `
        <div class="text-center py-5">
          <div class="mb-4">
            <i class="bi bi-search display-1 text-muted"></i>
          </div>
          <h4 class="text-muted mb-3">No Orders Found</h4>
          <p class="text-muted mb-4">No orders match your search for "<strong>${escapeHtml(searchTerm)}</strong>"</p>
          <button class="btn btn-outline-primary" onclick="document.getElementById('clearSearch').click()">
            <i class="bi bi-arrow-clockwise me-2"></i>Clear Search
          </button>
        </div>
      `;
      return;
    }
    
    // Use the existing generateOrderCardHTML function from orders.ejs
    let cardsHTML = '';
    orders.forEach(order => {
      if (typeof generateOrderCardHTML === 'function') {
        cardsHTML += generateOrderCardHTML(order);
      } else {
        // Fallback if function doesn't exist
        cardsHTML += `
          <div class="order-card mb-3" data-status="${order.status}">
            <div class="card">
              <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-3">
                  <h6 class="fw-bold">Order #${order.orderId}</h6>
                  <span class="badge bg-${getStatusClass(order.status)}">${order.status}</span>
                </div>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/orders/${order.orderId}'">
                  View Details
                </button>
              </div>
            </div>
          </div>
        `;
      }
    });
    
    ordersContainer.innerHTML = cardsHTML;
  }

  function showMainError() {
    const ordersContainer = document.getElementById('ordersContainer');
    ordersContainer.innerHTML = `
      <div class="text-center py-5">
        <div class="mb-4">
          <i class="bi bi-exclamation-triangle display-1 text-danger"></i>
        </div>
        <h4 class="text-danger mb-3">Search Error</h4>
        <p class="text-muted mb-4">Failed to search orders. Please try again.</p>
        <button class="btn btn-outline-primary" onclick="document.getElementById('clearSearch').click()">
          <i class="bi bi-arrow-clockwise me-2"></i>Try Again
        </button>
      </div>
    `;
  }

  function displaySearchResults(orders, searchTerm) {
    if (orders.length === 0) {
      searchResultsContent.innerHTML = `
        <div class="search-no-results">
          <i class="bi bi-search d-block"></i>
          <p class="mb-0 fw-semibold">No orders found</p>
          <p class="small mb-0">Try a different search term</p>
        </div>
      `;
      searchResults.style.display = 'block';
      return;
    }
    
    let html = '';
    orders.forEach(order => {
      const statusClass = getStatusClass(order.status);
      const formattedDate = new Date(order.createdAt).toLocaleDateString('en-IN', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      
      const productNames = order.items
        .slice(0, 2)
        .map(item => item.productId?.productName || 'Product')
        .join(', ');
      
      const moreItems = order.items.length > 2 ? ` +${order.items.length - 2} more` : '';
      
      html += `
        <div class="search-result-item" onclick="window.location.href='/orders/${order.orderId}'">
          <div class="search-result-header">
            <span class="search-result-order-id">${highlightMatch(order.orderId, searchTerm)}</span>
            <span class="badge bg-${statusClass} search-result-status">${order.status}</span>
          </div>
          <div class="search-result-products">
            ${highlightMatch(productNames, searchTerm)}${moreItems}
          </div>
          <div class="search-result-date">
            <i class="bi bi-calendar3 me-1"></i>${formattedDate} • ₹${order.totalAmount.toLocaleString('en-IN')}
          </div>
        </div>
      `;
    });
    
    searchResultsContent.innerHTML = html;
    searchResults.style.display = 'block';
  }
  
  function highlightMatch(text, searchTerm) {
    if (!text || !searchTerm) return text;
    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
    return text.replace(regex, '<mark style="background: #fef08a; padding: 0 2px; border-radius: 2px;">$1</mark>');
  }
  
  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  
  function showSearchLoading() {
    searchResultsContent.innerHTML = `
      <div class="search-loading">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 mb-0 text-muted small">Searching...</p>
      </div>
    `;
    searchResults.style.display = 'block';
  }
  
  function showSearchError() {
    searchResultsContent.innerHTML = `
      <div class="search-no-results">
        <i class="bi bi-exclamation-triangle text-danger d-block"></i>
        <p class="mb-0">Search error. Try again.</p>
      </div>
    `;
    searchResults.style.display = 'block';
  }
  
  function hideSearchResults() {
    searchResults.style.display = 'none';
  }
  
  function resetOrdersView() {
    const statusFilter = document.getElementById('orderStatusFilter');
    if (statusFilter && typeof loadOrders === 'function') {
      loadOrders(1, statusFilter.value || '');
    }
  }
  
  function getStatusClass(status) {
    const statusMap = {
      'Pending': 'warning', 'Processing': 'primary', 'Shipped': 'info',
      'Delivered': 'success', 'Cancelled': 'danger', 'Returned': 'warning',
      'Partially Returned': 'warning', 'Partially Delivered': 'info',
      'Processing Return': 'warning'
    };
    return statusMap[status] || 'secondary';
  }
})();
</script>
