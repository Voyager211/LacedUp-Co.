<div class="container py-4">
  <!-- Breadcrumbs -->
  <%- include('partials/breadcrumb', {
    breadcrumbs: [
      { label: 'Home', href: '/' },
      { label: 'My Profile', href: '/profile' },
      { label: 'Change Password' }
    ]
  }) %>

  <!-- Main Layout: Sidebar + Content -->
  <div class="row g-4">
    <!-- Left Sidebar Navigation -->
    <div class="col-lg-3 col-md-4">
      <%- include('partials/profile-sidebar.ejs', { user: user, active: 'change-password' }) %>
    </div>

    <!-- Main Content Area -->
    <div class="col-lg-9 col-md-8">
      <div class="profile-content">
        <!-- Change Password Section -->
        <div class="content-card">
          <h2 class="content-title">
            <i class="bi bi-shield-lock me-2"></i>
            Change Password
          </h2>
          
          <div class="password-intro mb-4">
            <div class="alert alert-info border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <div class="d-flex align-items-center">
                <i class="bi bi-info-circle me-3" style="font-size: 1.5rem; color: #0d6efd;"></i>
                <div>
                  <h6 class="mb-1">Secure Your Account</h6>
                  <p class="mb-0 text-muted">Choose a strong password to protect your account. Your password should be unique and not used elsewhere.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Change Password Form -->
          <form id="changePasswordForm" class="password-form" novalidate>
            <div class="row g-4">
              <!-- Current Password -->
              <div class="col-12">
                <label for="currentPassword" class="form-label">Current Password <span class="text-danger">*</span></label>
                <div class="password-input-wrapper">
                  <input type="password" 
                         class="form-control" 
                         id="currentPassword" 
                         name="currentPassword" 
                         placeholder="Enter your current password"
                         autocomplete="current-password">
                  <button class="password-toggle-btn" 
                          type="button" 
                          id="currentPassword-toggle"
                          onclick="togglePassword('currentPassword')"
                          style="display: none;">
                    <i class="bi bi-eye" id="currentPassword-icon"></i>
                  </button>
                </div>
                <div class="error-message" id="currentPassword-error"></div>
              </div>

              <!-- New Password -->
              <div class="col-12">
                <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                <div class="password-input-wrapper">
                  <input type="password" 
                         class="form-control" 
                         id="newPassword" 
                         name="newPassword" 
                         placeholder="Enter your new password"
                         autocomplete="new-password">
                  <button class="password-toggle-btn" 
                          type="button" 
                          id="newPassword-toggle"
                          onclick="togglePassword('newPassword')"
                          style="display: none;">
                    <i class="bi bi-eye" id="newPassword-icon"></i>
                  </button>
                </div>
                <div class="form-text">
                  Password must be at least 8 characters with uppercase, lowercase, number, and special character (@$!%*?&)
                </div>
                <div class="error-message" id="newPassword-error"></div>
              </div>

              <!-- Confirm Password -->
              <div class="col-12">
                <label for="confirmPassword" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                <div class="password-input-wrapper">
                  <input type="password" 
                         class="form-control" 
                         id="confirmPassword" 
                         name="confirmPassword" 
                         placeholder="Confirm your new password"
                         autocomplete="new-password">
                  <button class="password-toggle-btn" 
                          type="button" 
                          id="confirmPassword-toggle"
                          onclick="togglePassword('confirmPassword')"
                          style="display: none;">
                    <i class="bi bi-eye" id="confirmPassword-icon"></i>
                  </button>
                </div>
                <div class="error-message" id="confirmPassword-error"></div>
              </div>

              <!-- Password Strength Indicator -->
              <div class="col-12">
                <div class="password-strength-container" style="display: none;">
                  <label class="form-label">Password Strength</label>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar" 
                         role="progressbar" 
                         id="passwordStrengthBar"
                         style="width: 0%"
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                  </div>
                  <small class="text-muted" id="passwordStrengthText">Enter a password to see strength</small>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button type="submit" class="btn-save" id="updatePasswordBtn">
                <i class="bi bi-shield-check me-2"></i>
                Update Password
              </button>
              <a href="/profile" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Profile
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Profile Content Styles */
.profile-content {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.content-card {
  padding: 2rem;
}

.content-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #000;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  align-items: center;
}

.password-form {
  max-width: 600px;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #333;
  font-size: 0.95rem;
}

/* Password Input Wrapper - Contains input + eye button */
.password-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.form-control {
  width: 100%;
  padding: 0.75rem 3rem 0.75rem 1rem;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.95rem;
  transition: border-color 0.3s ease;
  background-color: #fff;
}

.form-control:focus {
  outline: none;
  border-color: #000;
  box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
}

/* Password toggle button - positioned inside input */
.password-toggle-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0.375rem;
  color: #6c757d;
  transition: color 0.2s ease;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
}

.password-toggle-btn:hover {
  color: #dc3545;
}

.password-toggle-btn:focus {
  outline: none;
}

.password-toggle-btn i {
  font-size: 1.1rem;
}

/* Validation States - NO background icons */
.form-control.is-invalid {
  border-color: #dc3545;
}

.form-control.is-valid {
  border-color: #28a745;
}

/* Error Message Styling */
.error-message {
  display: none;
  margin-top: 0.5rem;
  font-size: 0.875rem;
  color: #dc3545;
  font-weight: 500;
}

.error-message:not(:empty) {
  display: block;
}

.form-text {
  display: block;
  margin-top: 0.5rem;
  font-size: 0.8rem;
  color: #6c757d;
}

/* Password strength indicator */
.password-strength-container {
  margin-top: 1rem;
}

.progress {
  border-radius: 4px;
  background-color: #e9ecef;
}

.progress-bar {
  transition: width 0.3s ease, background-color 0.3s ease;
}

/* Form Actions */
.form-actions {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e9ecef;
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.btn-save {
  background-color: #000;
  color: #fff;
  border: none;
  padding: 0.875rem 2rem;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  text-decoration: none;
}

.btn-save:hover {
  background-color: #dc3545;
  transform: translateY(-1px);
}

.btn-save:active {
  transform: translateY(0);
}

.btn-save:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
  transform: none;
  opacity: 0.65;
}

.btn-outline-secondary {
  border: 1px solid #6c757d;
  color: #6c757d;
  background: transparent;
  padding: 0.875rem 2rem;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 500;
  text-decoration: none;
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
  background-color: #dc3545;
  border-color: #dc3545;
  color: #fff;
}

/* Responsive Design */
@media (max-width: 768px) {
  .content-card {
    padding: 1.5rem;
  }
  
  .content-title {
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
  }
  
  .password-form {
    max-width: 100%;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .btn-save,
  .btn-outline-secondary {
    width: 100%;
    justify-content: center;
  }
}

@media (max-width: 576px) {
  .content-card {
    padding: 1rem;
  }
  
  .form-control {
    font-size: 0.9rem;
  }
  
  .btn-save,
  .btn-outline-secondary {
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
  }
}
</style>

<script>
// ==================== TOAST NOTIFICATION HELPER ====================

const Toast = Swal.mixin({
  toast: true,
  position: 'top-end',
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener('mouseenter', Swal.stopTimer);
    toast.addEventListener('mouseleave', Swal.resumeTimer);
  }
});

// ==================== UTILITY FUNCTIONS ====================

// Password visibility toggle
function togglePassword(fieldId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + '-icon');
  
  if (field.type === 'password') {
    field.type = 'text';
    icon.classList.remove('bi-eye');
    icon.classList.add('bi-eye-slash');
  } else {
    field.type = 'password';
    icon.classList.remove('bi-eye-slash');
    icon.classList.add('bi-eye');
  }
}

// Show/hide eye button based on input
function toggleEyeButton(fieldId) {
  const field = document.getElementById(fieldId);
  const toggleBtn = document.getElementById(fieldId + '-toggle');
  
  if (field.value.length > 0) {
    toggleBtn.style.display = 'flex';
  } else {
    toggleBtn.style.display = 'none';
    // Reset to password type when cleared
    field.type = 'password';
    const icon = document.getElementById(fieldId + '-icon');
    icon.classList.remove('bi-eye-slash');
    icon.classList.add('bi-eye');
  }
}

// ==================== VALIDATION FUNCTIONS ====================

// Show error message
function showError(fieldId, message) {
  const field = document.getElementById(fieldId);
  const errorElement = document.getElementById(fieldId + '-error');
  
  if (field && errorElement) {
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    errorElement.textContent = message;
  }
}

// Show success state
function showSuccess(fieldId) {
  const field = document.getElementById(fieldId);
  const errorElement = document.getElementById(fieldId + '-error');
  
  if (field && errorElement) {
    field.classList.add('is-valid');
    field.classList.remove('is-invalid');
    errorElement.textContent = '';
  }
}

// Clear validation state
function clearValidation(fieldId) {
  const field = document.getElementById(fieldId);
  const errorElement = document.getElementById(fieldId + '-error');
  
  if (field && errorElement) {
    field.classList.remove('is-invalid', 'is-valid');
    errorElement.textContent = '';
  }
}

// Clear all validation states
function clearAllValidations() {
  const fields = ['currentPassword', 'newPassword', 'confirmPassword'];
  fields.forEach(fieldId => clearValidation(fieldId));
}

// Validate current password
function validateCurrentPassword(password) {
  if (!password || password.trim() === '') {
    return 'Current password is required';
  }
  
  if (password.length < 6) {
    return 'Current password seems too short';
  }
  
  return null;
}

// Validate new password
function validateNewPassword(password) {
  if (!password || password.trim() === '') {
    return 'New password is required';
  }
  
  if (password.length < 8) {
    return 'Password must be at least 8 characters long';
  }
  
  if (password.length > 50) {
    return 'Password must not exceed 50 characters';
  }
  
  if (!/[a-z]/.test(password)) {
    return 'Password must contain at least one lowercase letter';
  }
  
  if (!/[A-Z]/.test(password)) {
    return 'Password must contain at least one uppercase letter';
  }
  
  if (!/\d/.test(password)) {
    return 'Password must contain at least one number';
  }
  
  if (!/[@$!%*?&]/.test(password)) {
    return 'Password must contain at least one special character (@$!%*?&)';
  }
  
  if (/\s/.test(password)) {
    return 'Password cannot contain spaces';
  }
  
  // Check for common weak patterns
  const weakPatterns = ['12345', 'password', 'qwerty', 'abc123', '111111'];
  const lowerPassword = password.toLowerCase();
  for (let pattern of weakPatterns) {
    if (lowerPassword.includes(pattern)) {
      return 'Password contains a common weak pattern';
    }
  }
  
  return null;
}

// Validate confirm password
function validateConfirmPassword(newPassword, confirmPassword) {
  if (!confirmPassword || confirmPassword.trim() === '') {
    return 'Please confirm your new password';
  }
  
  if (newPassword !== confirmPassword) {
    return 'Passwords do not match';
  }
  
  return null;
}

// Check if new password is same as current
function checkPasswordDifference(currentPassword, newPassword) {
  if (currentPassword && newPassword && currentPassword === newPassword) {
    return 'New password must be different from current password';
  }
  return null;
}

// ==================== PASSWORD STRENGTH CHECKER ====================

function checkPasswordStrength(password) {
  let strength = 0;
  let feedback = [];

  if (password.length >= 8) strength += 20;
  else feedback.push('At least 8 characters');

  if (password.length >= 12) strength += 10;

  if (/[a-z]/.test(password)) strength += 15;
  else feedback.push('Lowercase letter');

  if (/[A-Z]/.test(password)) strength += 15;
  else feedback.push('Uppercase letter');

  if (/\d/.test(password)) strength += 15;
  else feedback.push('Number');

  if (/[@$!%*?&]/.test(password)) strength += 15;
  else feedback.push('Special character');

  const uniqueChars = new Set(password).size;
  if (uniqueChars > 10) strength += 10;

  return { strength: Math.min(strength, 100), feedback };
}

function updatePasswordStrength(password) {
  const container = document.querySelector('.password-strength-container');
  const bar = document.getElementById('passwordStrengthBar');
  const text = document.getElementById('passwordStrengthText');

  if (!password) {
    container.style.display = 'none';
    return;
  }

  container.style.display = 'block';
  const { strength, feedback } = checkPasswordStrength(password);

  bar.style.width = strength + '%';
  bar.setAttribute('aria-valuenow', strength);

  if (strength < 40) {
    bar.className = 'progress-bar bg-danger';
    text.textContent = 'Weak' + (feedback.length > 0 ? ' - Missing: ' + feedback.join(', ') : '');
    text.className = 'text-danger';
  } else if (strength < 60) {
    bar.className = 'progress-bar bg-warning';
    text.textContent = 'Fair' + (feedback.length > 0 ? ' - Missing: ' + feedback.join(', ') : '');
    text.className = 'text-warning';
  } else if (strength < 80) {
    bar.className = 'progress-bar bg-info';
    text.textContent = 'Good' + (feedback.length > 0 ? ' - Missing: ' + feedback.join(', ') : '');
    text.className = 'text-info';
  } else {
    bar.className = 'progress-bar bg-success';
    text.textContent = 'Strong password!';
    text.className = 'text-success';
  }
}

// ==================== REAL-TIME VALIDATION ====================

document.addEventListener('DOMContentLoaded', function() {
  const currentPasswordField = document.getElementById('currentPassword');
  const newPasswordField = document.getElementById('newPassword');
  const confirmPasswordField = document.getElementById('confirmPassword');

  // Add input event listeners for eye button visibility
  currentPasswordField.addEventListener('input', function() {
    toggleEyeButton('currentPassword');
    if (this.classList.contains('is-invalid') && this.value) {
      clearValidation('currentPassword');
    }
  });

  newPasswordField.addEventListener('input', function() {
    toggleEyeButton('newPassword');
    const password = this.value;
    updatePasswordStrength(password);
    
    if (password) {
      const error = validateNewPassword(password);
      if (error) {
        showError('newPassword', error);
      } else {
        const currentPassword = currentPasswordField.value;
        const diffError = checkPasswordDifference(currentPassword, password);
        if (diffError) {
          showError('newPassword', diffError);
        } else {
          showSuccess('newPassword');
        }
      }
      
      const confirmPassword = confirmPasswordField.value;
      if (confirmPassword) {
        const confirmError = validateConfirmPassword(password, confirmPassword);
        if (confirmError) {
          showError('confirmPassword', confirmError);
        } else {
          showSuccess('confirmPassword');
        }
      }
    } else {
      clearValidation('newPassword');
    }
  });

  confirmPasswordField.addEventListener('input', function() {
    toggleEyeButton('confirmPassword');
    const newPassword = newPasswordField.value;
    const confirmPassword = this.value;
    
    if (confirmPassword) {
      const error = validateConfirmPassword(newPassword, confirmPassword);
      if (error) {
        showError('confirmPassword', error);
      } else {
        showSuccess('confirmPassword');
      }
    } else {
      clearValidation('confirmPassword');
    }
  });

  // Current password validation on blur
  currentPasswordField.addEventListener('blur', function() {
    if (this.value) {
      const error = validateCurrentPassword(this.value);
      if (error) {
        showError('currentPassword', error);
      } else {
        showSuccess('currentPassword');
      }
    }
  });

  // Prevent paste in confirm password
  confirmPasswordField.addEventListener('paste', function(e) {
    e.preventDefault();
    showError('confirmPassword', 'Please type your password instead of pasting');
    setTimeout(() => clearValidation('confirmPassword'), 2000);
  });
});

// ==================== FORM SUBMISSION ====================

document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const currentPassword = document.getElementById('currentPassword').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();
  const confirmPassword = document.getElementById('confirmPassword').value.trim();

  clearAllValidations();

  let hasErrors = false;
  let firstErrorField = null;

  const currentError = validateCurrentPassword(currentPassword);
  if (currentError) {
    showError('currentPassword', currentError);
    hasErrors = true;
    if (!firstErrorField) firstErrorField = 'currentPassword';
  }

  const newError = validateNewPassword(newPassword);
  if (newError) {
    showError('newPassword', newError);
    hasErrors = true;
    if (!firstErrorField) firstErrorField = 'newPassword';
  } else {
    const diffError = checkPasswordDifference(currentPassword, newPassword);
    if (diffError) {
      showError('newPassword', diffError);
      hasErrors = true;
      if (!firstErrorField) firstErrorField = 'newPassword';
    }
  }

  const confirmError = validateConfirmPassword(newPassword, confirmPassword);
  if (confirmError) {
    showError('confirmPassword', confirmError);
    hasErrors = true;
    if (!firstErrorField) firstErrorField = 'confirmPassword';
  }

  if (hasErrors) {
    if (firstErrorField) {
      document.getElementById(firstErrorField).focus();
    }
    return;
  }

  const updateBtn = document.getElementById('updatePasswordBtn');
  const originalText = updateBtn.innerHTML;
  updateBtn.disabled = true;
  updateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Updating Password...';

  try {
    const response = await fetch('/profile/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        currentPassword,
        newPassword,
        confirmPassword
      })
    });

    const data = await response.json();

    if (data.success) {
      // Show success toast
      Toast.fire({
        icon: 'success',
        title: 'Password Updated Successfully!',
        text: 'Redirecting to profile...'
      });

      // Redirect after 3 seconds
      setTimeout(() => {
        window.location.href = '/profile';
      }, 3000);
    } else {
      // Handle validation errors with toast
      if (data.field) {
        showError(data.field, data.message);
        document.getElementById(data.field).focus();
        
        Toast.fire({
          icon: 'error',
          title: 'Validation Error',
          text: data.message
        });
      } else if (data.message && data.message.toLowerCase().includes('current password')) {
        showError('currentPassword', data.message);
        document.getElementById('currentPassword').focus();
        
        Toast.fire({
          icon: 'error',
          title: 'Error',
          text: data.message
        });
      } else {
        Toast.fire({
          icon: 'error',
          title: 'Error',
          text: data.message || 'Failed to update password'
        });
      }
      
      // Re-enable button on error
      updateBtn.disabled = false;
      updateBtn.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Error:', error);
    
    Toast.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'Please check your internet connection and try again'
    });
    
    // Re-enable button on error
    updateBtn.disabled = false;
    updateBtn.innerHTML = originalText;
  }
});
</script>
