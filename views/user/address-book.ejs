<div class="container py-4">
  <!-- Breadcrumbs -->
  <%- include('partials/breadcrumb', {
    breadcrumbs: [
      { label: 'Home', href: '/' },
      { label: 'My Profile', href: '/profile' },
      { label: 'Address Book' }
    ]
  }) %>

  <!-- Main Layout: Sidebar + Content -->
  <div class="row g-4">
    <!-- Left Sidebar Navigation -->
    <div class="col-lg-3 col-md-4">
      <%- include('partials/profile-sidebar.ejs', { user: user, active: 'addresses' }) %>
    </div>

    <!-- Main Content Area -->
    <div class="col-lg-9 col-md-8">
      <div class="address-book-container">
        <!-- Header -->
        <div class="address-header">
          <div class="header-content">
            <h2><i class="bi bi-geo-alt me-2"></i> Address Book</h2>
            <% if (typeof totalAddresses !== 'undefined' && totalAddresses > 0) { %>
              <p class="text-muted">Manage your delivery addresses (<span id="addressCount"><%= totalAddresses %></span>)</p>
            <% } else { %>
              <p class="text-muted">Manage your delivery addresses</p>
            <% } %>
          </div>
          <button class="btn btn-primary add-address-btn" onclick="addNewAddress()">
            <i class="bi bi-plus me-2"></i> Add New Address
          </button>
        </div>

        <!-- ADDRESSES GRID -->
        <div class="addresses-grid" id="addressesGrid">
          <% if (typeof addresses !== 'undefined' && addresses.length > 0) { %>
            <% addresses.forEach(function(address) { %>
              <div class="address-card <%= address.isDefault ? 'default' : '' %>">
                <% if (address.isDefault) { %>
                  <div class="default-badge">
                    <i class="bi bi-star-fill me-1"></i> Default
                  </div>
                <% } %>
                
                <div class="address-type">
                  <i class="bi bi-<%= address.addressType === 'home' ? 'house' : address.addressType === 'office' ? 'briefcase' : 'geo-alt' %>"></i>
                  <%= address.addressType.charAt(0).toUpperCase() + address.addressType.slice(1) %>
                </div>
                
                <div class="address-details">
                  <h5><%= address.name %></h5>
                  <div class="address-text">
                    <%= address.landMark %><br>
                    <%= address.city %>, <%= address.state %> - <%= address.pincode %><br>
                    <strong>Phone:</strong> <%= address.phone %>
                    <% if (address.altPhone) { %>
                      <br><strong>Alt Phone:</strong> <%= address.altPhone %>
                    <% } %>
                  </div>
                </div>
                
                <div class="address-actions">
                  <button class="btn btn-outline-primary btn-sm" onclick="editAddress('<%= address._id %>')">
                    <i class="bi bi-pencil me-1"></i> Edit
                  </button>
                  <% if (!address.isDefault) { %>
                    <button class="btn btn-outline-success btn-sm" onclick="setDefaultAddress('<%= address._id %>')">
                      <i class="bi bi-star me-1"></i> Set Default
                    </button>
                  <% } %>
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteAddress('<%= address._id %>')">
                    <i class="bi bi-trash me-1"></i> Delete
                  </button>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <!-- Empty state -->
            <div class="empty-state" id="emptyState">
              <div class="empty-icon">
                <i class="bi bi-geo-alt"></i>
              </div>
              <h4>No addresses found</h4>
              <p>Add your first delivery address to get started</p>
              <button class="btn btn-primary" onclick="addNewAddress()">
                <i class="bi bi-plus me-2"></i> Add Address
              </button>
            </div>
          <% } %>
        </div>

        <!-- ✅ UPDATED LOAD MORE SECTION -->
        <% if (typeof totalAddresses !== 'undefined' && totalAddresses > 2) { %>
          <div id="loadMoreContainer" class="load-more-container text-center">
            <!-- Load More Link (Transparent span) -->
            <span 
              id="loadMoreBtn" 
              class="load-more-link"
              style="<%= currentPage >= totalPages ? 'display: none;' : '' %>"
            >
              <span class="load-more-text">Load More Addresses</span>
              <i class="bi bi-chevron-down ms-2"></i>
            </span>
            
            <!-- All Loaded Message (Italic text) -->
            <span 
              id="allLoadedMessage" 
              class="all-loaded-text" 
              style="<%= currentPage < totalPages ? 'display: none;' : '' %>"
            >
              <i class="bi bi-check-circle me-2"></i>All addresses loaded
            </span>
          </div>
        <% } %>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading addresses...</p>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">
          <i class="bi bi-plus me-2"></i> Add New Address
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%- include('partials/addresses') %>
      </div>
    </div>
  </div>
</div>

<style>
/* Address Book Styles */
.address-book-container {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.address-header {
  padding: 2rem;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.header-content h2 {
  margin: 0 0 0.5rem;
  color: #000;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.header-content p {
  margin: 0;
}

.add-address-btn {
  background: #000;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.add-address-btn:hover {
  background: #dc3545;
  transform: translateY(-1px);
}

/* Addresses Grid */
.addresses-grid {
  padding: 2rem;
  min-height: 400px;
}

.loading-state, .empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 300px;
  text-align: center;
  color: #666;
}

.empty-icon {
  font-size: 4rem;
  color: #ddd;
  margin-bottom: 1rem;
}

.empty-state h4 {
  margin-bottom: 0.5rem;
  color: #333;
}

.empty-state p {
  margin-bottom: 1.5rem;
}

/* Address Cards */
.address-card {
  background: #fff;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  transition: all 0.3s ease;
  position: relative;
}

.address-card:hover {
  border-color: #000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.address-card.default {
  border-color: #28a745;
  background: linear-gradient(135deg, #f8fff9 0%, #f0fff4 100%);
}

.default-badge {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #28a745;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.address-type {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: #f8f9fa;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #666;
  margin-bottom: 1rem;
}

.address-details h5 {
  margin: 0 0 0.5rem;
  color: #000;
  font-weight: 600;
}

.address-text {
  color: #666;
  line-height: 1.6;
  margin-bottom: 1rem;
}

.address-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
  border-radius: 6px;
  font-weight: 500;
}

.btn-outline-primary {
  border-color: #000;
  color: #000;
}

.btn-outline-primary:hover {
  background: #000;
  border-color: #000;
}

.btn-outline-success {
  border-color: #28a745;
  color: #28a745;
}

.btn-outline-success:hover {
  background: #28a745;
  border-color: #28a745;
}

.btn-outline-danger {
  border-color: #dc3545;
  color: #dc3545;
}

.btn-outline-danger:hover {
  background: #dc3545;
  border-color: #dc3545;
}

/* Modal Styles */
.modal-content {
  border: none;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.modal-header {
  border-bottom: 1px solid #e9ecef;
  padding: 1.5rem 2rem;
}

.modal-title {
  font-weight: 600;
  color: #000;
}

.modal-body {
  padding: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
  .address-header {
    flex-direction: column;
    align-items: stretch;
    text-align: center;
  }

  .add-address-btn {
    width: 100%;
  }

  .address-actions {
    justify-content: center;
  }
}

@media (max-width: 576px) {
  .addresses-grid {
    padding: 1rem;
  }

  .address-card {
    padding: 1rem;
  }

  .address-header {
    padding: 1.5rem;
  }
}

.modal.fade .modal-dialog {
  transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
  transform: none;
}

body.modal-open {
  overflow: hidden;
}

.address-card {
  transition: all 0.3s ease;
}

.addresses-grid {
  transition: opacity 0.3s ease;
}

.addresses-grid.loading {
  opacity: 0.6;
  pointer-events: none;
}

/* ==================== ✅ UPDATED LOAD MORE STYLES ==================== */
.load-more-container {
  margin-top: 2rem;
  padding: 1.5rem 0;
  border-top: 1px solid #e9ecef;
}

/* Load More Link - Transparent with black text */
.load-more-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #000;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  user-select: none;
  padding: 8px 0;
}

.load-more-link:hover {
  color: #dc3545;
}

.load-more-link:hover i {
  animation: bounce 0.6s ease-in-out infinite;
}

.load-more-link.loading {
  pointer-events: none;
  opacity: 0.6;
}

.load-more-link i {
  transition: transform 0.3s ease;
  font-size: 14px;
}

/* All Loaded Message - Black italic text */
.all-loaded-text {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #000;
  font-size: 15px;
  font-style: italic;
  font-weight: 400;
}

.all-loaded-text i {
  color: #28a745;
  font-style: normal;
}

/* Bounce animation for chevron */
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(4px); }
}

/* ==================== SLIDE-IN ANIMATION ==================== */
@keyframes slideInFromBottom {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.address-card-new {
  animation: slideInFromBottom 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

.address-card-new:nth-child(1) { animation-delay: 0s; }
.address-card-new:nth-child(2) { animation-delay: 0.1s; }
</style>

<script>
// Initialize Geoapify Autocomplete
class GeoapifyAddressForm {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.autocomplete = null;
    this.initializeAutocomplete();
    this.setupEventListeners();
  }

  initializeAutocomplete() {
    const addressInput = document.getElementById('addressDetails');
    if (addressInput && typeof GeocoderAutocomplete !== 'undefined') {
      try {
        this.autocomplete = new GeocoderAutocomplete(addressInput, this.apiKey, {
          placeholder: 'Start typing your address...',
          type: 'locality',
          lang: 'en',
          countries: ['in'],
          limit: 5,
          debounceDelay: 300,
          skipIcons: false,
          skipDetails: false
        });

        this.autocomplete.on('select', (location) => {
         
          this.fillAddressForm(location);
        });

        this.autocomplete.on('suggestions', (suggestions) => {
       
        });

        this.autocomplete.on('input', (query) => {
         
        });

       
      } catch (error) {
        console.error('❌ Error initializing Geoapify autocomplete:', error);
        this.setupManualSearch();
      }
    } else {
      console.warn('⚠️ GeocoderAutocomplete not available, setting up manual search');
      this.setupManualSearch();
    }
  }

  setupManualSearch() {
    const addressInput = document.getElementById('addressDetails');
    if (addressInput) {
      let searchTimeout;
      
      addressInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length >= 3) {
          searchTimeout = setTimeout(() => {
            this.performManualSearch(query);
          }, 500);
        }
      });
    }
  }

  async performManualSearch(query) {
    try {
      const response = await fetch(
        `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&country=IN&format=json&apiKey=${this.apiKey}&limit=5`
      );
      
      if (response.ok) {
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          this.showManualSuggestions(data.results);
        }
      }
    } catch (error) {
      console.error('Manual search error:', error);
    }
  }

  showManualSuggestions(suggestions) {
    const existingSuggestions = document.querySelector('.manual-address-suggestions');
    if (existingSuggestions) {
      existingSuggestions.remove();
    }

    const addressInput = document.getElementById('addressDetails');
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'manual-address-suggestions';
    suggestionsContainer.style.cssText = `
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 1000;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    `;

    suggestions.forEach((suggestion, index) => {
      const suggestionItem = document.createElement('div');
      suggestionItem.className = 'manual-suggestion-item';
      suggestionItem.style.cssText = `
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        font-size: 0.9rem;
        color: #333;
        transition: all 0.2s ease;
      `;
      suggestionItem.textContent = suggestion.formatted;
      
      suggestionItem.addEventListener('mouseenter', () => {
        suggestionItem.style.backgroundColor = '#f8f9fa';
      });
      
      suggestionItem.addEventListener('mouseleave', () => {
        suggestionItem.style.backgroundColor = 'white';
      });
      
      suggestionItem.addEventListener('click', () => {
        addressInput.value = suggestion.formatted;
        this.fillAddressForm({ properties: suggestion });
        suggestionsContainer.remove();
      });
      
      suggestionsContainer.appendChild(suggestionItem);
    });

    const inputContainer = addressInput.parentNode;
    inputContainer.style.position = 'relative';
    inputContainer.appendChild(suggestionsContainer);

    document.addEventListener('click', (e) => {
      if (!inputContainer.contains(e.target)) {
        suggestionsContainer.remove();
      }
    }, { once: true });
  }

  fillAddressForm(location) {
    const properties = location.properties;

    if (properties.state) {
      document.getElementById('state').value = properties.state;
      this.updateDistricts(properties.state, properties.county);
    }

    if (properties.city) {
      document.getElementById('city').value = properties.city;
    }

    if (properties.postcode) {
      document.getElementById('pincode').value = properties.postcode;
    }

    if (properties.county) {
      setTimeout(() => {
        document.getElementById('district').value = properties.county;
      }, 100);
    }

    this.clearValidationErrors();
  }

  setupEventListeners() {
    const pincodeInput = document.getElementById('pincode');
    if (pincodeInput) {
      pincodeInput.addEventListener('blur', async (e) => {
        const pincode = e.target.value.trim();
        if (pincode.length === 6 && !document.getElementById('city').value) {
          await this.fetchLocationByPincode(pincode);
        }
      });
    }

    this.addCurrentLocationButton();
  }

  async fetchLocationByPincode(pincode) {
    try {
      
      
      const response = await fetch(
        `https://api.geoapify.com/v1/geocode/search?text=${pincode}&country=IN&format=json&apiKey=${this.apiKey}`
      );
      const data = await response.json();

      

      if (data.results && data.results.length > 0) {
        const location = data.results[0];
       
        
        if (location.state) {
          const stateSelect = document.getElementById('state');
          const stateOptions = Array.from(stateSelect.options);
          const matchingState = stateOptions.find(option => 
            option.textContent.toLowerCase().includes(location.state.toLowerCase()) ||
            location.state.toLowerCase().includes(option.textContent.toLowerCase())
          );
          
          if (matchingState) {
            stateSelect.value = matchingState.value;
            
            
            if (typeof updateDistricts === 'function') {
              updateDistricts(matchingState.value);
            
              
              setTimeout(() => {
                this.autoSelectDistrict(location.county || location.city);
              }, 300);
            } else {
              stateSelect.dispatchEvent(new Event('change'));
              setTimeout(() => {
                this.autoSelectDistrict(location.county || location.city);
              }, 300);
            }
          }
        }

        if (location.county) {
          document.getElementById('city').value = location.county;
        
        } else if (location.city) {
          document.getElementById('city').value = location.city;
          
        }

        const pincodeInput = document.getElementById('pincode');
        pincodeInput.style.borderColor = '#28a745';
        setTimeout(() => {
          pincodeInput.style.borderColor = '';
        }, 2000);

        this.clearValidationErrors();
      } else {
        console.warn('No results found for pincode:', pincode);
        const pincodeInput = document.getElementById('pincode');
        pincodeInput.style.borderColor = '#ffc107';
        setTimeout(() => {
          pincodeInput.style.borderColor = '';
        }, 2000);
      }
    } catch (error) {
      console.error('Error fetching location by pincode:', error);
      const pincodeInput = document.getElementById('pincode');
      pincodeInput.style.borderColor = '#dc3545';
      setTimeout(() => {
        pincodeInput.style.borderColor = '';
      }, 2000);
    }
  }

  autoSelectDistrict(districtName) {
    if (!districtName) return;
    
    const districtSelect = document.getElementById('district');
    if (districtSelect.disabled) {
      console.warn('District dropdown is still disabled, retrying...');
      setTimeout(() => {
        this.autoSelectDistrict(districtName);
      }, 100);
      return;
    }

   
    
    const districtOptions = Array.from(districtSelect.options);
    const matchingDistrict = districtOptions.find(option => {
      const optionText = option.textContent.toLowerCase();
      const searchText = districtName.toLowerCase();
      
      if (optionText === searchText) return true;
      
      if (optionText.includes(searchText) || searchText.includes(optionText)) return true;
      
      const cleanOptionText = optionText.replace(/\b(district|taluk|tehsil)\b/g, '').trim();
      const cleanSearchText = searchText.replace(/\b(district|taluk|tehsil)\b/g, '').trim();
      
      return cleanOptionText === cleanSearchText || 
             cleanOptionText.includes(cleanSearchText) || 
             cleanSearchText.includes(cleanOptionText);
    });

    if (matchingDistrict) {
      districtSelect.value = matchingDistrict.value;
      
      
      districtSelect.style.borderColor = '#28a745';
      setTimeout(() => {
        districtSelect.style.borderColor = '';
      }, 2000);
    } else {
      console.warn(`❌ Could not find matching district for: ${districtName}`);
    
      
      districtSelect.style.borderColor = '#ffc107';
      setTimeout(() => {
        districtSelect.style.borderColor = '';
      }, 3000);
    }
  }

  addCurrentLocationButton() {
    const addressDetails = document.getElementById('addressDetails');
    if (addressDetails && navigator.geolocation) {
      const existingBtn = addressDetails.parentNode.querySelector('.btn-current-location');
      if (existingBtn) {
        return;
      }

      const locationBtn = document.createElement('button');
      locationBtn.type = 'button';
      locationBtn.className = 'btn btn-outline-dark btn-sm mt-2 btn-current-location';
      locationBtn.innerHTML = '<i class="fas fa-location-arrow me-1"></i>Use Current Location';
      locationBtn.style.cssText = `
        background-color: #000;
        border-color: #000;
        color: #fff;
        transition: all 0.3s ease;
      `;
      
      locationBtn.addEventListener('mouseenter', () => {
        locationBtn.style.backgroundColor = '#dc3545';
        locationBtn.style.borderColor = '#dc3545';
        locationBtn.style.transform = 'translateY(-1px)';
      });
      
      locationBtn.addEventListener('mouseleave', () => {
        locationBtn.style.backgroundColor = '#000';
        locationBtn.style.borderColor = '#000';
        locationBtn.style.transform = 'translateY(0)';
      });
      
      locationBtn.addEventListener('click', () => {
        this.getCurrentLocation();
      });

      addressDetails.parentNode.appendChild(locationBtn);
    }
  }

  async getCurrentLocation() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by this browser.');
      return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
      const { latitude, longitude } = position.coords;
      try {
        const response = await fetch(
          `https://api.geoapify.com/v1/geocode/reverse?lat=${latitude}&lon=${longitude}&format=json&apiKey=${this.apiKey}`
        );
        const data = await response.json();

        if (data.results && data.results.length > 0) {
          const location = data.results[0];
          this.fillAddressForm({ properties: location });
          document.getElementById('addressDetails').value = location.formatted;
        }
      } catch (error) {
        console.error('Error getting current location:', error);
        alert('Could not get your current location. Please enter address manually.');
      }
    }, (error) => {
      console.error('Geolocation error:', error);
      alert('Could not access your location. Please enter address manually.');
    });
  }

  updateDistricts(selectedState, selectedDistrict = '') {
    const districtSelect = document.getElementById('district');
    if (typeof stateDistrictData !== 'undefined' && stateDistrictData[selectedState]) {
      districtSelect.disabled = false;
      districtSelect.innerHTML = '<option value="">Select District</option>';

      stateDistrictData[selectedState].districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district.toLowerCase().replace(/\s+/g, '-');
        option.textContent = district;
        districtSelect.appendChild(option);
      });

      if (selectedDistrict) {
        districtSelect.value = selectedDistrict.toLowerCase().replace(/\s+/g, '-');
      }
    }
  }

  clearValidationErrors() {
    document.querySelectorAll('.is-invalid').forEach(input => {
      input.classList.remove('is-invalid');
    });

    document.querySelectorAll('.error-message').forEach(error => {
      error.style.display = 'none';
    });
  }
}

// ==================== GLOBAL STATE ====================
let addresses = <%- JSON.stringify(addresses) %>;
let currentEditingId = null;
let currentPage = <%- currentPage %>;
let totalPages = <%- totalPages %>;
let isLoading = false;

// ==================== INITIALIZE ====================
document.addEventListener('DOMContentLoaded', function() {
  setupLoadMoreButton();
  
  const addressModal = document.getElementById('addressModal');
  if (addressModal) {
    addressModal.addEventListener('shown.bs.modal', function() {
      const API_KEY = '<%= geoapifyApiKey %>';
      new GeoapifyAddressForm(API_KEY);
    });
  }
  
  
});

// ==================== SETUP LOAD MORE BUTTON ====================
function setupLoadMoreButton() {
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  
  if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', function() {
      loadMoreAddresses();
    });
  }
}

// ==================== LOAD MORE ADDRESSES ====================
async function loadMoreAddresses() {
  if (isLoading) {
    
    return;
  }

  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const nextPage = currentPage + 1;

  if (nextPage > totalPages) {
 
    hideLoadMoreButton();
    return;
  }

  isLoading = true;
  loadMoreBtn.classList.add('loading');
  loadMoreBtn.querySelector('.load-more-text').textContent = 'Loading...';

  

  try {
    const response = await fetch(`/api/addresses/paginated?page=${nextPage}`);
    const result = await response.json();

    if (result.success && result.data.addresses.length > 0) {
     
      
      addresses = addresses.concat(result.data.addresses);
      currentPage = result.data.currentPage;
      totalPages = result.data.totalPages;

      appendAddressesWithAnimation(result.data.addresses);
      updateAddressCount(addresses.length);

      if (currentPage >= totalPages) {
        hideLoadMoreButton();
      } else {
        loadMoreBtn.querySelector('.load-more-text').textContent = 'Load More Addresses';
      }
    } else {
      
      hideLoadMoreButton();
    }
  } catch (error) {
    console.error('❌ Error loading addresses:', error);
    showError('Failed to load addresses. Please try again.');
    loadMoreBtn.querySelector('.load-more-text').textContent = 'Load More Addresses';
  } finally {
    isLoading = false;
    loadMoreBtn.classList.remove('loading');
  }
}

// ==================== APPEND ADDRESSES WITH ANIMATION ====================
function appendAddressesWithAnimation(newAddresses) {
  const grid = document.getElementById('addressesGrid');
  
  newAddresses.forEach((address, index) => {
    const addressCard = createAddressCardHTML(address);
    
    const wrapper = document.createElement('div');
    wrapper.className = 'address-card-new';
    wrapper.innerHTML = addressCard;
    
    grid.appendChild(wrapper);
    
    setTimeout(() => {
      wrapper.style.animationDelay = `${index * 0.1}s`;
    }, 50);
  });
}

// ==================== CREATE ADDRESS CARD HTML ====================
function createAddressCardHTML(address) {
  const addressTypeIcon = getAddressIcon(address.addressType);
  const defaultBadge = address.isDefault ? `<div class="default-badge"><i class="bi bi-star-fill me-1"></i> Default</div>` : '';
  
  return `
    <div class="address-card ${address.isDefault ? 'default' : ''}">
      ${defaultBadge}
      <div class="address-type">
        <i class="bi bi-${addressTypeIcon}"></i> ${capitalizeFirst(address.addressType)}
      </div>
      <div class="address-details">
        <h5>${address.name}</h5>
        <div class="address-text">
          ${address.landMark}<br>
          ${address.city}, ${address.state} - ${address.pincode}<br>
          <strong>Phone:</strong> ${address.phone}
          ${address.altPhone ? `<br><strong>Alt Phone:</strong> ${address.altPhone}` : ''}
        </div>
      </div>
      <div class="address-actions">
        <button class="btn btn-outline-primary btn-sm" onclick="editAddress('${address._id}')">
          <i class="bi bi-pencil me-1"></i> Edit
        </button>
        ${!address.isDefault ? `
          <button class="btn btn-outline-success btn-sm" onclick="setDefaultAddress('${address._id}')">
            <i class="bi bi-star me-1"></i> Set Default
          </button>
        ` : ''}
        <button class="btn btn-outline-danger btn-sm" onclick="deleteAddress('${address._id}')">
          <i class="bi bi-trash me-1"></i> Delete
        </button>
      </div>
    </div>
  `;
}

// ==================== HELPER FUNCTIONS ====================
function hideLoadMoreButton() {
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const allLoadedMsg = document.getElementById('allLoadedMessage');
  
  if (loadMoreBtn) loadMoreBtn.style.display = 'none';
  if (allLoadedMsg) allLoadedMsg.style.display = 'inline-flex';
  
  
}

function updateAddressCount(count) {
  const countElement = document.getElementById('addressCount');
  if (countElement) {
    countElement.textContent = count;
  }
}

function getAddressIcon(type) {
  switch(type) {
    case 'home': return 'house';
    case 'office': return 'briefcase';
    case 'other': return 'geo-alt';
    default: return 'geo-alt';
  }
}

function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// ==================== SET DEFAULT ADDRESS ====================
async function setDefaultAddress(addressId) {
  try {
 
    
    const response = await fetch(`/api/address/${addressId}/default`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data && data.success) {
      
      showSuccess(data.message || 'Default address updated successfully');
      setTimeout(() => location.reload(), 1000);
    } else {
      showError(data?.message || 'Failed to set default address');
    }
  } catch (error) {
    console.error('❌ Error setting default address:', error);
    showError('Failed to set default address: ' + error.message);
  }
}

// ==================== DELETE ADDRESS ====================
async function deleteAddress(addressId) {
  if (typeof Swal !== 'undefined') {
    const result = await Swal.fire({
      title: 'Delete Address?',
      text: 'Are you sure you want to delete this address?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="bi bi-trash me-1"></i> Yes, Delete',
      cancelButtonText: '<i class="bi bi-x-circle me-1"></i> Cancel',
      reverseButtons: true
    });
    if (!result.isConfirmed) return;
  } else {
    if (!confirm('Are you sure you want to delete this address?')) return;
  }
  
  try {
    const response = await fetch(`/api/address/${addressId}`, { method: 'DELETE' });
    const data = await response.json();
    
    if (data.success) {
      showSuccess(data.message);
      setTimeout(() => location.reload(), 1000);
    } else {
      showError(data.message);
    }
  } catch (error) {
    console.error('❌ Error deleting address:', error);
    showError('Failed to delete address');
  }
}

// ==================== ADD NEW ADDRESS ====================
function addNewAddress() {
  currentEditingId = null;
  document.getElementById('addressModalLabel').innerHTML = '<i class="bi bi-plus me-2"></i> Add New Address';
  
  const modal = new bootstrap.Modal(document.getElementById('addressModal'));
  
  document.getElementById('addressModal').addEventListener('shown.bs.modal', function resetForm() {
    const form = document.getElementById('addressForm');
    if (form) {
      form.reset();
      
      form.querySelectorAll('.is-invalid, .is-valid').forEach(el => {
        el.classList.remove('is-invalid', 'is-valid');
      });
      
      form.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
      });
      
      const districtSelect = document.getElementById('district');
      if (districtSelect) {
        districtSelect.innerHTML = '<option value="">Select District</option>';
        districtSelect.disabled = true;
      }
      
    
    }
    
    this.removeEventListener('shown.bs.modal', resetForm);
  });
  
  modal.show();
}

// ==================== EDIT ADDRESS ====================
async function editAddress(addressId) {
  currentEditingId = addressId;
  document.getElementById('addressModalLabel').innerHTML = '<i class="bi bi-pencil me-2"></i> Edit Address';
  
  const address = addresses.find(addr => addr._id === addressId);
  if (!address) {
    showError('Address not found');
    return;
  }

  const modal = new bootstrap.Modal(document.getElementById('addressModal'));
  
  document.getElementById('addressModal').addEventListener('shown.bs.modal', function populateForm() {
    const form = document.getElementById('addressForm');
    if (form) {
      form.querySelector('#fullName').value = address.name || '';
      form.querySelector('#mobileNumber').value = address.phone || '';
      form.querySelector('#altPhone').value = address.altPhone || '';
      form.querySelector('#addressDetails').value = address.landMark || '';
      form.querySelector('#city').value = address.city || '';
      form.querySelector('#pincode').value = address.pincode || '';
      
      const addressTypeRadio = form.querySelector(`input[name="addressType"][value="${address.addressType}"]`);
      if (addressTypeRadio) {
        addressTypeRadio.checked = true;
      }
      
      const makeDefaultCheck = form.querySelector('#makeDefault');
      if (makeDefaultCheck) {
        makeDefaultCheck.checked = address.isDefault;
      }
      
      const stateSelect = form.querySelector('#state');
      if (stateSelect && address.state) {
        stateSelect.value = address.state;
        stateSelect.dispatchEvent(new Event('change'));
        
        setTimeout(() => {
          const districtSelect = form.querySelector('#district');
          if (districtSelect && address.district) {
            districtSelect.value = address.district;
          }
        }, 200);
      }
      
      
    }
    
    this.removeEventListener('shown.bs.modal', populateForm);
  });
  
  modal.show();
}

// ==================== ALERT FUNCTIONS ====================
function showSuccess(message) {
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'Success!',
      text: message,
      icon: 'success',
      confirmButtonColor: '#000000'
    });
  } else {
    alert(message);
  }
}

function showError(message) {
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'Error!',
      text: message,
      icon: 'error',
      confirmButtonColor: '#000000'
    });
  } else {
    alert(message);
  }
}
</script>
