<% var title = "Checkout" %>

<!-- Checkout Page Specific CSS -->
<link rel="stylesheet" href="/css/checkout.css">

<!-- Breadcrumbs - Positioned correctly below navbar -->
<div class="container my-4">
  <%- include('partials/breadcrumb', {
    breadcrumbs: [
      { label: 'Home', href: '/' },
      { label: 'Cart', href: '/cart' },
      { label: 'Checkout' }
    ]
  }) %>
</div>

<!-- Main Checkout Container -->
<div class="container pb-4 checkout-content">
    <!-- Checkout Header - Styled like cart header bar -->
    <div class="checkout-header-bar">
        <h1 class="checkout-title">
            <i class="bi bi-credit-card me-2"></i>Checkout
        </h1>
    </div>

    <!-- Main Content -->
    <div class="main-checkout-content">
        <!-- Left Side - Address and Payment (Vertical Stack) -->
        <div class="checkout-left">
            <!-- Delivery Address Section -->
            <div class="section-card">
              <div class="section-title">
                  <div>
                      <i class="bi bi-geo-alt"></i>
                      Delivery Address
                  </div>
                  <button class="btn-add-new-address" onclick="showAddAddressModal()">
                      <i class="bi bi-plus-circle"></i> Add New Address
                  </button>
              </div>

              <!-- Address Container - Will be populated by JavaScript -->
              <div id="addressContainer">
                  <!-- Loading state -->
                  <div class="loading-state" id="addressLoadingState">
                      <div class="spinner-border" role="status">
                          <span class="visually-hidden">Loading...</span>
                      </div>
                      <p>Loading addresses...</p>
                  </div>
              </div>
            </div> 

            <!-- Payment Method Section -->
            <div class="section-card">
                <div class="section-title">
                    <div>
                        <i class="bi bi-credit-card"></i>
                        Payment Method
                    </div>
                </div>

                <!-- Credit/Debit Card -->
                <div class="payment-option">
                    <label class="d-flex align-items-center">
                        <input type="radio" name="paymentMethod" value="card" onclick="selectPayment(this)">
                        <div class="payment-icon">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <div class="payment-info">
                            <h6>Credit/Debit Card</h6>
                            <p>Visa, MasterCard, American Express</p>
                        </div>
                    </label>
                </div>

                <!-- ✅ UPI Payment (Razorpay) -->
                <div class="payment-option">
                    <label class="d-flex align-items-center">
                        <input type="radio" name="paymentMethod" value="upi" onclick="selectPayment(this)">
                        <div class="payment-icon">
                            <i class="bi bi-phone"></i>
                        </div>
                        <div class="payment-info">
                            <h6>UPI Payment</h6>
                            <p>Pay using Google Pay, PhonePe, Paytm & more</p>
                        </div>
                    </label>
                </div>

                <!-- ✅ NEW: PayPal Payment (Separate) -->
                <div class="payment-option">
                    <label class="d-flex align-items-center">
                        <input type="radio" name="paymentMethod" value="paypal" onclick="selectPayment(this)">
                        <div class="payment-icon">
                            <i class="bi bi-paypal"></i>
                        </div>
                        <div class="payment-info">
                            <h6>PayPal</h6>
                            <p>Pay with your PayPal account or cards</p>
                        </div>
                    </label>
                </div>

                <!-- Net Banking -->
                <div class="payment-option">
                    <label class="d-flex align-items-center">
                        <input type="radio" name="paymentMethod" value="netbanking" onclick="selectPayment(this)">
                        <div class="payment-icon">
                            <i class="bi bi-bank"></i>
                        </div>
                        <div class="payment-info">
                            <h6>Net Banking</h6>
                            <p>Pay directly from your bank account</p>
                        </div>
                    </label>
                </div>

                <!-- Wallet Payment -->
                <div class="payment-option" id="wallet-payment-option">
                    <label class="d-flex align-items-center">
                        <input type="radio" name="paymentMethod" value="wallet" onclick="selectPayment(this)">
                        <div class="payment-icon">
                            <i class="bi bi-wallet2"></i>
                        </div>
                        <div class="payment-info">
                            <h6>Wallet Payment</h6>
                            <p id="wallet-balance-text">Loading balance...</p>
                        </div>
                    </label>
                    <div id="insufficient-balance-warning" class="mt-2 alert alert-warning d-none">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="insufficient-balance-message">Insufficient wallet balance.</span>
                        <a href="/profile/wallet" class="alert-link ms-2">Add money to wallet</a>
                    </div>
                </div>

                <!-- Cash on Delivery -->
                <div class="payment-option selected">
                    <label class="d-flex align-items-center">
                        <input type="radio" name="paymentMethod" value="cod" checked onclick="selectPayment(this)">
                        <div class="payment-icon">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <div class="payment-info">
                            <h6>Cash on Delivery</h6>
                            <p>Pay when your order is delivered</p>
                        </div>
                    </label>
                </div>

                <!-- Continue Button -->
                <button class="btn-continue" onclick="proceedToPayment()">
                    <i class="bi bi-check-circle"></i> PLACE ORDER
                </button>
            </div>

            <!-- ✅ Containers for payment gateways -->
            <div id="paypal-btn-container-left" class="mt-3 d-none"></div>
            <div id="razorpay-btn-container-left" class="mt-3 d-none"></div>
            <!-- Back to Cart -->
            <a href="/cart" class="btn-back">
                <i class="bi bi-arrow-left"></i> Back to Cart
            </a>
        </div>

        <!-- Right Side - Order Summary (styled exactly like cart page) -->
        <div class="checkout-right">
            <div class="order-summary">
                <!-- Summary Header -->
                <div class="summary-header">
                    <h5 class="summary-title">
                        <i class="bi bi-receipt me-2"></i>Order Summary
                    </h5>
                </div>

                <!-- Summary Content -->
                <div class="summary-content">
                    <div class="section-subtitle">ITEMS IN CART (<%= totalItemCount || 0 %>)</div>

                    <!-- Order Items -->
                    <% if (cartItems && cartItems.length > 0) { %>
                        <% cartItems.forEach(item => { %>
                            <div class="order-item">
                                <% 
                                    // Multiple fallback options for product image
                                    let imageSrc = '/images/placeholder.svg';
                                    let productName = 'Product Name';
                                    
                                    // Try to get image from productId (main fallback)
                                    if (item.productId && item.productId.mainImage) {
                                        // Check if mainImage already contains the full path
                                        imageSrc = item.productId.mainImage.startsWith('/') ? 
                                                   item.productId.mainImage : 
                                                   '/uploads/products/' + item.productId.mainImage;
                                        productName = item.productId.productName || 'Product Name';
                                    }
                                    // Try to get image from product (additional fallback)
                                    else if (item.product && item.product.mainImage) {
                                        imageSrc = item.product.mainImage.startsWith('/') ? 
                                                   item.product.mainImage : 
                                                   '/uploads/products/' + item.product.mainImage;
                                        productName = item.product.productName || 'Product Name';
                                    }
                                    // Try to get image from subImages if mainImage is not available
                                    else if (item.productId && item.productId.subImages && item.productId.subImages.length > 0) {
                                        const subImage = item.productId.subImages[0];
                                        imageSrc = subImage.startsWith('/') ? 
                                                   subImage : 
                                                   '/uploads/products/' + subImage;
                                        productName = item.productId.productName || 'Product Name';
                                    }
                                    else if (item.product && item.product.subImages && item.product.subImages.length > 0) {
                                        const subImage = item.product.subImages[0];
                                        imageSrc = subImage.startsWith('/') ? 
                                                   subImage : 
                                                   '/uploads/products/' + subImage;
                                        productName = item.product.productName || 'Product Name';
                                    }
                                %>
                                <img src="<%= imageSrc %>" 
                                     alt="<%= productName %>"
                                     class="item-image" 
                                     onerror="this.onerror=null; this.src='/images/placeholder.svg';"
                                     loading="lazy">
                                <div class="item-details">
                                    <h6><%= item.productId.productName %></h6>
                                    <p>Size: <%= item.size %> | Qty: <%= item.quantity %></p>
                                </div>
                                <div class="item-price">₹<%= Math.round(item.totalPrice) %></div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="order-item">
                            <img src="/images/placeholder.svg" alt="Product" class="item-image">
                            <div class="item-details">
                                <h6>No items in cart</h6>
                                <p>Please add items to continue</p>
                            </div>
                            <div class="item-price">₹0</div>
                        </div>
                    <% } %>

                    <!-- Price Breakdown -->
                    <div class="price-breakdown">
                        <div class="summary-row">
                            <span class="price-label">Subtotal (<%= totalItemCount || 0 %> items)</span>
                            <span class="price-value">₹<%= subtotal || 0 %></span>
                        </div>
                        <% if (totalDiscount && totalDiscount > 0) { %>
                            <div class="summary-row discount-row">
                                <span class="price-label">
                                    <i class="bi bi-tag me-1"></i>Discount
                                </span>
                                <span class="price-value text-success">-₹<%= totalDiscount %></span>
                            </div>
                        <% } %>
                        <div class="summary-row">
                            <span class="price-label">
                                <i class="bi bi-truck me-1"></i>Shipping
                            </span>
                            <span class="price-value">
                                <% if (shipping && shipping > 0) { %>
                                    ₹<%= shipping %>
                                <% } else { %>
                                    <span class="text-success fw-bold">FREE</span>
                                <% } %>
                            </span>
                        </div>

                        <div class="price-divider"></div>

                        <div class="summary-row total">
                            <span class="price-label">Total</span>
                            <span class="price-value">₹<%= total || 0 %></span>
                        </div>
                    </div>

                    <!-- Place Order Button -->
                    <button class="btn-continue" onclick="proceedToPayment()">
                        <i class="bi bi-check-circle"></i> PLACE ORDER
                    </button>

                    <!-- ⬇ NEW: PayPal buttons appear here for UPI/PayPal -->
                    <div id="paypal-btn-container-main" class="mt-3 d-none"></div>

                    <!-- Back to Cart -->
                    <div class="text-center mt-3">
                        <a href="/cart" class="text-muted text-decoration-none">
                            <i class="bi bi-arrow-left"></i> Back to Cart
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">
          <i class="bi bi-plus me-2"></i> Add New Address
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%- include('partials/addresses') %>
      </div>
    </div>
  </div>
</div>

<!-- Geoapify Autocomplete Script -->
<script src="https://api.geoapify.com/v1/api.js?apiKey=<%= geoapifyApiKey %>"></script>

<!-- SweetAlert2 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




<script src="/js/user/checkout.js"></script>

<script>
// Pass server-side data to client-side JavaScript
window.geoapifyApiKey = '<%= geoapifyApiKey %>';
window.orderTotal = <%= total || 0 %>;
</script>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
/* ========= PayPal JS-SDK lazy loader ========= */
window.loadPayPalSdk = function () {
  if (window.paypal) return;                   // already on page
  const s = document.createElement('script');
  s.src = 'https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=USD&intent=capture&disable-funding=credit,card'; // ✅ CHANGED: Use USD and disable unwanted funding
  s.onload = () => console.log('PayPal SDK loaded');
  s.onerror = (error) => console.error('PayPal SDK failed to load:', error);
  document.head.appendChild(s);
};
</script>
